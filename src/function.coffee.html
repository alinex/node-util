<!DOCTYPE html>
<html>
<head>
  <title>function.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "src/function.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#helper-to-call-given-function-once">Helper to call given function once</a>
      </div>

      <div class="heading h2">
        <a href="#includes">Includes</a>
      </div>

      <div class="heading h2">
        <a href="#throw-an-error">Throw an error</a>
      </div>

      <div class="heading h2">
        <a href="#skip-execution">Skip execution</a>
      </div>

      <div class="heading h2">
        <a href="#only-once-atime">Only once atime</a>
      </div>

      <div class="heading h2">
        <a href="#wait-if-just-running">Wait if just running</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-util" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper-to-call-given-function-once">
  <h1>
    <a href="#helper-to-call-given-function-once" name="helper-to-call-given-function-once" class="pilcrow"></a>
Helper to call given function once
  </h1>
</div>
<p>This methods will wrap a given function. Afterwards it will only run once
also if called multiple times.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="includes">
  <h2>
    <a href="#includes" name="includes" class="pilcrow"></a>
Includes
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>node packages</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'util:function'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>internal helper</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>

functionId = <span class="hljs-number">0</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="throw-an-error">
  <h2>
    <a href="#throw-an-error" name="throw-an-error" class="pilcrow"></a>
Throw an error
  </h2>
</div>
<p>If it is called a second time an error will be thrown.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports.onceThrow = <span class="hljs-function"><span class="hljs-params">(context, func)</span> -&gt;</span>
  <span class="hljs-keyword">unless</span> func
    func = context
    context = <span class="hljs-literal">undefined</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>check parameters</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> func <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Argument func is not a function!"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>flags</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  called = <span class="hljs-literal">false</span>
  func.__id ?= ++functionId
  debug <span class="hljs-string">"throw #<span class="hljs-subst">#{func.__id}</span>: created for <span class="hljs-subst">#{chalk.grey func}</span>"</span>
  <span class="hljs-keyword">if</span> context
    debug <span class="hljs-string">"throw #<span class="hljs-subst">#{func.__id}</span>: using specific context"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>return throw function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  -&gt;</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>throw error after first call</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    debug <span class="hljs-string">"throw #<span class="hljs-subst">#{func.__id}</span>: called"</span>
    <span class="hljs-keyword">if</span> called
      debug <span class="hljs-string">"throw #<span class="hljs-subst">#{func.__id}</span>: called again issuing an error"</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"This function should only be called once."</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>run real function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    called = <span class="hljs-literal">true</span>
    func.apply context, arguments</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="skip-execution">
  <h2>
    <a href="#skip-execution" name="skip-execution" class="pilcrow"></a>
Skip execution
  </h2>
</div>
<p>If it is called a second time execution is skipped and an error will be returned.
You may use the error or not.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports.onceSkip = <span class="hljs-function"><span class="hljs-params">(context, func)</span> -&gt;</span>
  <span class="hljs-keyword">unless</span> func
    func = context
    context = <span class="hljs-literal">undefined</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>check parameters</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> func <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Argument func is not a function!"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>flags</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  called = <span class="hljs-literal">false</span>
  func.__id ?= ++functionId
  debug <span class="hljs-string">"skip #<span class="hljs-subst">#{func.__id}</span>: created for <span class="hljs-subst">#{chalk.grey func}</span>"</span>
  <span class="hljs-keyword">if</span> context
    debug <span class="hljs-string">"skip #<span class="hljs-subst">#{func.__id}</span>: using specific context"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>return skip function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  -&gt;</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>get callback parameter</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    cb = arguments[arguments.length<span class="hljs-number">-1</span>]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>throw error after first call</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> called
      debug <span class="hljs-string">"skip #<span class="hljs-subst">#{func.__id}</span>: skipped because already called"</span>
      err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"This function should only be called once."</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> cb <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      <span class="hljs-keyword">return</span> err
    debug <span class="hljs-string">"skip #<span class="hljs-subst">#{func.__id}</span>: called"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>run real function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    called = <span class="hljs-literal">true</span>
    func.apply context, arguments</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="only-once-atime">
  <h2>
    <a href="#only-once-atime" name="only-once-atime" class="pilcrow"></a>
Only once atime
  </h2>
</div>
<p>If it is called a second time it will return only after the first call
has finished. This makes only sense with asynchronous functions.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports.onceTime = <span class="hljs-function"><span class="hljs-params">(context, func)</span> -&gt;</span>
  <span class="hljs-keyword">unless</span> func
    func = context
    context = <span class="hljs-literal">undefined</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>check parameters</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> func <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Argument func is not a function!"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>flags</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  started = <span class="hljs-literal">false</span> <span class="hljs-comment"># if the function has already started</span>
  listeners = []  <span class="hljs-comment"># callbacks waiting</span>
  next = [] <span class="hljs-comment"># list for the next round</span>
  func.__id ?= ++functionId
  debug <span class="hljs-string">"time #<span class="hljs-subst">#{func.__id}</span>: created for <span class="hljs-subst">#{chalk.grey func}</span>"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> context <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> Object.keys(context).length
    debug <span class="hljs-string">"time #<span class="hljs-subst">#{func.__id}</span>: using specific context <span class="hljs-subst">#{chalk.grey util.inspect context}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>return time function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function">  <span class="hljs-title">nfunc</span> = -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>get callback parameter</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    args = [].slice.call arguments
    cb = args.pop() ? {}
    idargs = util.inspect(args[<span class="hljs-number">0.</span>.]).replace <span class="hljs-regexp">/\n\s*/g</span>, <span class="hljs-string">' '</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>add to listeners</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> started
      debug <span class="hljs-string">"time #<span class="hljs-subst">#{func.__id}</span>: <span class="hljs-subst">#{chalk.grey idargs}</span> called but waiting"</span>
      next.push [idargs, args, cb]
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">else</span>
      debug <span class="hljs-string">"time #<span class="hljs-subst">#{func.__id}</span>: <span class="hljs-subst">#{chalk.grey idargs}</span> called"</span>
      listeners.push cb
    started = <span class="hljs-literal">true</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>add the time callback</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    args.push -&gt;
      debug <span class="hljs-string">"time #<span class="hljs-subst">#{func.__id}</span>: <span class="hljs-subst">#{chalk.grey idargs}</span> done with result
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>{chalk.grey util.inspect arguments}&quot;
start sending back and reopening method</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      started = <span class="hljs-literal">false</span>
      work = [].slice.call listeners
      listeners = []</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>call all listeners</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">for</span> cb <span class="hljs-keyword">in</span> work
        debug <span class="hljs-string">"time #<span class="hljs-subst">#{func.__id}</span>: <span class="hljs-subst">#{chalk.grey idargs}</span> inform listener"</span>
        cb.apply context, arguments</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>rerun if more to do</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">if</span> next.length
        [id, args, cb] = next.shift()
        debug <span class="hljs-string">"time #<span class="hljs-subst">#{func.__id}</span>: <span class="hljs-subst">#{chalk.grey id}</span> restart"</span>
        args.push cb
        nfunc.apply <span class="hljs-keyword">this</span>, args</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<pre><code> if next.length
   waiting = []
   id = null
   args = null
   cb = null
   for entry in next
     if listeners.length == 0
       [id, args, cb] = entry
     else
       waiting.push entry
   next = waiting
   debug &quot;time ##{func.__id}: #{chalk.grey id} restart&quot;
   args.push cb
   func.apply context, args
</code></pre>
<p>run real function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    func.apply context, args
  nfunc</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="wait-if-just-running">
  <h2>
    <a href="#wait-if-just-running" name="wait-if-just-running" class="pilcrow"></a>
Wait if just running
  </h2>
</div>
<p>If it is called a second time it will return only after the first call
has finished. This makes only sense with asynchronous functions.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports.once = <span class="hljs-function"><span class="hljs-params">(context, func)</span> -&gt;</span>
  <span class="hljs-keyword">unless</span> func
    func = context
    context = <span class="hljs-literal">undefined</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>check parameters</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> func <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Argument func is not a function!"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>flags</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  started = <span class="hljs-literal">false</span> <span class="hljs-comment"># if the function has already started</span>
  done = <span class="hljs-literal">false</span>    <span class="hljs-comment"># if the function has already ended</span>
  listeners = []  <span class="hljs-comment"># callbacks waiting</span>
  results = []    <span class="hljs-comment"># the results stored for further calls</span>
  func.__id ?= ++functionId
  debug <span class="hljs-string">"wait #<span class="hljs-subst">#{func.__id}</span>: created for <span class="hljs-subst">#{chalk.grey func}</span>"</span>
  <span class="hljs-keyword">if</span> context
    debug <span class="hljs-string">"wait #<span class="hljs-subst">#{func.__id}</span>: using specific context"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>return wait function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  -&gt;</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>get callback parameter</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    args = [].slice.call arguments
    cb = args.pop() ? {}</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>return if already done</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> done
      debug <span class="hljs-string">"wait #<span class="hljs-subst">#{func.__id}</span>: called again -&gt; send result"</span>
      <span class="hljs-keyword">return</span> cb.apply context, results</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>add to listeners</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    listeners.push cb
    <span class="hljs-keyword">if</span> started
      debug <span class="hljs-string">"wait #<span class="hljs-subst">#{func.__id}</span>: called again while running"</span>
      <span class="hljs-keyword">return</span>
    debug <span class="hljs-string">"wait #<span class="hljs-subst">#{func.__id}</span>: called"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>add the wait callback</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    started = <span class="hljs-literal">true</span>
    args.push -&gt;
      debug <span class="hljs-string">"wait #<span class="hljs-subst">#{func.__id}</span>: done"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>store results</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      done = <span class="hljs-literal">true</span>
      results = [].slice.call arguments</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>call all listeners</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">for</span> cb <span class="hljs-keyword">in</span> listeners
        debug <span class="hljs-string">"wait #<span class="hljs-subst">#{func.__id}</span>: inform listener"</span>
        cb.apply context, results
      listeners = <span class="hljs-literal">null</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>run real function</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    func.apply context, args</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
