<!DOCTYPE html>
<html>
<head>
  <title>codemirror.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../", thisFile = "home/alex/github/node-util/report/metrics/assets/scripts/vendor/codemirror/codemirror.js", defaultSidebar = true;
  </script>
  <script src="../../../../../../doc-script.js"></script>
</head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io" onmouseover="lllogo.src='https://alinex.github.io/images/Alinex-200.png'" onmouseout="lllogo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="lllogo" src="https://alinex.github.io/images/Alinex-black-200.png" width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png" style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog" class="btn btn-primary"><span class="glyphicon-cog"></span> Blog</a>
  <a href="http://alinex.github.io/code.html" class="btn btn-warning"><span class="glyphicon-pencil"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-util" title="Fork me on GitHub"></a><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>codemirror.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<p>CodeMirror version 3.0</p>

<p>CodeMirror is the only global var we claim</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">CodeMirror</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>BROWSER SNIFFING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Crude, but necessary to handle a number of hard-to-feature-detect
bugs and behavior differences.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">gecko</span> <span class="o">=</span> <span class="sr">/gecko\/\d/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">ie</span> <span class="o">=</span> <span class="sr">/MSIE \d/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">ie_lt8</span> <span class="o">=</span> <span class="sr">/MSIE [1-7]\b/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">ie_lt9</span> <span class="o">=</span> <span class="sr">/MSIE [1-8]\b/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">webkit</span> <span class="o">=</span> <span class="sr">/WebKit\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">qtwebkit</span> <span class="o">=</span> <span class="nx">webkit</span> <span class="o">&amp;&amp;</span> <span class="sr">/Qt\/\d+\.\d+/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">chrome</span> <span class="o">=</span> <span class="sr">/Chrome\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">opera</span> <span class="o">=</span> <span class="sr">/Opera\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">safari</span> <span class="o">=</span> <span class="sr">/Apple Computer/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">vendor</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">khtml</span> <span class="o">=</span> <span class="sr">/KHTML\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">mac_geLion</span> <span class="o">=</span> <span class="sr">/Mac OS X 1\d\D([7-9]|\d\d)\D/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">mac_geMountainLion</span> <span class="o">=</span> <span class="sr">/Mac OS X 1\d\D([8-9]|\d\d)\D/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">phantom</span> <span class="o">=</span> <span class="sr">/PhantomJS/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">ios</span> <span class="o">=</span> <span class="sr">/AppleWebKit/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="sr">/Mobile\/\w+/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>This is woefully incomplete. Suggestions for alternative methods welcome.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">mobile</span> <span class="o">=</span> <span class="nx">ios</span> <span class="o">||</span> <span class="sr">/Android|webOS|BlackBerry|Opera Mini|IEMobile/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">mac</span> <span class="o">=</span> <span class="nx">ios</span> <span class="o">||</span> <span class="sr">/Mac/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Optimize some code when these features are not used</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">sawReadOnlySpans</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">sawCollapsedSpans</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>CONSTRUCTOR</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">CodeMirror</span><span class="p">(</span><span class="nx">place</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">CodeMirror</span><span class="p">))</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">CodeMirror</span><span class="p">(</span><span class="nx">place</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Determine effective options based on given values and defaults.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">opt</span> <span class="k">in</span> <span class="nx">defaults</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">opt</span><span class="p">))</span>
      <span class="nx">options</span><span class="p">[</span><span class="nx">opt</span><span class="p">]</span> <span class="o">=</span> <span class="nx">defaults</span><span class="p">[</span><span class="nx">opt</span><span class="p">];</span>
    <span class="nx">setGuttersForLineNumbers</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">makeDisplay</span><span class="p">(</span><span class="nx">place</span><span class="p">);</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">CodeMirror</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">updateGutters</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">autofocus</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mobile</span><span class="p">)</span> <span class="nx">focusInput</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="nx">makeView</span><span class="p">(</span><span class="k">new</span> <span class="nx">BranchChunk</span><span class="p">([</span><span class="k">new</span> <span class="nx">LeafChunk</span><span class="p">([</span><span class="nx">makeLine</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">textHeight</span><span class="p">(</span><span class="nx">display</span><span class="p">))])]));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">nextOpId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">loadMode</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="nx">themeChanged</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s2">&quot; CodeMirror-wrap&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Initialize the content.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Override magic textarea content restore that IE sometimes does
on our hidden textarea on reload</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ie</span><span class="p">)</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">bind</span><span class="p">(</span><span class="nx">resetInput</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="mi">20</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="nx">makeHistory</span><span class="p">();</span>

    <span class="nx">registerEventHandlers</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>IE throws unspecified error in certain cases, when
trying to access activeElement before onload</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">hasFocus</span><span class="p">;</span> <span class="k">try</span> <span class="p">{</span> <span class="nx">hasFocus</span> <span class="o">=</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">);</span> <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasFocus</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">autofocus</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mobile</span><span class="p">))</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">bind</span><span class="p">(</span><span class="nx">onFocus</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span> <span class="mi">20</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">onBlur</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="nx">operation</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">opt</span> <span class="k">in</span> <span class="nx">optionHandlers</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">optionHandlers</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span><span class="p">(</span><span class="nx">opt</span><span class="p">))</span>
          <span class="nx">optionHandlers</span><span class="p">[</span><span class="nx">opt</span><span class="p">](</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">[</span><span class="nx">opt</span><span class="p">],</span> <span class="nx">Init</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">initHooks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">initHooks</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="k">this</span><span class="p">);</span>
    <span class="p">})();</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>DISPLAY CONSTRUCTOR</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">makeDisplay</span><span class="p">(</span><span class="nx">place</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;textarea&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;position: absolute; padding: 0; width: 1px; height: 1em; outline: none;&quot;</span><span class="p">);</span>
    <span class="nx">input</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;wrap&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">);</span> <span class="nx">input</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;autocorrect&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">);</span> <span class="nx">input</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;autocapitalize&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Wraps and hides input textarea</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">inputDiv</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">input</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;overflow: hidden; position: relative; width: 3px; height: 0px;&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>The actual fake scrollbars.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;height: 1px&quot;</span><span class="p">)],</span> <span class="s2">&quot;CodeMirror-hscrollbar&quot;</span><span class="p">);</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;width: 1px&quot;</span><span class="p">)],</span> <span class="s2">&quot;CodeMirror-vscrollbar&quot;</span><span class="p">);</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarFiller</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;CodeMirror-scrollbar-filler&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>DIVs containing the selection and the actual code</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">lineDiv</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">selectionDiv</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;position: relative; z-index: 1&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Blinky cursor, and element used to ensure cursor fits at the end of a line</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">cursor</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;\u00a0&quot;</span><span class="p">,</span> <span class="s2">&quot;CodeMirror-cursor&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Secondary cursor, shown when on a 'jump' in bi-directional text</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">otherCursor</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;\u00a0&quot;</span><span class="p">,</span> <span class="s2">&quot;CodeMirror-cursor CodeMirror-secondarycursor&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Used to measure text size</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">measure</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;CodeMirror-measure&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>Wraps everything that needs to exist inside the vertically-padded coordinate system</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">lineSpace</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">measure</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">selectionDiv</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">cursor</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">],</span>
                         <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;position: relative; outline: none&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Moved around its parent to cover visible view</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">mover</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">lineSpace</span><span class="p">],</span> <span class="s2">&quot;CodeMirror-lines&quot;</span><span class="p">)],</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;position: relative&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>Set to the height of the text, causes scrolling</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">sizer</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">mover</span><span class="p">],</span> <span class="s2">&quot;CodeMirror-sizer&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>D is needed because behavior of elts with overflow: auto and padding is inconsistent across browsers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">heightForcer</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="s2">&quot;\u00a0&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;position: absolute; height: &quot;</span> <span class="o">+</span> <span class="nx">scrollerCutOff</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Will contain the gutters, if any</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">gutters</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;CodeMirror-gutters&quot;</span><span class="p">);</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">lineGutter</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Helper element to properly size the gutter backgrounds</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">scrollerInner</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">sizer</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">heightForcer</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">gutters</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;position: relative; min-height: 100%&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Provides scrolling</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">scrollerInner</span><span class="p">],</span> <span class="s2">&quot;CodeMirror-scroll&quot;</span><span class="p">);</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;tabIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>The element in which the editor lives.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">inputDiv</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">,</span>
                            <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarFiller</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">],</span> <span class="s2">&quot;CodeMirror&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Work around IE7 z-index bug</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ie_lt8</span><span class="p">)</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">paddingRight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">place</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">)</span> <span class="nx">place</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">);</span> <span class="k">else</span> <span class="nx">place</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>Needed to hide big blue blinking cursor on Mobile Safari</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ios</span><span class="p">)</span> <span class="nx">input</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">&quot;0px&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">webkit</span><span class="p">)</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>Needed to handle Tab key in KHTML</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">khtml</span><span class="p">)</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="s2">&quot;1px&quot;</span><span class="p">;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;absolute&quot;</span><span class="p">;</span> <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Need to set a minimum width to see the scrollbar on IE7 (but must not set it on IE8).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ie_lt8</span><span class="p">)</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">minWidth</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">minWidth</span> <span class="o">=</span> <span class="s2">&quot;18px&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Current visible range (may be bigger than the view window).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">viewOffset</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">showingTo</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lastSizeC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Used to only resize the line number gutter when necessary (when
the amount of lines crosses a boundary that makes its width change)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">lineNumWidth</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lineNumInnerWidth</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lineNumChars</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>See readInput and resetInput</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Set to true when a non-horizontal-scrolling widget is added. As
an optimization, widget aligning is skipped when d is false.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">alignWidgets</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Flag that indicates whether we currently expect input to appear
(after some event like 'keypress' or 'input') and are polling
intensively.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Self-resetting timeout for the poller</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">poll</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Delayed</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>True when a drag from the editor is active</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">draggingText</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nx">d</span><span class="p">.</span><span class="nx">cachedCharWidth</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">cachedTextHeight</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">measureLineCache</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">measureLineCachePos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Tracks when resetInput has punted to just putting a short
string instead of the (large) selection.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">inaccurateSelection</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Used to adjust overwrite behaviour when a paste has been
detected</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">d</span><span class="p">.</span><span class="nx">pasteIncoming</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>VIEW CONSTRUCTOR</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">makeView</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">selPos</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">doc</span><span class="o">:</span> <span class="nx">doc</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>frontier is the point up to which the content has been parsed,</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">frontier</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">highlight</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Delayed</span><span class="p">(),</span>
      <span class="nx">sel</span><span class="o">:</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">selPos</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">selPos</span><span class="p">,</span> <span class="nx">head</span><span class="o">:</span> <span class="nx">selPos</span><span class="p">,</span> <span class="nx">anchor</span><span class="o">:</span> <span class="nx">selPos</span><span class="p">,</span> <span class="nx">shift</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">extend</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span>
      <span class="nx">scrollTop</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">scrollLeft</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">overwrite</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">focused</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Tracks the maximum line length so that
the horizontal scrollbar can be kept
static when scrolling.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">maxLine</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="nx">maxLineLength</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">maxLineChanged</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">suppressEdits</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">goalColumn</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">cantEdit</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">keyMaps</span><span class="o">:</span> <span class="p">[]</span>
    <span class="p">};</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>STATE UPDATES</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Used to get the editor into a consistent state again when options change.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">loadMode</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">getMode</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">mode</span><span class="p">);</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">});</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">startWorker</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">wrappingChanged</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">th</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s2">&quot; CodeMirror-wrap&quot;</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">perLine</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">/</span> <span class="nx">charWidth</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">guess</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">perLine</span><span class="p">)</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">guess</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">guess</span> <span class="o">*</span> <span class="nx">th</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">minWidth</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot; CodeMirror-wrap&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="nx">computeMaxLength</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">);</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">th</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">regChange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
    <span class="nx">clearCaches</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">updateScrollbars</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">height</span><span class="p">);},</span> <span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">keyMapChanged</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">].</span><span class="nx">style</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s*cm-keymap-\S+/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
      <span class="p">(</span><span class="nx">style</span> <span class="o">?</span> <span class="s2">&quot; cm-keymap-&quot;</span> <span class="o">+</span> <span class="nx">style</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">themeChanged</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s*cm-s-\S+/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">theme</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^|\s)\s*/g</span><span class="p">,</span> <span class="s2">&quot; cm-s-&quot;</span><span class="p">);</span>
    <span class="nx">clearCaches</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">guttersChanged</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">updateGutters</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateGutters</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gutters</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">,</span> <span class="nx">specs</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">;</span>
    <span class="nx">removeChildren</span><span class="p">(</span><span class="nx">gutters</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">specs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">gutterClass</span> <span class="o">=</span> <span class="nx">specs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">gElt</span> <span class="o">=</span> <span class="nx">gutters</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;CodeMirror-gutter &quot;</span> <span class="o">+</span> <span class="nx">gutterClass</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gutterClass</span> <span class="o">==</span> <span class="s2">&quot;CodeMirror-linenumbers&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">lineGutter</span> <span class="o">=</span> <span class="nx">gElt</span><span class="p">;</span>
        <span class="nx">gElt</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">lineNumWidth</span> <span class="o">||</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">gutters</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lineLength</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">merged</span><span class="p">,</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">merged</span> <span class="o">=</span> <span class="nx">collapsedSpanAtStart</span><span class="p">(</span><span class="nx">cur</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
      <span class="nx">cur</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">found</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="nx">len</span> <span class="o">+=</span> <span class="nx">found</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="nx">found</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">cur</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">merged</span> <span class="o">=</span> <span class="nx">collapsedSpanAtEnd</span><span class="p">(</span><span class="nx">cur</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
      <span class="nx">len</span> <span class="o">-=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">found</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
      <span class="nx">cur</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">found</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="nx">len</span> <span class="o">+=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">found</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">len</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">computeMaxLength</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">maxLine</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineLength</span> <span class="o">=</span> <span class="nx">lineLength</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">maxLine</span><span class="p">);</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">lineLength</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineLength</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineLength</span> <span class="o">=</span> <span class="nx">len</span><span class="p">;</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">maxLine</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Make sure the gutters options contains the element
"CodeMirror-linenumbers" when the lineNumbers option is true.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">setGuttersForLineNumbers</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CodeMirror-linenumbers&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span><span class="p">)</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">else</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span><span class="p">)</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;CodeMirror-linenumbers&quot;</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>SCROLLBARS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>Re-synchronize the fake scrollbars with the actual size of the
content. Optionally force a scrollTop.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">updateScrollbars</span><span class="p">(</span><span class="nx">d</span> <span class="cm">/* display */</span><span class="p">,</span> <span class="nx">docHeight</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">totalHeight</span> <span class="o">=</span> <span class="nx">docHeight</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">paddingTop</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">minHeight</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">heightForcer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">totalHeight</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">scrollHeight</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">totalHeight</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollHeight</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">needsH</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollWidth</span> <span class="o">&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">needsV</span> <span class="o">=</span> <span class="nx">scrollHeight</span> <span class="o">&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">needsV</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;block&quot;</span><span class="p">;</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">=</span> <span class="nx">needsH</span> <span class="o">?</span> <span class="nx">scrollbarWidth</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">measure</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span> <span class="o">:</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> 
        <span class="p">(</span><span class="nx">scrollHeight</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">needsH</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;block&quot;</span><span class="p">;</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="nx">needsV</span> <span class="o">?</span> <span class="nx">scrollbarWidth</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">measure</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span> <span class="o">:</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span>
        <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollWidth</span> <span class="o">-</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">needsH</span> <span class="o">&amp;&amp;</span> <span class="nx">needsV</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarFiller</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;block&quot;</span><span class="p">;</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarFiller</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarFiller</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">scrollbarWidth</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">measure</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarFiller</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">mac_geLion</span> <span class="o">&amp;&amp;</span> <span class="nx">scrollbarWidth</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">measure</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">minWidth</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">minHeight</span> <span class="o">=</span> <span class="nx">mac_geMountainLion</span> <span class="o">?</span> <span class="s2">&quot;18px&quot;</span> <span class="o">:</span> <span class="s2">&quot;12px&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">visibleLines</span><span class="p">(</span><span class="nx">display</span><span class="p">,</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">viewPort</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">,</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">viewPort</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">viewPort</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">viewPort</span><span class="p">)</span> <span class="p">{</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">viewPort</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">viewPort</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">viewPort</span><span class="p">.</span><span class="nx">top</span><span class="p">;}</span>
    <span class="nx">top</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">paddingTop</span><span class="p">(</span><span class="nx">display</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">bottom</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">height</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">top</span><span class="p">),</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">)};</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>LINE NUMBERS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">alignHorizontally</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">display</span><span class="p">.</span><span class="nx">alignWidgets</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">comp</span> <span class="o">=</span> <span class="nx">compensateForHScroll</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span> <span class="o">-</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">+</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gutterW</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">comp</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">alignable</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">alignable</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">(</span><span class="nx">comp</span> <span class="o">+</span> <span class="nx">gutterW</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">maybeUpdateLineNumberWidth</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">lineNumberFor</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineNumChars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">measure</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="nx">last</span><span class="p">)],</span>
                                                 <span class="s2">&quot;CodeMirror-linenumber CodeMirror-gutter-elt&quot;</span><span class="p">));</span>
      <span class="kd">var</span> <span class="nx">innerW</span> <span class="o">=</span> <span class="nx">test</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span> <span class="nx">padding</span> <span class="o">=</span> <span class="nx">test</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">-</span> <span class="nx">innerW</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">lineGutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">lineNumInnerWidth</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">innerW</span><span class="p">,</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineGutter</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">);</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">lineNumWidth</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineNumInnerWidth</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">lineNumChars</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineNumInnerWidth</span> <span class="o">?</span> <span class="nx">last</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">lineGutter</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineNumWidth</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lineNumberFor</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumberFormatter</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">firstLineNumber</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">compensateForHScroll</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">().</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">().</span><span class="nx">left</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>DISPLAY DRAWING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">changes</span><span class="p">,</span> <span class="nx">viewPort</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">oldFrom</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span><span class="p">,</span> <span class="nx">oldTo</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">updated</span> <span class="o">=</span> <span class="nx">updateDisplayInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">changes</span><span class="p">,</span> <span class="nx">viewPort</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">signalLater</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">!=</span> <span class="nx">oldFrom</span> <span class="o">||</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span> <span class="o">!=</span> <span class="nx">oldTo</span><span class="p">)</span>
        <span class="nx">signalLater</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;viewportChange&quot;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">updateSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">updateScrollbars</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">updated</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>Uses a set of changes plus the current scroll position to
determine which DOM updates have to be made, and makes the
updates.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">updateDisplayInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">changes</span><span class="p">,</span> <span class="nx">viewPort</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Compute the new visible window
If scrollTop is specified, use that to determine which lines
to render instead of the current scrollbar position.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">visible</span> <span class="o">=</span> <span class="nx">visibleLines</span><span class="p">(</span><span class="nx">display</span><span class="p">,</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">viewPort</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Bail out if the visible area is already rendered and nothing changed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span> <span class="o">!==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="nx">visible</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">&amp;&amp;</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span> <span class="o">&amp;&amp;</span> <span class="nx">maybeUpdateLineNumberWidth</span><span class="p">(</span><span class="nx">cm</span><span class="p">))</span>
      <span class="nx">changes</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">marginLeft</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>When merged lines are present, the line that needs to be
redrawn might not be the one that was changed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span> <span class="o">!==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">sawCollapsedSpans</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">changes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">merged</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">merged</span> <span class="o">=</span> <span class="nx">collapsedSpanAtStart</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">from</span><span class="p">)))</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span><span class="p">.</span><span class="nx">diff</span><span class="p">)</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">diff</span> <span class="o">-=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">from</span> <span class="o">-</span> <span class="nx">from</span><span class="p">;</span>
          <span class="nx">ch</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>Used to determine which lines need their line numbers updated</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">positionsChangedFrom</span> <span class="o">=</span> <span class="nx">changes</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="kc">Infinity</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span> <span class="o">&amp;&amp;</span> <span class="nx">changes</span> <span class="o">&amp;&amp;</span> <span class="nx">changes</span> <span class="o">!==</span> <span class="kc">true</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">diff</span><span class="p">)</span> <span class="p">{</span> <span class="nx">positionsChangedFrom</span> <span class="o">=</span> <span class="nx">changes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">from</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">visible</span><span class="p">.</span><span class="nx">from</span> <span class="o">-</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">viewportMargin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">viewportMargin</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">&lt;</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="nx">from</span> <span class="o">-</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span> <span class="o">&gt;</span> <span class="nx">to</span> <span class="o">&amp;&amp;</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span> <span class="o">-</span> <span class="nx">to</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="nx">to</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sawCollapsedSpans</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">visualLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">)));</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">to</span> <span class="o">&lt;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">&amp;&amp;</span> <span class="nx">lineIsHidden</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">to</span><span class="p">)))</span> <span class="o">++</span><span class="nx">to</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>Create a range of theoretically intact lines, and punch holes
in that using the change info.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">intact</span> <span class="o">=</span> <span class="nx">changes</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span>
      <span class="nx">computeIntact</span><span class="p">([{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">}],</span> <span class="nx">changes</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Clip off the parts that won't be visible</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">intactLines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">from</span><span class="p">)</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">to</span><span class="p">)</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">intactLines</span> <span class="o">+=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">intactLines</span> <span class="o">==</span> <span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="nx">from</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="nx">intact</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">from</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">from</span><span class="p">;});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">intactLines</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">7</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
    <span class="nx">patchDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">intact</span><span class="p">,</span> <span class="nx">positionsChangedFrom</span><span class="p">);</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">different</span> <span class="o">=</span> <span class="nx">from</span> <span class="o">!=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">||</span> <span class="nx">to</span> <span class="o">!=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span> <span class="o">||</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">lastSizeC</span> <span class="o">!=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>This is just a bogus formula that detects when the editor is
resized or the font size changes.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">different</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lastSizeC</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span> <span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
    <span class="nx">startWorker</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">prevBottom</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">height</span><span class="p">;</span> <span class="nx">node</span><span class="p">;</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">lineObj</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ie_lt8</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="nx">bot</span> <span class="o">-</span> <span class="nx">prevBottom</span><span class="p">;</span>
        <span class="nx">prevBottom</span> <span class="o">=</span> <span class="nx">bot</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">box</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="nx">box</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">box</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">lineObj</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">height</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">height</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">(</span><span class="nx">display</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">diff</span> <span class="o">&gt;</span> <span class="p">.</span><span class="mi">001</span> <span class="o">||</span> <span class="nx">diff</span> <span class="o">&lt;</span> <span class="o">-</span><span class="p">.</span><span class="mi">001</span><span class="p">)</span>
        <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">lineObj</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span> <span class="o">=</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Position the mover div to align with the current virtual scroll position</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">display</span><span class="p">.</span><span class="nx">mover</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">computeIntact</span><span class="p">(</span><span class="nx">intact</span><span class="p">,</span> <span class="nx">changes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">change</span> <span class="o">=</span> <span class="nx">changes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">intact2</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">change</span><span class="p">.</span><span class="nx">diff</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l2</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">l2</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="nx">change</span><span class="p">.</span><span class="nx">diff</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">intact2</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span> <span class="o">||</span> <span class="nx">change</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">intact2</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">range</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
            <span class="nx">intact2</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">from</span><span class="p">});</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">&lt;</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span>
            <span class="nx">intact2</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">range</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">diff</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">intact</span> <span class="o">=</span> <span class="nx">intact2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">intact</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getDimensions</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">left</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">width</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">,</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">left</span><span class="p">[</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;</span>
      <span class="nx">width</span><span class="p">[</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">fixedPos</span><span class="o">:</span> <span class="nx">compensateForHScroll</span><span class="p">(</span><span class="nx">d</span><span class="p">),</span>
            <span class="nx">gutterTotalWidth</span><span class="o">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span>
            <span class="nx">gutterLeft</span><span class="o">:</span> <span class="nx">left</span><span class="p">,</span>
            <span class="nx">gutterWidth</span><span class="o">:</span> <span class="nx">width</span><span class="p">,</span>
            <span class="nx">wrapperWidth</span><span class="o">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">patchDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">intact</span><span class="p">,</span> <span class="nx">updateNumbersFrom</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dims</span> <span class="o">=</span> <span class="nx">getDimensions</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">lineNumbers</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>IE does bad things to nodes when .innerHTML = "" is used on a parent
we still need widgets and markers intact to add back to the new content later</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">intact</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">ie</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">webkit</span> <span class="o">||</span> <span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">currentWheelTarget</span><span class="p">))</span>
      <span class="nx">removeChildren</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">,</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">rm</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">webkit</span> <span class="o">&amp;&amp;</span> <span class="nx">mac</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">currentWheelTarget</span> <span class="o">==</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">lineObj</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">container</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">nextIntact</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">lineNo</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">nextIntact</span> <span class="o">&amp;&amp;</span> <span class="nx">nextIntact</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="nx">lineNo</span><span class="p">)</span> <span class="nx">nextIntact</span> <span class="o">=</span> <span class="nx">intact</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lineIsHidden</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">nextIntact</span> <span class="o">&amp;&amp;</span> <span class="nx">nextIntact</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">lineNo</span> <span class="o">&amp;&amp;</span> <span class="nx">nextIntact</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">lineNo</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>This line is intact. Skip to the actual node. Update its
line number if needed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">while</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">lineObj</span> <span class="o">!=</span> <span class="nx">line</span><span class="p">)</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">rm</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">lineNumbers</span> <span class="o">&amp;&amp;</span> <span class="nx">updateNumbersFrom</span> <span class="o">&lt;=</span> <span class="nx">lineNo</span> <span class="o">&amp;&amp;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">lineNumber</span><span class="p">)</span>
          <span class="nx">setTextContent</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">lineNumber</span><span class="p">,</span> <span class="nx">lineNumberFor</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">));</span>
        <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>This line needs to be generated.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">lineNode</span> <span class="o">=</span> <span class="nx">buildLineElement</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">dims</span><span class="p">);</span>
        <span class="nx">container</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">lineNode</span><span class="p">,</span> <span class="nx">cur</span><span class="p">);</span>
        <span class="nx">lineNode</span><span class="p">.</span><span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="o">++</span><span class="nx">lineNo</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">cur</span><span class="p">)</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">rm</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">buildLineElement</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">dims</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lineElement</span> <span class="o">=</span> <span class="nx">lineContent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">markers</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span><span class="p">,</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">markers</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">bgClass</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">wrapClass</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">widgets</span> <span class="o">||</span> <span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="k">return</span> <span class="nx">lineElement</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Lines with gutter elements or a background class need
to be wrapped again, and have the extra elements added
to the wrapper div</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="kd">var</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">wrapClass</span><span class="p">,</span> <span class="s2">&quot;position: relative&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span> <span class="o">||</span> <span class="nx">markers</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">gutterWrap</span> <span class="o">=</span> <span class="nx">wrap</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;position: absolute; left: &quot;</span> <span class="o">+</span>
                                            <span class="nx">dims</span><span class="p">.</span><span class="nx">fixedPos</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">));</span>
      <span class="nx">wrap</span><span class="p">.</span><span class="nx">alignable</span> <span class="o">=</span> <span class="p">[</span><span class="nx">gutterWrap</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">markers</span> <span class="o">||</span> <span class="o">!</span><span class="nx">markers</span><span class="p">[</span><span class="s2">&quot;CodeMirror-linenumbers&quot;</span><span class="p">]))</span>
        <span class="nx">wrap</span><span class="p">.</span><span class="nx">lineNumber</span> <span class="o">=</span> <span class="nx">gutterWrap</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span>
          <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="nx">lineNumberFor</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">),</span>
              <span class="s2">&quot;CodeMirror-linenumber CodeMirror-gutter-elt&quot;</span><span class="p">,</span>
              <span class="s2">&quot;left: &quot;</span> <span class="o">+</span> <span class="nx">dims</span><span class="p">.</span><span class="nx">gutterLeft</span><span class="p">[</span><span class="s2">&quot;CodeMirror-linenumbers&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;px; width: &quot;</span>
              <span class="o">+</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineNumInnerWidth</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">markers</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">[</span><span class="nx">k</span><span class="p">],</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">markers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">markers</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">found</span><span class="p">)</span>
            <span class="nx">gutterWrap</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">found</span><span class="p">],</span> <span class="s2">&quot;CodeMirror-gutter-elt&quot;</span><span class="p">,</span> <span class="s2">&quot;left: &quot;</span> <span class="o">+</span>
                                       <span class="nx">dims</span><span class="p">.</span><span class="nx">gutterLeft</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;px; width: &quot;</span> <span class="o">+</span> <span class="nx">dims</span><span class="p">.</span><span class="nx">gutterWidth</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Kludge to make sure the styled element lies behind the selection (by z-index)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">bgClass</span><span class="p">)</span>
      <span class="nx">wrap</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="s2">&quot;\u00a0&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">bgClass</span> <span class="o">+</span> <span class="s2">&quot; CodeMirror-linebackground&quot;</span><span class="p">));</span>
    <span class="nx">wrap</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">lineElement</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">widgets</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ws</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">widgets</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">widget</span> <span class="o">=</span> <span class="nx">ws</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">widget</span><span class="p">.</span><span class="nx">node</span><span class="p">],</span> <span class="s2">&quot;CodeMirror-linewidget&quot;</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="nx">widget</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">noHScroll</span><span class="p">)</span> <span class="p">{</span>
          <span class="p">(</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">alignable</span> <span class="o">||</span> <span class="p">(</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">alignable</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">dims</span><span class="p">.</span><span class="nx">wrapperWidth</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">dims</span><span class="p">.</span><span class="nx">fixedPos</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">widget</span><span class="p">.</span><span class="nx">coverGutter</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">width</span> <span class="o">-=</span> <span class="nx">dims</span><span class="p">.</span><span class="nx">gutterTotalWidth</span><span class="p">;</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">paddingLeft</span> <span class="o">=</span> <span class="nx">dims</span><span class="p">.</span><span class="nx">gutterTotalWidth</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">coverGutter</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;relative&quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">widget</span><span class="p">.</span><span class="nx">noHScroll</span><span class="p">)</span> <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">marginLeft</span> <span class="o">=</span> <span class="o">-</span><span class="nx">dims</span><span class="p">.</span><span class="nx">gutterTotalWidth</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">above</span><span class="p">)</span>
          <span class="nx">wrap</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineNumbers</span> <span class="o">&amp;&amp;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">gutterWrap</span> <span class="o">:</span> <span class="nx">lineElement</span><span class="p">);</span>
        <span class="k">else</span>
          <span class="nx">wrap</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ie_lt8</span><span class="p">)</span> <span class="nx">wrap</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">wrap</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>SELECTION / CURSOR</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">updateSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">collapsed</span> <span class="o">=</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">collapsed</span> <span class="o">||</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">showCursorWhenSelecting</span><span class="p">)</span>
      <span class="nx">updateSelectionCursor</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">collapsed</span><span class="p">)</span>
      <span class="nx">updateSelectionRange</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">selectionDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>Move the hidden textarea near the cursor to prevent scrolling artifacts</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">headPos</span> <span class="o">=</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">,</span> <span class="s2">&quot;div&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">wrapOff</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">(),</span> <span class="nx">lineOff</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                                                      <span class="nx">headPos</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">lineOff</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">wrapOff</span><span class="p">.</span><span class="nx">top</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                                                       <span class="nx">headPos</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">lineOff</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">wrapOff</span><span class="p">.</span><span class="nx">left</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>No selection, plain cursor</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">updateSelectionCursor</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">,</span> <span class="s2">&quot;div&quot;</span><span class="p">);</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">*</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">cursorHeight</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">other</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">other</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">other</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">other</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">85</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">display</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Highlight selection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">updateSelectionRange</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">sel</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">fragment</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">clientWidth</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineSpace</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span> <span class="nx">pl</span> <span class="o">=</span> <span class="nx">paddingLeft</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">top</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">fragment</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;CodeMirror-selected&quot;</span><span class="p">,</span> <span class="s2">&quot;position: absolute; left: &quot;</span> <span class="o">+</span> <span class="nx">left</span> <span class="o">+</span>
                               <span class="s2">&quot;px; top: &quot;</span> <span class="o">+</span> <span class="nx">top</span> <span class="o">+</span> <span class="s2">&quot;px; width: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">width</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">clientWidth</span> <span class="o">-</span> <span class="nx">left</span> <span class="o">:</span> <span class="nx">width</span><span class="p">)</span> <span class="o">+</span>
                               <span class="s2">&quot;px; height: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">top</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">drawForLine</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">fromArg</span><span class="p">,</span> <span class="nx">toArg</span><span class="p">,</span> <span class="nx">retTop</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">lineLen</span> <span class="o">=</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">rVal</span> <span class="o">=</span> <span class="nx">retTop</span> <span class="o">?</span> <span class="kc">Infinity</span> <span class="o">:</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">coords</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">charCoords</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">},</span> <span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">iterateBidiSections</span><span class="p">(</span><span class="nx">getOrder</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">),</span> <span class="nx">fromArg</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">toArg</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">lineLen</span> <span class="o">:</span> <span class="nx">toArg</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">leftPos</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">(</span><span class="nx">dir</span> <span class="o">==</span> <span class="s2">&quot;rtl&quot;</span> <span class="o">?</span> <span class="nx">to</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">from</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">rightPos</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">(</span><span class="nx">dir</span> <span class="o">==</span> <span class="s2">&quot;rtl&quot;</span> <span class="o">?</span> <span class="nx">from</span> <span class="o">:</span> <span class="nx">to</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">leftPos</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">rightPos</span><span class="p">.</span><span class="nx">right</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rightPos</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">leftPos</span><span class="p">.</span><span class="nx">top</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Different lines, draw top part</span>
          <span class="nx">add</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">leftPos</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">leftPos</span><span class="p">.</span><span class="nx">bottom</span><span class="p">);</span>
          <span class="nx">left</span> <span class="o">=</span> <span class="nx">pl</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">leftPos</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">&lt;</span> <span class="nx">rightPos</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="nx">add</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">leftPos</span><span class="p">.</span><span class="nx">bottom</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">rightPos</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">toArg</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span> <span class="o">==</span> <span class="nx">lineLen</span><span class="p">)</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">clientWidth</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fromArg</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">from</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">pl</span><span class="p">;</span>
        <span class="nx">rVal</span> <span class="o">=</span> <span class="nx">retTop</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">rightPos</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">rVal</span><span class="p">)</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">rightPos</span><span class="p">.</span><span class="nx">bottom</span><span class="p">,</span> <span class="nx">rVal</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">left</span> <span class="o">&lt;</span> <span class="nx">pl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">pl</span><span class="p">;</span>
        <span class="nx">add</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">rightPos</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">right</span> <span class="o">-</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">rightPos</span><span class="p">.</span><span class="nx">bottom</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">rVal</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">drawForLine</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">fromObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">fromObj</span><span class="p">,</span> <span class="nx">merged</span><span class="p">,</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">],</span> <span class="nx">singleLine</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">merged</span> <span class="o">=</span> <span class="nx">collapsedSpanAtEnd</span><span class="p">(</span><span class="nx">cur</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
        <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">found</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">found</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">found</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
          <span class="nx">singleLine</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">cur</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">found</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>This is a single, merged line</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">singleLine</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span>
          <span class="nx">drawForLine</span><span class="p">(</span><span class="nx">path</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">path</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nx">path</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">middleTop</span><span class="p">,</span> <span class="nx">middleBot</span><span class="p">,</span> <span class="nx">toObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Draw the first line of selection.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">middleTop</span> <span class="o">=</span> <span class="nx">drawForLine</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="k">else</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Simply include it in the middle block.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">middleTop</span> <span class="o">=</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">fromObj</span><span class="p">)</span> <span class="o">-</span> <span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span>
          <span class="nx">middleBot</span> <span class="o">=</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">toObj</span><span class="p">)</span> <span class="o">-</span> <span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span><span class="p">;</span>
        <span class="k">else</span>
          <span class="nx">middleBot</span> <span class="o">=</span> <span class="nx">drawForLine</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">collapsedSpanAtStart</span><span class="p">(</span><span class="nx">toObj</span><span class="p">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">middleTop</span> <span class="o">&lt;</span> <span class="nx">middleBot</span><span class="p">)</span> <span class="nx">add</span><span class="p">(</span><span class="nx">pl</span><span class="p">,</span> <span class="nx">middleTop</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">middleBot</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">removeChildrenAndAdd</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">selectionDiv</span><span class="p">,</span> <span class="nx">fragment</span><span class="p">);</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">selectionDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>Cursor-blinking</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">restartBlink</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">blinker</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">on</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">blinker</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">otherCursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="p">(</span><span class="nx">on</span> <span class="o">=</span> <span class="o">!</span><span class="nx">on</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;hidden&quot;</span><span class="p">;</span>
    <span class="p">},</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">cursorBlinkRate</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>HIGHLIGHT WORKER</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">startWorker</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span> <span class="o">&lt;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">)</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">highlight</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">highlightWorker</span><span class="p">,</span> <span class="nx">cm</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">highlightWorker</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span> <span class="o">&gt;=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span> <span class="o">+</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">workTime</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">prevChange</span><span class="p">;</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span> <span class="o">+</span> <span class="mi">500</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span> <span class="o">&gt;=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Visible</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">highlightLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span> <span class="o">&gt;=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">prevChange</span> <span class="o">&amp;&amp;</span> <span class="nx">prevChange</span><span class="p">.</span><span class="nx">end</span> <span class="o">==</span> <span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span><span class="p">)</span> <span class="nx">prevChange</span><span class="p">.</span><span class="nx">end</span><span class="o">++</span><span class="p">;</span>
          <span class="k">else</span> <span class="nx">changed</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">prevChange</span> <span class="o">=</span> <span class="p">{</span><span class="nx">start</span><span class="o">:</span> <span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span><span class="p">,</span> <span class="nx">end</span><span class="o">:</span> <span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">processLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="o">++</span><span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span> <span class="o">&gt;</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">startWorker</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">workDelay</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">changed</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">changed</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
          <span class="nx">regChange</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">changed</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">start</span><span class="p">,</span> <span class="nx">changed</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">end</span><span class="p">);</span>
      <span class="p">})();</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<p>Finds the line to start with when starting a parse. Tries to
find a line with a stateAfter, so that it can start with a
valid state. If that fails, it returns the line with the
smallest indentation, which tends to need the least context to
parse correctly.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">findStartLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">minindent</span><span class="p">,</span> <span class="nx">minline</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">search</span> <span class="o">=</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">lim</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">search</span> <span class="o">&gt;</span> <span class="nx">lim</span><span class="p">;</span> <span class="o">--</span><span class="nx">search</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">search</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">search</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span><span class="p">)</span> <span class="k">return</span> <span class="nx">search</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">indented</span> <span class="o">=</span> <span class="nx">countColumn</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">minline</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">minindent</span> <span class="o">&gt;</span> <span class="nx">indented</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">minline</span> <span class="o">=</span> <span class="nx">search</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">minindent</span> <span class="o">=</span> <span class="nx">indented</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">minline</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">findStartLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">n</span><span class="p">),</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">&amp;&amp;</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">stateAfter</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="p">)</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">startState</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">processLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">save</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">==</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">pos</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pos</span> <span class="o">&gt;=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">showingFrom</span> <span class="o">&amp;&amp;</span> <span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">;</span>
      <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="nx">save</span> <span class="o">?</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
      <span class="o">++</span><span class="nx">pos</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>POSITION MEASUREMENT</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  
  <span class="kd">function</span> <span class="nx">paddingTop</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineSpace</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;}</span>
  <span class="kd">function</span> <span class="nx">paddingLeft</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">removeChildrenAndAdd</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">measure</span><span class="p">,</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">)).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">measureChar</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">||</span> <span class="nx">measureLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">),</span> <span class="nx">dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">ch</span><span class="p">;;</span> <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">pos</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">left</span><span class="o">:</span> <span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">ch</span> <span class="o">?</span> <span class="nx">r</span><span class="p">.</span><span class="nx">right</span> <span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span>
            <span class="nx">right</span><span class="o">:</span> <span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">ch</span> <span class="o">?</span> <span class="nx">r</span><span class="p">.</span><span class="nx">left</span> <span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">right</span><span class="p">,</span>
            <span class="nx">top</span><span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">bottom</span><span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">bottom</span><span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">measureLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>First look in the cache</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">measureLineCache</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">memo</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">memo</span><span class="p">.</span><span class="nx">text</span> <span class="o">==</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span> <span class="o">&amp;&amp;</span> <span class="nx">memo</span><span class="p">.</span><span class="nx">markedSpans</span> <span class="o">==</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span> <span class="o">&amp;&amp;</span>
          <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">==</span> <span class="nx">memo</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">memo</span><span class="p">.</span><span class="nx">measure</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kd">var</span> <span class="nx">measure</span> <span class="o">=</span> <span class="nx">measureLineInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>Store result in the cache</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">memo</span> <span class="o">=</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">,</span>
                <span class="nx">markedSpans</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">,</span> <span class="nx">measure</span><span class="o">:</span> <span class="nx">measure</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="nx">cache</span><span class="p">[</span><span class="o">++</span><span class="nx">display</span><span class="p">.</span><span class="nx">measureLineCachePos</span> <span class="o">%</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="nx">memo</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">memo</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">measure</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">measureLineInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">measure</span> <span class="o">=</span> <span class="nx">emptyArray</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pre</span> <span class="o">=</span> <span class="nx">lineContent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">measure</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>IE does not cache element positions of inline elements between
calls to getBoundingClientRect. This makes the loop below,
which gathers the positions of all the characters on the line,
do an amount of layout work quadratic to the number of
characters. When line wrapping is off, we try to improve things
by first subdividing the line into a bunch of inline blocks, so
that IE can reuse most of the layout information from caches
for those blocks. This does interfere with line wrapping, so it
doesn't work when wrapping is on, but in that case the
situation is slightly better, since IE does cache line-wrapping
information and only recomputes per-line.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ie</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">ie_lt8</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span> <span class="o">&amp;&amp;</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">fragment</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">n</span> <span class="o">/</span> <span class="nx">chunk</span><span class="p">);</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">chunks</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;display: inline-block&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">chunk</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">wrap</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">pre</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
          <span class="o">--</span><span class="nx">n</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">fragment</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">wrap</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">pre</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">fragment</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">removeChildrenAndAdd</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">measure</span><span class="p">,</span> <span class="nx">pre</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">outer</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">vranges</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">emptyArray</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span> <span class="nx">maxBot</span> <span class="o">=</span> <span class="nx">pre</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cur</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">measure</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">=</span> <span class="nx">measure</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">size</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">outer</span><span class="p">.</span><span class="nx">top</span><span class="p">),</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">size</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">outer</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">maxBot</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">vranges</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">rtop</span> <span class="o">=</span> <span class="nx">vranges</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">rbot</span> <span class="o">=</span> <span class="nx">vranges</span><span class="p">[</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rtop</span> <span class="o">&gt;</span> <span class="nx">bot</span> <span class="o">||</span> <span class="nx">rbot</span> <span class="o">&lt;</span> <span class="nx">top</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rtop</span> <span class="o">&lt;=</span> <span class="nx">top</span> <span class="o">&amp;&amp;</span> <span class="nx">rbot</span> <span class="o">&gt;=</span> <span class="nx">bot</span> <span class="o">||</span>
            <span class="nx">top</span> <span class="o">&lt;=</span> <span class="nx">rtop</span> <span class="o">&amp;&amp;</span> <span class="nx">bot</span> <span class="o">&gt;=</span> <span class="nx">rbot</span> <span class="o">||</span>
            <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">rbot</span><span class="p">)</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">top</span><span class="p">,</span> <span class="nx">rtop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nx">bot</span> <span class="o">-</span> <span class="nx">top</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">vranges</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">top</span><span class="p">,</span> <span class="nx">rtop</span><span class="p">);</span>
          <span class="nx">vranges</span><span class="p">[</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">rbot</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">==</span> <span class="nx">vranges</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">vranges</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">top</span><span class="p">,</span> <span class="nx">bot</span><span class="p">);</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">left</span><span class="o">:</span> <span class="nx">size</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">outer</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="o">:</span> <span class="nx">size</span><span class="p">.</span><span class="nx">right</span> <span class="o">-</span> <span class="nx">outer</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">j</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cur</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">vr</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
      <span class="nx">cur</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">vranges</span><span class="p">[</span><span class="nx">vr</span><span class="p">];</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">=</span> <span class="nx">vranges</span><span class="p">[</span><span class="nx">vr</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">clearCaches</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">measureLineCache</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">measureLineCachePos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">cachedCharWidth</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">cachedTextHeight</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">maxLineChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>Context is one of "line", "div" (display.lineDiv), "local"/null (editor), or "page"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">intoCoordSystem</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">rect</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lineObj</span><span class="p">.</span><span class="nx">widgets</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">lineObj</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">above</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
      <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span> <span class="o">+=</span> <span class="nx">size</span><span class="p">;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">+=</span> <span class="nx">size</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">rect</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">)</span> <span class="nx">context</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">yOff</span> <span class="o">=</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span> <span class="o">!=</span> <span class="s2">&quot;local&quot;</span><span class="p">)</span> <span class="nx">yOff</span> <span class="o">-=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span> <span class="o">==</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lOff</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">lineSpace</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
      <span class="nx">yOff</span> <span class="o">+=</span> <span class="nx">lOff</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">pageYOffset</span> <span class="o">||</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">xOff</span> <span class="o">=</span> <span class="nx">lOff</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">pageXOffset</span> <span class="o">||</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">scrollLeft</span><span class="p">);</span>
      <span class="nx">rect</span><span class="p">.</span><span class="nx">left</span> <span class="o">+=</span> <span class="nx">xOff</span><span class="p">;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">right</span> <span class="o">+=</span> <span class="nx">xOff</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span> <span class="o">+=</span> <span class="nx">yOff</span><span class="p">;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">+=</span> <span class="nx">yOff</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">rect</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">charCoords</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lineObj</span><span class="p">)</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">intoCoordSystem</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">measureChar</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">),</span> <span class="nx">context</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">measurement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">lineObj</span> <span class="o">||</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">measurement</span><span class="p">)</span> <span class="nx">measurement</span> <span class="o">=</span> <span class="nx">measureLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">get</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">measureChar</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">measurement</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">right</span><span class="p">)</span> <span class="nx">m</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">right</span><span class="p">;</span> <span class="k">else</span> <span class="nx">m</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">intoCoordSystem</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">),</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">order</span><span class="p">)</span> <span class="k">return</span> <span class="nx">get</span><span class="p">(</span><span class="nx">ch</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">main</span><span class="p">,</span> <span class="nx">other</span><span class="p">,</span> <span class="nx">linedir</span> <span class="o">=</span> <span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">level</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">part</span> <span class="o">=</span> <span class="nx">order</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">rtl</span> <span class="o">=</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">nb</span><span class="p">,</span> <span class="nx">here</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">ch</span> <span class="o">&amp;&amp;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">ch</span><span class="p">)</span> <span class="k">return</span> <span class="nx">get</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">rtl</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">rtl</span> <span class="o">?</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span> <span class="o">:</span> <span class="nx">part</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">rtl</span> <span class="o">?</span> <span class="nx">part</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">left</span> <span class="o">==</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>Opera and IE return bogus offsets and widths for edges
where the direction flips, but only for the side with the
lower level. So we try to use the side with the higher
level.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">nb</span> <span class="o">=</span> <span class="nx">order</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]).</span><span class="nx">level</span><span class="p">)</span> <span class="nx">here</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">nb</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">nb</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">nb</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">here</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">rtl</span> <span class="o">&amp;&amp;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span> <span class="o">?</span> <span class="nx">ch</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">ch</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rtl</span> <span class="o">==</span> <span class="nx">linedir</span><span class="p">)</span> <span class="nx">main</span> <span class="o">=</span> <span class="nx">here</span><span class="p">;</span> <span class="k">else</span> <span class="nx">other</span> <span class="o">=</span> <span class="nx">here</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">right</span> <span class="o">==</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">nb</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">order</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">rtl</span> <span class="o">&amp;&amp;</span> <span class="nx">nb</span> <span class="o">&amp;&amp;</span> <span class="nx">nb</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="nx">nb</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nb</span> <span class="o">&amp;&amp;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;</span> <span class="nx">nb</span><span class="p">.</span><span class="nx">level</span><span class="p">)</span> <span class="nx">here</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">nb</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">nb</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">nb</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">here</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">rtl</span> <span class="o">?</span> <span class="nx">ch</span> <span class="o">:</span> <span class="nx">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rtl</span> <span class="o">==</span> <span class="nx">linedir</span><span class="p">)</span> <span class="nx">main</span> <span class="o">=</span> <span class="nx">here</span><span class="p">;</span> <span class="k">else</span> <span class="nx">other</span> <span class="o">=</span> <span class="nx">here</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">linedir</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">ch</span><span class="p">)</span> <span class="nx">other</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">to</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">main</span><span class="p">)</span> <span class="k">return</span> <span class="nx">other</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="nx">main</span><span class="p">.</span><span class="nx">other</span> <span class="o">=</span> <span class="nx">other</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">main</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>Coords must be lineSpace-local</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">coordsChar</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="nx">y</span> <span class="o">+=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">outside</span><span class="o">:</span> <span class="kc">true</span><span class="p">};</span>
    <span class="kd">var</span> <span class="nx">lineNo</span> <span class="o">=</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lineNo</span> <span class="o">&gt;=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">coordsCharInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">merged</span> <span class="o">=</span> <span class="nx">collapsedSpanAtEnd</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">merged</span> <span class="o">&amp;&amp;</span> <span class="nx">found</span><span class="p">.</span><span class="nx">ch</span> <span class="o">==</span> <span class="nx">lineRight</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">))</span>
        <span class="nx">lineNo</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">coordsCharInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">innerOff</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">wrongLine</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">cWidth</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">measurement</span> <span class="o">=</span> <span class="nx">measureLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sp</span> <span class="o">=</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">},</span> <span class="s2">&quot;line&quot;</span><span class="p">,</span>
                            <span class="nx">lineObj</span><span class="p">,</span> <span class="nx">measurement</span><span class="p">);</span>
      <span class="nx">wrongLine</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">innerOff</span> <span class="o">&gt;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">bottom</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">cWidth</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">innerOff</span> <span class="o">&lt;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="k">return</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">cWidth</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">wrongLine</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">bidi</span> <span class="o">=</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">),</span> <span class="nx">dist</span> <span class="o">=</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">lineLeft</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">),</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">lineRight</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">fromX</span> <span class="o">=</span> <span class="nx">paddingLeft</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">),</span> <span class="nx">toX</span> <span class="o">=</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">toX</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">outside</span><span class="o">:</span> <span class="nx">wrongLine</span><span class="p">};</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p>Do a binary search between these bounds.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">bidi</span> <span class="o">?</span> <span class="nx">to</span> <span class="o">==</span> <span class="nx">from</span> <span class="o">||</span> <span class="nx">to</span> <span class="o">==</span> <span class="nx">moveVisually</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">after</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">fromX</span> <span class="o">&lt;</span> <span class="nx">toX</span> <span class="o">-</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">after</span> <span class="o">?</span> <span class="nx">from</span> <span class="o">:</span> <span class="nx">to</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">isExtendingChar</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">ch</span><span class="p">)))</span> <span class="o">++</span><span class="nx">ch</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">after</span><span class="o">:</span> <span class="nx">after</span><span class="p">,</span> <span class="nx">outside</span><span class="o">:</span> <span class="nx">wrongLine</span><span class="p">};</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">dist</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nx">middle</span> <span class="o">=</span> <span class="nx">from</span> <span class="o">+</span> <span class="nx">step</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">bidi</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">middle</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">step</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">middle</span> <span class="o">=</span> <span class="nx">moveVisually</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">,</span> <span class="nx">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">middleX</span> <span class="o">=</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">middle</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">middleX</span> <span class="o">&gt;</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">middle</span><span class="p">;</span> <span class="nx">toX</span> <span class="o">=</span> <span class="nx">middleX</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wrongLine</span><span class="p">)</span> <span class="nx">toX</span> <span class="o">+=</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">dist</span> <span class="o">-=</span> <span class="nx">step</span><span class="p">;}</span>
      <span class="k">else</span> <span class="p">{</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">middle</span><span class="p">;</span> <span class="nx">fromX</span> <span class="o">=</span> <span class="nx">middleX</span><span class="p">;</span> <span class="nx">dist</span> <span class="o">=</span> <span class="nx">step</span><span class="p">;}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">measureText</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">textHeight</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">cachedTextHeight</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">display</span><span class="p">.</span><span class="nx">cachedTextHeight</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">measureText</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">measureText</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<p>Measure a bunch of lines, for browsers that compute
fractional heights.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">49</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">measureText</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">));</span>
        <span class="nx">measureText</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;br&quot;</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">measureText</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nx">removeChildrenAndAdd</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">measure</span><span class="p">,</span> <span class="nx">measureText</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">measureText</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">cachedTextHeight</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
    <span class="nx">removeChildren</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">measure</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">height</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">charWidth</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">cachedCharWidth</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">display</span><span class="p">.</span><span class="nx">cachedCharWidth</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">anchor</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pre</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">anchor</span><span class="p">]);</span>
    <span class="nx">removeChildrenAndAdd</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">measure</span><span class="p">,</span> <span class="nx">pre</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">anchor</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">cachedCharWidth</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">width</span> <span class="o">||</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p>OPERATIONS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>Operations are used to wrap changes in such a way that each
change won't have to update the cursor and display (which would
be awkward, slow, and error-prone), but instead updates are
batched and then all combined and executed at once.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">startOperation</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">)</span> <span class="o">++</span><span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">depth</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span> <span class="o">=</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>Nested operations delay update until the outermost one
finishes.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">depth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>An array of ranges of lines that have to be updated. See
updateDisplay.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">changes</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">delayedCallbacks</span><span class="o">:</span> <span class="p">[],</span>
      <span class="nx">updateInput</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">userSelChange</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">textChanged</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">selectionChanged</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">updateMaxLine</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">id</span><span class="o">:</span> <span class="o">++</span><span class="nx">cm</span><span class="p">.</span><span class="nx">nextOpId</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">endOperation</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">op</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="nx">op</span><span class="p">.</span><span class="nx">depth</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">updateMaxLine</span><span class="p">)</span> <span class="nx">computeMaxLength</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">maxLineChanged</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">measureChar</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">maxLine</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">maxLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">right</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">minWidth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">width</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="nx">scrollerCutOff</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineChanged</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">newScrollPos</span><span class="p">,</span> <span class="nx">updated</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">selectionChanged</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coords</span> <span class="o">=</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">);</span>
      <span class="nx">newScrollPos</span> <span class="o">=</span> <span class="nx">calculateScrollPos</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">bottom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">changes</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">newScrollPos</span> <span class="o">&amp;&amp;</span> <span class="nx">newScrollPos</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
      <span class="nx">updated</span> <span class="o">=</span> <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">op</span><span class="p">.</span><span class="nx">changes</span><span class="p">,</span> <span class="nx">newScrollPos</span> <span class="o">&amp;&amp;</span> <span class="nx">newScrollPos</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">updated</span> <span class="o">&amp;&amp;</span> <span class="nx">op</span><span class="p">.</span><span class="nx">selectionChanged</span><span class="p">)</span> <span class="nx">updateSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">newScrollPos</span><span class="p">)</span> <span class="nx">scrollCursorIntoView</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">selectionChanged</span><span class="p">)</span> <span class="nx">restartBlink</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span> <span class="o">&amp;&amp;</span> <span class="nx">op</span><span class="p">.</span><span class="nx">updateInput</span><span class="p">)</span>
      <span class="nx">resetInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">op</span><span class="p">.</span><span class="nx">userSelChange</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">textChanged</span><span class="p">)</span>
      <span class="nx">signal</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">,</span> <span class="nx">op</span><span class="p">.</span><span class="nx">textChanged</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">selectionChanged</span><span class="p">)</span> <span class="nx">signal</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;cursorActivity&quot;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">op</span><span class="p">.</span><span class="nx">delayedCallbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">op</span><span class="p">.</span><span class="nx">delayedCallbacks</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">cm</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86">&#182;</a>
</div>
<p>Wraps a function in an operation. Returns the wrapped function.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm1</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cm</span> <span class="o">=</span> <span class="nx">cm1</span> <span class="o">||</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">startOperation</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
      <span class="k">try</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);}</span>
      <span class="k">finally</span> <span class="p">{</span><span class="nx">endOperation</span><span class="p">(</span><span class="nx">cm</span><span class="p">);}</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">regChange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">lendiff</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">changes</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">diff</span><span class="o">:</span> <span class="nx">lendiff</span><span class="p">});</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<p>INPUT HANDLING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">slowPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">pollingFast</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">pollInterval</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">readInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">slowPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">fastPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">missed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">p</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="nx">readInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">changed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">missed</span><span class="p">)</span> <span class="p">{</span><span class="nx">missed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nx">p</span><span class="p">);}</span>
      <span class="k">else</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="nx">slowPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);}</span>
    <span class="p">}</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nx">p</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88">&#182;</a>
</div>
<p>prevInput is a hack to work with IME. If we reset the textarea
on every change, that breaks IME. So we look for changes
compared to the previous content instead. (Modern browsers have
events that indicate IME taking place, but these are not widely
supported or compatible enough yet to rely on.)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">readInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="nx">prevInput</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span><span class="p">,</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">sel</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span> <span class="o">||</span> <span class="nx">hasSelection</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="o">||</span> <span class="nx">isReadOnly</span><span class="p">(</span><span class="nx">cm</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">text</span> <span class="o">==</span> <span class="nx">prevInput</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">startOperation</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">same</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">prevInput</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">same</span> <span class="o">&lt;</span> <span class="nx">l</span> <span class="o">&amp;&amp;</span> <span class="nx">prevInput</span><span class="p">[</span><span class="nx">same</span><span class="p">]</span> <span class="o">==</span> <span class="nx">text</span><span class="p">[</span><span class="nx">same</span><span class="p">])</span> <span class="o">++</span><span class="nx">same</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">same</span> <span class="o">&lt;</span> <span class="nx">prevInput</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="p">(</span><span class="nx">prevInput</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">same</span><span class="p">)};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">overwrite</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pasteIncoming</span><span class="p">)</span>
      <span class="nx">to</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span> <span class="o">+</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">same</span><span class="p">))};</span>
    <span class="kd">var</span> <span class="nx">updateInput</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">updateInput</span><span class="p">;</span>
    <span class="nx">updateDoc</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">splitLines</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">same</span><span class="p">)),</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
              <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pasteIncoming</span> <span class="o">?</span> <span class="s2">&quot;paste&quot;</span> <span class="o">:</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">});</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">updateInput</span> <span class="o">=</span> <span class="nx">updateInput</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
    <span class="nx">endOperation</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pasteIncoming</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">resetInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">minimal</span><span class="p">,</span> <span class="nx">selected</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">minimal</span> <span class="o">=</span> <span class="nx">hasCopyEvent</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">-</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">||</span> <span class="p">(</span><span class="nx">selected</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">()).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">minimal</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">selected</span> <span class="o">||</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">selectInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">inaccurateSelection</span> <span class="o">=</span> <span class="nx">minimal</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">focusInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">readOnly</span> <span class="o">!=</span> <span class="s2">&quot;nocursor&quot;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">ie</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span> <span class="o">!=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">))</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isReadOnly</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">readOnly</span> <span class="o">||</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">cantEdit</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-89" id="section-89">&#182;</a>
</div>
<p>EVENT HANDLERS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">registerEventHandlers</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">onMouseDown</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;dblclick&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e_preventDefault</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">lineSpace</span><span class="p">,</span> <span class="s2">&quot;selectstart&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mouseEventInWidget</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">e</span><span class="p">))</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90">&#182;</a>
</div>
<p>Gecko browsers fire contextmenu <em>after</em> opening the menu, at
which point we can't mess with it anymore. Context menu is
handled in onMouseDown for Gecko.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gecko</span><span class="p">)</span> <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;contextmenu&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="nx">onContextMenu</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);});</span>

    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">setScrollTop</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">);</span>
      <span class="nx">setScrollLeft</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">signal</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">,</span> <span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">setScrollTop</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">,</span> <span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">setScrollLeft</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;mousewheel&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">onScrollWheel</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);});</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;DOMMouseScroll&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">onScrollWheel</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);});</span>

    <span class="kd">function</span> <span class="nx">reFocus</span><span class="p">()</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">bind</span><span class="p">(</span><span class="nx">focusInput</span><span class="p">,</span> <span class="nx">cm</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">,</span> <span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="nx">reFocus</span><span class="p">);</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">,</span> <span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="nx">reFocus</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91">&#182;</a>
</div>
<p>Prevent wrapper from ever scrolling</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">,</span> <span class="s2">&quot;scroll&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">});</span>
    <span class="nx">on</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s2">&quot;resize&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">resizeHandler</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>Might be a text scaling operation, clear size caches.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">d</span><span class="p">.</span><span class="nx">cachedCharWidth</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">cachedTextHeight</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">clearCaches</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">off</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s2">&quot;resize&quot;</span><span class="p">,</span> <span class="nx">resizeHandler</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;keyup&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;keyCode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">fastPoll</span><span class="p">,</span> <span class="nx">cm</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;keydown&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">onKeyDown</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;keypress&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">onKeyPress</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;focus&quot;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">onFocus</span><span class="p">,</span> <span class="nx">cm</span><span class="p">));</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;blur&quot;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">onBlur</span><span class="p">,</span> <span class="nx">cm</span><span class="p">));</span>

    <span class="kd">function</span> <span class="nx">drag_</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onDragEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onDragEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">e_stop</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">dragDrop</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;dragstart&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">onDragStart</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);});</span>
      <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;dragenter&quot;</span><span class="p">,</span> <span class="nx">drag_</span><span class="p">);</span>
      <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;dragover&quot;</span><span class="p">,</span> <span class="nx">drag_</span><span class="p">);</span>
      <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">onDrop</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;paste&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">focusInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span> <span class="nx">fastPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);});</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;paste&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">pasteIncoming</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">fastPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="kd">function</span> <span class="nx">prepareCopy</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">inaccurateSelection</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">inaccurateSelection</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">();</span>
        <span class="nx">selectInput</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;cut&quot;</span><span class="p">,</span> <span class="nx">prepareCopy</span><span class="p">);</span>
    <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="nx">prepareCopy</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93">&#182;</a>
</div>
<p>Needed to handle Tab key in KHTML</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">khtml</span><span class="p">)</span> <span class="nx">on</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">sizer</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span> <span class="o">==</span> <span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">)</span> <span class="nx">d</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
        <span class="nx">focusInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">mouseEventInWidget</span><span class="p">(</span><span class="nx">display</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="sr">/\bCodeMirror-(?:line)?widget\b/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">className</span><span class="p">)</span> <span class="o">||</span>
          <span class="nx">n</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">mover</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">liberal</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">liberal</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarH</span> <span class="o">||</span> <span class="nx">target</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">||</span>
          <span class="nx">target</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarV</span> <span class="o">||</span> <span class="nx">target</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">||</span>
          <span class="nx">target</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarFiller</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">space</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineSpace</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>Fails unpredictably on IE[67] when mouse is dragged around quickly.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">try</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">;</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">;</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">coordsChar</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">space</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">space</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">lastClick</span><span class="p">,</span> <span class="nx">lastDoubleClick</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">onMouseDown</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">sel</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;shiftKey&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">mouseEventInWidget</span><span class="p">(</span><span class="nx">display</span><span class="p">,</span> <span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">webkit</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;},</span> <span class="mi">100</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">clickInGutter</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">e_button</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gecko</span><span class="p">)</span> <span class="nx">onContextMenu</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">start</span><span class="p">);</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">bind</span><span class="p">(</span><span class="nx">focusInput</span><span class="p">,</span> <span class="nx">cm</span><span class="p">),</span> <span class="mi">20</span><span class="p">);</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>For button 1, if it was clicked inside the editor
(posFromMouse returning non-null), we have to adjust the
selection.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">==</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">)</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="k">return</span><span class="p">;}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">onFocus</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">,</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lastDoubleClick</span> <span class="o">&amp;&amp;</span> <span class="nx">lastDoubleClick</span><span class="p">.</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">lastDoubleClick</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">start</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;triple&quot;</span><span class="p">;</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">bind</span><span class="p">(</span><span class="nx">focusInput</span><span class="p">,</span> <span class="nx">cm</span><span class="p">),</span> <span class="mi">20</span><span class="p">);</span>
      <span class="nx">selectLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">lastClick</span> <span class="o">&amp;&amp;</span> <span class="nx">lastClick</span><span class="p">.</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="nx">now</span> <span class="o">-</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">lastClick</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">start</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;double&quot;</span><span class="p">;</span>
      <span class="nx">lastDoubleClick</span> <span class="o">=</span> <span class="p">{</span><span class="nx">time</span><span class="o">:</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pos</span><span class="o">:</span> <span class="nx">start</span><span class="p">};</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">word</span> <span class="o">=</span> <span class="nx">findWordAt</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">,</span> <span class="nx">start</span><span class="p">);</span>
      <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">word</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">word</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">lastClick</span> <span class="o">=</span> <span class="p">{</span><span class="nx">time</span><span class="o">:</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pos</span><span class="o">:</span> <span class="nx">start</span><span class="p">};</span> <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">dragDrop</span> <span class="o">&amp;&amp;</span> <span class="nx">dragAndDrop</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isReadOnly</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dragEnd</span> <span class="o">=</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">webkit</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">draggingText</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">off</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="nx">dragEnd</span><span class="p">);</span>
        <span class="nx">off</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="nx">dragEnd</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">clientX</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">clientY</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e2</span><span class="p">);</span>
          <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">start</span><span class="p">);</span>
          <span class="nx">focusInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96">&#182;</a>
</div>
<p>Let the drag handler handle this.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">webkit</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">draggable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">draggingText</span> <span class="o">=</span> <span class="nx">dragEnd</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97">&#182;</a>
</div>
<p>IE's approach to draggable</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">dragDrop</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">dragDrop</span><span class="p">();</span>
      <span class="nx">on</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="nx">dragEnd</span><span class="p">);</span>
      <span class="nx">on</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="nx">dragEnd</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">)</span> <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">start</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">startstart</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">startend</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">doSelect</span><span class="p">(</span><span class="nx">cur</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">start</span><span class="p">),</span> <span class="nx">cur</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">startstart</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">startstart</span><span class="p">);</span>
      <span class="nx">startend</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">startend</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;double&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">word</span> <span class="o">=</span> <span class="nx">findWordAt</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">,</span> <span class="nx">cur</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">startstart</span><span class="p">))</span> <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">word</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">startend</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">startstart</span><span class="p">,</span> <span class="nx">word</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;triple&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">startstart</span><span class="p">))</span> <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">startend</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">}));</span>
        <span class="k">else</span> <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">startstart</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">}));</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">editorSize</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-98" id="section-98">&#182;</a>
</div>
<p>Used to ensure timeout re-tries don't fire when another extend
happened in the meantime (clearTimeout isn't reliable -- at
least on Chrome, the timeouts still happen even when cleared,
if the clear happens after their scheduled firing time).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">curCount</span> <span class="o">=</span> <span class="o">++</span><span class="nx">counter</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cur</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">last</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">onFocus</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
        <span class="nx">last</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">;</span>
        <span class="nx">doSelect</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">visible</span> <span class="o">=</span> <span class="nx">visibleLines</span><span class="p">(</span><span class="nx">display</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">line</span> <span class="o">&gt;=</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">to</span> <span class="o">||</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="nx">visible</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="k">if</span> <span class="p">(</span><span class="nx">counter</span> <span class="o">==</span> <span class="nx">curCount</span><span class="p">)</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">e</span><span class="p">);}),</span> <span class="mi">150</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">outside</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">&lt;</span> <span class="nx">editorSize</span><span class="p">.</span><span class="nx">top</span> <span class="o">?</span> <span class="o">-</span><span class="mi">20</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">&gt;</span> <span class="nx">editorSize</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">?</span> <span class="mi">20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">outside</span><span class="p">)</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">counter</span> <span class="o">!=</span> <span class="nx">curCount</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">+=</span> <span class="nx">outside</span><span class="p">;</span>
          <span class="nx">extend</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}),</span> <span class="mi">50</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">done</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">counter</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">)</span> <span class="nx">doSelect</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">focusInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
      <span class="nx">off</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;mousemove&quot;</span><span class="p">,</span> <span class="nx">move</span><span class="p">);</span>
      <span class="nx">off</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="nx">up</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">move</span> <span class="o">=</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ie</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">e_button</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="nx">done</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">up</span> <span class="o">=</span> <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="nx">on</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;mousemove&quot;</span><span class="p">,</span> <span class="nx">move</span><span class="p">);</span>
    <span class="nx">on</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="nx">up</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onDrop</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onDragEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onDragEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pos</span> <span class="o">||</span> <span class="nx">isReadOnly</span><span class="p">(</span><span class="nx">cm</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">files</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">FileReader</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">text</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="nx">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">loadFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">;</span>
        <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">read</span> <span class="o">==</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
            <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">text</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="s2">&quot;paste&quot;</span><span class="p">);</span>
              <span class="nx">setSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
            <span class="p">})();</span>
          <span class="p">}</span>
        <span class="p">};</span>
        <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
      <span class="p">};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">loadFile</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99">&#182;</a>
</div>
<p>Don't do a replace if the drop happened inside of the selected text.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">draggingText</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="o">||</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)))</span> <span class="p">{</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">draggingText</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ie</span><span class="p">)</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">bind</span><span class="p">(</span><span class="nx">focusInput</span><span class="p">,</span> <span class="nx">cm</span><span class="p">),</span> <span class="mi">50</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="s2">&quot;Text&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">curFrom</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">curTo</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
          <span class="nx">setSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">draggingText</span><span class="p">)</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">curFrom</span><span class="p">,</span> <span class="nx">curTo</span><span class="p">,</span> <span class="s2">&quot;paste&quot;</span><span class="p">);</span>
          <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceSelection</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;paste&quot;</span><span class="p">);</span>
          <span class="nx">focusInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
          <span class="nx">onFocus</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">clickInGutter</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">mX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">mY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">mX</span> <span class="o">&gt;=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">().</span><span class="nx">right</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasHandler</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;gutterClick&quot;</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">lineBox</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineDiv</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mY</span> <span class="o">&gt;</span> <span class="nx">lineBox</span><span class="p">.</span><span class="nx">bottom</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">mY</span> <span class="o">-=</span> <span class="nx">lineBox</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">g</span> <span class="o">&amp;&amp;</span> <span class="nx">g</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">().</span><span class="nx">right</span> <span class="o">&gt;=</span> <span class="nx">mX</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">mY</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">gutter</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">gutters</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">signalLater</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;gutterClick&quot;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">gutter</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onDragStart</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">();</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="s2">&quot;Text&quot;</span><span class="p">,</span> <span class="nx">txt</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-100" id="section-100">&#182;</a>
</div>
<p>Use dummy image instead of default browsers image.
Recent Safari (~6.0.2) have a tendency to segfault when this happens, so we don't do it there.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">setDragImage</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">safari</span><span class="p">)</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">setDragImage</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">setScrollTop</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">-</span> <span class="nx">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gecko</span><span class="p">)</span> <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">!=</span> <span class="nx">val</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">!=</span> <span class="nx">val</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">gecko</span><span class="p">)</span> <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="p">[]);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">setScrollLeft</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">isScroller</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isScroller</span> <span class="o">?</span> <span class="nx">val</span> <span class="o">==</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">-</span> <span class="nx">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="nx">alignHorizontally</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">!=</span> <span class="nx">val</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">!=</span> <span class="nx">val</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-101" id="section-101">&#182;</a>
</div>
<p>Since the delta values reported on mouse wheel events are
unstandardized between browsers and even browser versions, and
generally horribly unpredictable, this code starts by measuring
the scroll effect that the first few mouse wheel events have,
and, from that, detects the way it can convert deltas to pixel
offsets afterwards.</p>

<p>The reason we want to know the amount a wheel event will scroll
is that it gives us a chance to update the display before the
actual scrolling happens, reducing flickering.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">var</span> <span class="nx">wheelSamples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">wheelDX</span><span class="p">,</span> <span class="nx">wheelDY</span><span class="p">,</span> <span class="nx">wheelStartX</span><span class="p">,</span> <span class="nx">wheelStartY</span><span class="p">,</span> <span class="nx">wheelPixelsPerUnit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<p>Fill in a browser-detected starting value on browsers where we
know one. These don't have to be accurate -- the result of them
being wrong would just be a slight flicker on the first wheel
scroll (if it is large enough).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ie</span><span class="p">)</span> <span class="nx">wheelPixelsPerUnit</span> <span class="o">=</span> <span class="o">-</span><span class="p">.</span><span class="mi">53</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">gecko</span><span class="p">)</span> <span class="nx">wheelPixelsPerUnit</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">chrome</span><span class="p">)</span> <span class="nx">wheelPixelsPerUnit</span> <span class="o">=</span> <span class="o">-</span><span class="p">.</span><span class="mi">7</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">safari</span><span class="p">)</span> <span class="nx">wheelPixelsPerUnit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">onScrollWheel</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">wheelDeltaX</span><span class="p">,</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">wheelDeltaY</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">detail</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="nx">e</span><span class="p">.</span><span class="nx">HORIZONTAL_AXIS</span><span class="p">)</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">detail</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dy</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">detail</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="nx">e</span><span class="p">.</span><span class="nx">VERTICAL_AXIS</span><span class="p">)</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">detail</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">dy</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">wheelDelta</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103">&#182;</a>
</div>
<p>Webkit browsers on OS X abort momentum scrolls when the target
of the scroll event is removed from the scrollable element.
This hack (see related code in patchDisplay) makes sure the
element is kept around.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dy</span> <span class="o">&amp;&amp;</span> <span class="nx">mac</span> <span class="o">&amp;&amp;</span> <span class="nx">webkit</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span> <span class="nx">cur</span> <span class="o">!=</span> <span class="nx">scroll</span><span class="p">;</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">lineObj</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">currentWheelTarget</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">scroll</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-104" id="section-104">&#182;</a>
</div>
<p>On some browsers, horizontal scrolling will cause redraws to
happen before the gutter has been realigned, causing it to
wriggle around in a most unseemly way. When we have an
estimated pixels/delta value, we just handle horizontal
scrolling entirely here. It'll be slightly off from native, but
better than glitching out.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">gecko</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">opera</span> <span class="o">&amp;&amp;</span> <span class="nx">wheelPixelsPerUnit</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dy</span><span class="p">)</span>
        <span class="nx">setScrollTop</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">scroll</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">wheelPixelsPerUnit</span><span class="p">,</span> <span class="nx">scroll</span><span class="p">.</span><span class="nx">scrollHeight</span> <span class="o">-</span> <span class="nx">scroll</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">)));</span>
      <span class="nx">setScrollLeft</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">scroll</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">+</span> <span class="nx">dx</span> <span class="o">*</span> <span class="nx">wheelPixelsPerUnit</span><span class="p">,</span> <span class="nx">scroll</span><span class="p">.</span><span class="nx">scrollWidth</span> <span class="o">-</span> <span class="nx">scroll</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">)));</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">wheelStartX</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// Abort measurement, if in progress</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">dy</span> <span class="o">&amp;&amp;</span> <span class="nx">wheelPixelsPerUnit</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pixels</span> <span class="o">=</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">wheelPixelsPerUnit</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">,</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nx">top</span> <span class="o">+</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pixels</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">top</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">top</span> <span class="o">+</span> <span class="nx">pixels</span> <span class="o">-</span> <span class="mi">50</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">bot</span> <span class="o">+</span> <span class="nx">pixels</span> <span class="o">+</span> <span class="mi">50</span><span class="p">);</span>
      <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{</span><span class="nx">top</span><span class="o">:</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">bottom</span><span class="o">:</span> <span class="nx">bot</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">wheelSamples</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">wheelStartX</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">wheelStartX</span> <span class="o">=</span> <span class="nx">scroll</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span> <span class="nx">wheelStartY</span> <span class="o">=</span> <span class="nx">scroll</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
        <span class="nx">wheelDX</span> <span class="o">=</span> <span class="nx">dx</span><span class="p">;</span> <span class="nx">wheelDY</span> <span class="o">=</span> <span class="nx">dy</span><span class="p">;</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">wheelStartX</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">movedX</span> <span class="o">=</span> <span class="nx">scroll</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">-</span> <span class="nx">wheelStartX</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">movedY</span> <span class="o">=</span> <span class="nx">scroll</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">-</span> <span class="nx">wheelStartY</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">sample</span> <span class="o">=</span> <span class="p">(</span><span class="nx">movedY</span> <span class="o">&amp;&amp;</span> <span class="nx">wheelDY</span> <span class="o">&amp;&amp;</span> <span class="nx">movedY</span> <span class="o">/</span> <span class="nx">wheelDY</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="nx">movedX</span> <span class="o">&amp;&amp;</span> <span class="nx">wheelDX</span> <span class="o">&amp;&amp;</span> <span class="nx">movedX</span> <span class="o">/</span> <span class="nx">wheelDX</span><span class="p">);</span>
          <span class="nx">wheelStartX</span> <span class="o">=</span> <span class="nx">wheelStartY</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sample</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="nx">wheelPixelsPerUnit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">wheelPixelsPerUnit</span> <span class="o">*</span> <span class="nx">wheelSamples</span> <span class="o">+</span> <span class="nx">sample</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">wheelSamples</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="o">++</span><span class="nx">wheelSamples</span><span class="p">;</span>
        <span class="p">},</span> <span class="mi">200</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">wheelDX</span> <span class="o">+=</span> <span class="nx">dx</span><span class="p">;</span> <span class="nx">wheelDY</span> <span class="o">+=</span> <span class="nx">dy</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">doHandleBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">bound</span><span class="p">,</span> <span class="nx">dropShift</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">bound</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bound</span> <span class="o">=</span> <span class="nx">commands</span><span class="p">[</span><span class="nx">bound</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bound</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<p>Ensure previous input has been read, so that the handler sees a
consistent view of the document</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pollingFast</span> <span class="o">&amp;&amp;</span> <span class="nx">readInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">))</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">pollingFast</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">prevShift</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isReadOnly</span><span class="p">(</span><span class="nx">cm</span><span class="p">))</span> <span class="nx">view</span><span class="p">.</span><span class="nx">suppressEdits</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dropShift</span><span class="p">)</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">bound</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">!=</span> <span class="nx">Pass</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="nx">prevShift</span><span class="p">;</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">suppressEdits</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">allKeyMaps</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">maps</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keyMaps</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">maps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">extraKeys</span><span class="p">)</span> <span class="nx">maps</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">extraKeys</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">maps</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">maybeTransition</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">handleKeyBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<p>Handle auto keymap transitions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">startMap</span> <span class="o">=</span> <span class="nx">getKeyMap</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">),</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">startMap</span><span class="p">.</span><span class="nx">auto</span><span class="p">;</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">maybeTransition</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isModifierKey</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="nx">maybeTransition</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">getKeyMap</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">)</span> <span class="o">==</span> <span class="nx">startMap</span><span class="p">)</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">keyMap</span> <span class="o">=</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">call</span> <span class="o">?</span> <span class="nx">next</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">cm</span><span class="p">)</span> <span class="o">:</span> <span class="nx">next</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;keyCode&quot;</span><span class="p">)],</span> <span class="nx">handled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">flipCtrlCmd</span> <span class="o">=</span> <span class="nx">mac</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">opera</span> <span class="o">||</span> <span class="nx">qtwebkit</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">altGraphKey</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;altKey&quot;</span><span class="p">))</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Alt-&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">flipCtrlCmd</span> <span class="o">?</span> <span class="s2">&quot;metaKey&quot;</span> <span class="o">:</span> <span class="s2">&quot;ctrlKey&quot;</span><span class="p">))</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Ctrl-&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">flipCtrlCmd</span> <span class="o">?</span> <span class="s2">&quot;ctrlKey&quot;</span> <span class="o">:</span> <span class="s2">&quot;metaKey&quot;</span><span class="p">))</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Cmd-&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">stopped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">stop</span><span class="p">()</span> <span class="p">{</span> <span class="nx">stopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">keymaps</span> <span class="o">=</span> <span class="nx">allKeyMaps</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;shiftKey&quot;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">handled</span> <span class="o">=</span> <span class="nx">lookupKey</span><span class="p">(</span><span class="s2">&quot;Shift-&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">keymaps</span><span class="p">,</span>
                          <span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">doHandleBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">true</span><span class="p">);},</span> <span class="nx">stop</span><span class="p">)</span>
        <span class="o">||</span> <span class="nx">lookupKey</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">keymaps</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">b</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^go[A-Z]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="k">return</span> <span class="nx">doHandleBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">stop</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">handled</span> <span class="o">=</span> <span class="nx">lookupKey</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">keymaps</span><span class="p">,</span>
                          <span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">doHandleBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span> <span class="p">},</span> <span class="nx">stop</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">stopped</span><span class="p">)</span> <span class="nx">handled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">handled</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">restartBlink</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ie_lt9</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">oldKeyCode</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">handled</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">handleCharBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">handled</span> <span class="o">=</span> <span class="nx">lookupKey</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nx">ch</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="nx">allKeyMaps</span><span class="p">(</span><span class="nx">cm</span><span class="p">),</span>
                            <span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">doHandleBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">handled</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">restartBlink</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">handled</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">lastStoppedKey</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">onKeyDown</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">onFocus</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ie</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">27</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;keyCode&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-107" id="section-107">&#182;</a>
</div>
<p>IE does strange things with escape.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="nx">code</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">||</span> <span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;shiftKey&quot;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-108" id="section-108">&#182;</a>
</div>
<p>First give onKeyEvent option a chance to handle this.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">handled</span> <span class="o">=</span> <span class="nx">handleKeyBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opera</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">lastStoppedKey</span> <span class="o">=</span> <span class="nx">handled</span> <span class="o">?</span> <span class="nx">code</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-109" id="section-109">&#182;</a>
</div>
<p>Opera has no cut event... we try to at least catch the key combo</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">handled</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span> <span class="o">==</span> <span class="mi">88</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">hasCopyEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">mac</span> <span class="o">?</span> <span class="s2">&quot;metaKey&quot;</span> <span class="o">:</span> <span class="s2">&quot;ctrlKey&quot;</span><span class="p">))</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceSelection</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onKeyPress</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onKeyEvent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">e</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">keyCode</span> <span class="o">=</span> <span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;keyCode&quot;</span><span class="p">),</span> <span class="nx">charCode</span> <span class="o">=</span> <span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;charCode&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opera</span> <span class="o">&amp;&amp;</span> <span class="nx">keyCode</span> <span class="o">==</span> <span class="nx">lastStoppedKey</span><span class="p">)</span> <span class="p">{</span><span class="nx">lastStoppedKey</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="k">return</span><span class="p">;}</span>
    <span class="k">if</span> <span class="p">(((</span><span class="nx">opera</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="o">||</span> <span class="nx">khtml</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">handleKeyBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">charCode</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">keyCode</span> <span class="o">:</span> <span class="nx">charCode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">electricChars</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">electricChars</span> <span class="o">&amp;&amp;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">smartIndent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isReadOnly</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">electricChars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">indentLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="s2">&quot;smart&quot;</span><span class="p">);}),</span> <span class="mi">75</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">handleCharBinding</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ch</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">fastPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onFocus</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">readOnly</span> <span class="o">==</span> <span class="s2">&quot;nocursor&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">signal</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;focus&quot;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\bCodeMirror-focused\b/</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s2">&quot; CodeMirror-focused&quot;</span><span class="p">;</span>
      <span class="nx">resetInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">slowPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">restartBlink</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">onBlur</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">signal</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;blur&quot;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot; CodeMirror-focused&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">blinker</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;},</span> <span class="mi">150</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">detectingSelectAll</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">onContextMenu</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">sel</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">posFromMouse</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">e</span><span class="p">),</span> <span class="nx">scrollPos</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pos</span> <span class="o">||</span> <span class="nx">opera</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Opera is difficult.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="o">||</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span>
      <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">setSelection</span><span class="p">)(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">oldCSS</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;absolute&quot;</span><span class="p">;</span>
    <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="s2">&quot;position: fixed; width: 30px; height: 30px; top: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span>
      <span class="s2">&quot;px; left: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px; z-index: 1000; background: white; outline: none;&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);&quot;</span><span class="p">;</span>
    <span class="nx">focusInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">resetInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-110" id="section-110">&#182;</a>
</div>
<p>Adds "Select all" to context menu in FF</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">rehide</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">inputDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;relative&quot;</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="nx">oldCSS</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ie_lt9</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">scrollPos</span><span class="p">;</span>
      <span class="nx">slowPoll</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-111" id="section-111">&#182;</a>
</div>
<p>Try to detect the user choosing select-all </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">selectionStart</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">detectingSelectAll</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">extval</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
        <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">selectionStart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">selectionEnd</span> <span class="o">=</span> <span class="nx">extval</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">detectingSelectAll</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="nx">poll</span><span class="p">(){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">prevInput</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">selectionStart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">commands</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">)(</span><span class="nx">cm</span><span class="p">);</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="nx">detectingSelectAll</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">poll</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
          <span class="k">else</span> <span class="nx">resetInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
        <span class="p">},</span> <span class="mi">200</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">gecko</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e_stop</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">on</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">mouseup</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">off</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="nx">mouseup</span><span class="p">);</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">rehide</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">rehide</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-112" id="section-112">&#182;</a>
</div>
<p>UPDATING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-113" id="section-113">&#182;</a>
</div>
<p>Replace the range from from to to by the strings in newText.
Afterwards, set the selection to selFrom, selTo.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">updateDoc</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">newText</span><span class="p">,</span> <span class="nx">selUpdate</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-114" id="section-114">&#182;</a>
</div>
<p>Possibly split or suppress the update based on the presence
of read-only spans in its range.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">split</span> <span class="o">=</span> <span class="nx">sawReadOnlySpans</span> <span class="o">&amp;&amp;</span>
      <span class="nx">removeReadOnlyRanges</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">split</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">split</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span>
        <span class="nx">updateDocInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">split</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">from</span><span class="p">,</span> <span class="nx">split</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">to</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="nx">origin</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">split</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">updateDocInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">split</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">from</span><span class="p">,</span> <span class="nx">split</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">to</span><span class="p">,</span> <span class="nx">newText</span><span class="p">,</span> <span class="nx">selUpdate</span><span class="p">,</span> <span class="nx">origin</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">updateDocInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">newText</span><span class="p">,</span> <span class="nx">selUpdate</span><span class="p">,</span> <span class="nx">origin</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateDocInner</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">newText</span><span class="p">,</span> <span class="nx">selUpdate</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">suppressEdits</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">old</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">old</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newHL</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">startSelFrom</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">startSelTo</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="nx">updateMarkedSpans</span><span class="p">(</span><span class="nx">hlSpans</span><span class="p">(</span><span class="nx">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lst</span><span class="p">(</span><span class="nx">old</span><span class="p">)),</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">newText</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">retval</span> <span class="o">=</span> <span class="nx">updateDocNoUndo</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">selUpdate</span><span class="p">,</span> <span class="nx">origin</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">)</span> <span class="nx">addChange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span>
                                <span class="nx">startSelFrom</span><span class="p">,</span> <span class="nx">startSelTo</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">retval</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">unredoHelper</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">hist</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">set</span> <span class="o">=</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;undo&quot;</span> <span class="o">?</span> <span class="nx">hist</span><span class="p">.</span><span class="nx">done</span> <span class="o">:</span> <span class="nx">hist</span><span class="p">.</span><span class="nx">undone</span><span class="p">).</span><span class="nx">pop</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">set</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">anti</span> <span class="o">=</span> <span class="p">{</span><span class="nx">events</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">fromBefore</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">fromAfter</span><span class="p">,</span> <span class="nx">toBefore</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">toAfter</span><span class="p">,</span>
                <span class="nx">fromAfter</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">fromBefore</span><span class="p">,</span> <span class="nx">toAfter</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">toBefore</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">set</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hist</span><span class="p">.</span><span class="nx">dirtyCounter</span> <span class="o">+=</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;undo&quot;</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">change</span> <span class="o">=</span> <span class="nx">set</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">replaced</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">change</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">change</span><span class="p">.</span><span class="nx">added</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">replaced</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newHL</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">));</span> <span class="p">});</span>
      <span class="nx">anti</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">start</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">added</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">old</span><span class="o">:</span> <span class="nx">replaced</span><span class="p">});</span>
      <span class="kd">var</span> <span class="nx">selPos</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">fromBefore</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">toBefore</span><span class="p">};</span>
      <span class="nx">updateDocNoUndo</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">change</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">end</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">},</span>
                      <span class="nx">change</span><span class="p">.</span><span class="nx">old</span><span class="p">,</span> <span class="nx">selPos</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;undo&quot;</span> <span class="o">?</span> <span class="nx">hist</span><span class="p">.</span><span class="nx">undone</span> <span class="o">:</span> <span class="nx">hist</span><span class="p">.</span><span class="nx">done</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">anti</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateDocNoUndo</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">selUpdate</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">suppressEdits</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">nlines</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">-</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">firstLine</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">lastLine</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">recomputeMaxLength</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">checkWidthStart</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">checkWidthStart</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">visualLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">));</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">checkWidthStart</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">lineLength</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span> <span class="o">==</span> <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineLength</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">recomputeMaxLength</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">lastHL</span> <span class="o">=</span> <span class="nx">lst</span><span class="p">(</span><span class="nx">lines</span><span class="p">),</span> <span class="nx">th</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">(</span><span class="nx">display</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-115" id="section-115">&#182;</a>
</div>
<p>First adjust the line structure</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">lastHL</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-116" id="section-116">&#182;</a>
</div>
<p>This is a whole-line replace. Treated specially to make
sure line objects move the way they are supposed to.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="nx">added</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">makeLine</span><span class="p">(</span><span class="nx">hlText</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">th</span><span class="p">));</span>
      <span class="nx">updateLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lastLine</span><span class="p">,</span> <span class="nx">lastLine</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lastHL</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">nlines</span><span class="p">)</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">nlines</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">added</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">added</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">firstLine</span> <span class="o">==</span> <span class="nx">lastLine</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">updateLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                   <span class="nx">firstLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
          <span class="nx">added</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">makeLine</span><span class="p">(</span><span class="nx">hlText</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">th</span><span class="p">));</span>
        <span class="nx">added</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">makeLine</span><span class="p">(</span><span class="nx">hlText</span><span class="p">(</span><span class="nx">lastHL</span><span class="p">)</span> <span class="o">+</span> <span class="nx">firstLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lastHL</span><span class="p">),</span> <span class="nx">th</span><span class="p">));</span>
        <span class="nx">updateLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
        <span class="nx">doc</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">added</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">updateLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                 <span class="nx">lastLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">nlines</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">updateLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">,</span> <span class="nx">firstLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span> <span class="o">+</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
      <span class="nx">updateLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lastLine</span><span class="p">,</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">lastHL</span><span class="p">)</span> <span class="o">+</span> <span class="nx">lastLine</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lastHL</span><span class="p">));</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="nx">added</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">makeLine</span><span class="p">(</span><span class="nx">hlText</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">th</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">nlines</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">nlines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">cm</span><span class="p">);</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">added</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">perLine</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">/</span> <span class="nx">charWidth</span><span class="p">(</span><span class="nx">display</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">guess</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">perLine</span><span class="p">)</span> <span class="o">||</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">th</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">guess</span> <span class="o">!=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">guess</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">checkWidthStart</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">lineLength</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineLength</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">maxLine</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineLength</span> <span class="o">=</span> <span class="nx">len</span><span class="p">;</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">maxLineChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">recomputeMaxLength</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">recomputeMaxLength</span><span class="p">)</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">updateMaxLine</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-117" id="section-117">&#182;</a>
</div>
<p>Adjust frontier, schedule worker</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">frontier</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
    <span class="nx">startWorker</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">lendiff</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">nlines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-118" id="section-118">&#182;</a>
</div>
<p>Remember that these lines changed, for updating the display</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">regChange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">lendiff</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hasHandler</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="s2">&quot;change&quot;</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-119" id="section-119">&#182;</a>
</div>
<p>Normalize lines to contain only strings, since that's what
the change event handler expects</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">text</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">changeObj</span> <span class="o">=</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">origin</span><span class="o">:</span> <span class="nx">origin</span><span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">textChanged</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">textChanged</span><span class="p">;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">next</span><span class="p">;</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">next</span><span class="p">)</span> <span class="p">{}</span>
        <span class="nx">cur</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">changeObj</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">textChanged</span> <span class="o">=</span> <span class="nx">changeObj</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-120" id="section-120">&#182;</a>
</div>
<p>Update the selection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">newSelFrom</span><span class="p">,</span> <span class="nx">newSelTo</span><span class="p">,</span> <span class="nx">end</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                     <span class="nx">ch</span><span class="o">:</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">lastHL</span><span class="p">).</span><span class="nx">length</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">selUpdate</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">selUpdate</span> <span class="o">!=</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">selUpdate</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="p">{</span> <span class="nx">newSelFrom</span> <span class="o">=</span> <span class="nx">selUpdate</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span> <span class="nx">newSelTo</span> <span class="o">=</span> <span class="nx">selUpdate</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">else</span> <span class="nx">newSelFrom</span> <span class="o">=</span> <span class="nx">newSelTo</span> <span class="o">=</span> <span class="nx">selUpdate</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">selUpdate</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newSelFrom</span> <span class="o">=</span> <span class="nx">newSelTo</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">selUpdate</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newSelFrom</span> <span class="o">=</span> <span class="nx">newSelTo</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">selUpdate</span> <span class="o">==</span> <span class="s2">&quot;around&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">newSelFrom</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span> <span class="nx">newSelTo</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">adjustPos</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">from</span><span class="p">))</span> <span class="k">return</span> <span class="nx">pos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">pos</span><span class="p">))</span> <span class="k">return</span> <span class="nx">end</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="nx">lendiff</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span>
          <span class="nx">ch</span> <span class="o">+=</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">lastHL</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">?</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">};</span>
      <span class="p">};</span>
      <span class="nx">newSelFrom</span> <span class="o">=</span> <span class="nx">adjustPos</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
      <span class="nx">newSelTo</span> <span class="o">=</span> <span class="nx">adjustPos</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">setSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">newSelFrom</span><span class="p">,</span> <span class="nx">newSelTo</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">end</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">to</span><span class="p">)</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">from</span><span class="p">))</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">updateDoc</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">splitLines</span><span class="p">(</span><span class="nx">code</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">origin</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-121" id="section-121">&#182;</a>
</div>
<p>SELECTION</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">line</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ch</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ch</span><span class="p">;}</span>
  <span class="kd">function</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">line</span> <span class="o">||</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">line</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ch</span><span class="p">);}</span>
  <span class="kd">function</span> <span class="nx">copyPos</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">x</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">x</span><span class="p">.</span><span class="nx">ch</span><span class="p">};}</span>

  <span class="kd">function</span> <span class="nx">clipLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">));}</span>
  <span class="kd">function</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">line</span> <span class="o">&gt;=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">};</span>
    <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">linelen</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">ch</span> <span class="o">&gt;</span> <span class="nx">linelen</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">linelen</span><span class="p">};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
    <span class="k">else</span> <span class="k">return</span> <span class="nx">pos</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">isLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">l</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">;}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-122" id="section-122">&#182;</a>
</div>
<p>If shift is held, this will move the selection anchor. Otherwise,
it'll set the whole selection.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">other</span><span class="p">,</span> <span class="nx">bias</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sel</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">||</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">extend</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">anchor</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">anchor</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posBefore</span> <span class="o">=</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">posBefore</span> <span class="o">!=</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">anchor</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span>
          <span class="nx">pos</span> <span class="o">=</span> <span class="nx">other</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">posBefore</span> <span class="o">!=</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">other</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">pos</span> <span class="o">=</span> <span class="nx">other</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">setSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">bias</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">setSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">other</span> <span class="o">||</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">bias</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">userSelChange</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-123" id="section-123">&#182;</a>
</div>
<p>Update the selection. Last two args are only used by
updateDoc, since they have to be expressed in the line
numbers before the update.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">setSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">bias</span><span class="p">,</span> <span class="nx">checkAtomic</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">goalColumn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">sel</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-124" id="section-124">&#182;</a>
</div>
<p>Skip over atomic spans.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">checkAtomic</span> <span class="o">||</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">anchor</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">anchor</span><span class="p">))</span>
      <span class="nx">anchor</span> <span class="o">=</span> <span class="nx">skipAtomic</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">,</span> <span class="nx">bias</span><span class="p">,</span> <span class="nx">checkAtomic</span> <span class="o">!=</span> <span class="s2">&quot;push&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">checkAtomic</span> <span class="o">||</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">))</span>
      <span class="nx">head</span> <span class="o">=</span> <span class="nx">skipAtomic</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">bias</span><span class="p">,</span> <span class="nx">checkAtomic</span> <span class="o">!=</span> <span class="s2">&quot;push&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">anchor</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">,</span> <span class="nx">head</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">sel</span><span class="p">.</span><span class="nx">anchor</span> <span class="o">=</span> <span class="nx">anchor</span><span class="p">;</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="nx">head</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">inv</span> <span class="o">=</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">);</span>
    <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">inv</span> <span class="o">?</span> <span class="nx">head</span> <span class="o">:</span> <span class="nx">anchor</span><span class="p">;</span>
    <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">inv</span> <span class="o">?</span> <span class="nx">anchor</span> <span class="o">:</span> <span class="nx">head</span><span class="p">;</span>

    <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">updateInput</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">selectionChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">reCheckSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;push&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">skipAtomic</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">bias</span><span class="p">,</span> <span class="nx">mayClear</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">flipped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">curPos</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dir</span> <span class="o">=</span> <span class="nx">bias</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">cantEdit</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">search</span><span class="o">:</span> <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">curPos</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">toClear</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">sp</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">inclusiveLeft</span> <span class="o">?</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">curPos</span><span class="p">.</span><span class="nx">ch</span> <span class="o">:</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">curPos</span><span class="p">.</span><span class="nx">ch</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
              <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">inclusiveRight</span> <span class="o">?</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;=</span> <span class="nx">curPos</span><span class="p">.</span><span class="nx">ch</span> <span class="o">:</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">curPos</span><span class="p">.</span><span class="nx">ch</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">mayClear</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">clearOnEnter</span><span class="p">)</span> <span class="p">{</span>
              <span class="p">(</span><span class="nx">toClear</span> <span class="o">||</span> <span class="p">(</span><span class="nx">toClear</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span>
              <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">.</span><span class="nx">atomic</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">newPos</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">find</span><span class="p">()[</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;from&quot;</span> <span class="o">:</span> <span class="s2">&quot;to&quot;</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">newPos</span><span class="p">,</span> <span class="nx">curPos</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">newPos</span><span class="p">.</span><span class="nx">ch</span> <span class="o">+=</span> <span class="nx">dir</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">newPos</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">newPos</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="nx">newPos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">newPos</span><span class="p">.</span><span class="nx">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">});</span>
                <span class="k">else</span> <span class="nx">newPos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">newPos</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&gt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">newPos</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">newPos</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">newPos</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
                <span class="k">else</span> <span class="nx">newPos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newPos</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">flipped</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-125" id="section-125">&#182;</a>
</div>
<p>Driven in a corner -- no valid cursor position found at all
-- try again <em>with</em> clearing, if we didn't already</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mayClear</span><span class="p">)</span> <span class="k">return</span> <span class="nx">skipAtomic</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">bias</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-126" id="section-126">&#182;</a>
</div>
<p>Otherwise, turn off editing until further notice, and return the start of the doc</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                  <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">cantEdit</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                  <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
                <span class="p">}</span>
                <span class="nx">flipped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">newPos</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span> <span class="nx">dir</span> <span class="o">=</span> <span class="o">-</span><span class="nx">dir</span><span class="p">;</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">curPos</span> <span class="o">=</span> <span class="nx">newPos</span><span class="p">;</span>
            <span class="k">continue</span> <span class="nx">search</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">toClear</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">toClear</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">toClear</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">clear</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">curPos</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-127" id="section-127">&#182;</a>
</div>
<p>SCROLLING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">scrollCursorIntoView</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">coords</span> <span class="o">=</span> <span class="nx">scrollPosIntoView</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">view</span><span class="p">.</span><span class="nx">focused</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">box</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">(),</span> <span class="nx">doScroll</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">box</span><span class="p">.</span><span class="nx">top</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">doScroll</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">+</span> <span class="nx">box</span><span class="p">.</span><span class="nx">top</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">))</span> <span class="nx">doScroll</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doScroll</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">phantom</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">hidden</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
        <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">display</span><span class="p">.</span><span class="nx">viewOffset</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">scrollIntoView</span><span class="p">(</span><span class="nx">doScroll</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hidden</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">scrollPosIntoView</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">coords</span> <span class="o">=</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">scrollPos</span> <span class="o">=</span> <span class="nx">calculateScrollPos</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">bottom</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">startTop</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">,</span> <span class="nx">startLeft</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">scrollPos</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setScrollTop</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">scrollPos</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">-</span> <span class="nx">startTop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">scrollPos</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setScrollLeft</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">scrollPos</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">-</span> <span class="nx">startLeft</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">changed</span><span class="p">)</span> <span class="k">return</span> <span class="nx">coords</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">scrollIntoView</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">scrollPos</span> <span class="o">=</span> <span class="nx">calculateScrollPos</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">scrollPos</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">setScrollTop</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">scrollPos</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">scrollPos</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">setScrollLeft</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">scrollPos</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">calculateScrollPos</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">,</span> <span class="nx">pt</span> <span class="o">=</span> <span class="nx">paddingTop</span><span class="p">(</span><span class="nx">display</span><span class="p">);</span>
    <span class="nx">y1</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">;</span> <span class="nx">y2</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">screen</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">-</span> <span class="nx">scrollerCutOff</span><span class="p">,</span> <span class="nx">screentop</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">docBottom</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">pt</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">atTop</span> <span class="o">=</span> <span class="nx">y1</span> <span class="o">&lt;</span> <span class="nx">pt</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">atBottom</span> <span class="o">=</span> <span class="nx">y2</span> <span class="o">+</span> <span class="nx">pt</span> <span class="o">&gt;</span> <span class="nx">docBottom</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">y1</span> <span class="o">&lt;</span> <span class="nx">screentop</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">atTop</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">y1</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">y2</span> <span class="o">&gt;</span> <span class="nx">screentop</span> <span class="o">+</span> <span class="nx">screen</span><span class="p">)</span> <span class="nx">result</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="p">(</span><span class="nx">atBottom</span> <span class="o">?</span> <span class="nx">docBottom</span> <span class="o">:</span> <span class="nx">y2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">screen</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">screenw</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span> <span class="nx">scrollerCutOff</span><span class="p">,</span> <span class="nx">screenleft</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span>
    <span class="nx">x1</span> <span class="o">+=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span> <span class="nx">x2</span> <span class="o">+=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gutterw</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">atLeft</span> <span class="o">=</span> <span class="nx">x1</span> <span class="o">&lt;</span> <span class="nx">gutterw</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">&lt;</span> <span class="nx">screenleft</span> <span class="o">+</span> <span class="nx">gutterw</span> <span class="o">||</span> <span class="nx">atLeft</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">atLeft</span><span class="p">)</span> <span class="nx">x1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">x1</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">-</span> <span class="nx">gutterw</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">x2</span> <span class="o">&gt;</span> <span class="nx">screenw</span> <span class="o">+</span> <span class="nx">screenleft</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="nx">x2</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span> <span class="nx">screenw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-128" id="section-128">&#182;</a>
</div>
<p>API UTILITIES</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">indentLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">how</span><span class="p">,</span> <span class="nx">aggressive</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">how</span><span class="p">)</span> <span class="nx">how</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;smart&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">indent</span><span class="p">)</span> <span class="nx">how</span> <span class="o">=</span> <span class="s2">&quot;prev&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tabSize</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">n</span><span class="p">),</span> <span class="nx">curSpace</span> <span class="o">=</span> <span class="nx">countColumn</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">curSpaceString</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\s*/</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">indentation</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;smart&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">indentation</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">indent</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">curSpaceString</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">indentation</span> <span class="o">==</span> <span class="nx">Pass</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aggressive</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="nx">how</span> <span class="o">=</span> <span class="s2">&quot;prev&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;prev&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="nx">countColumn</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">)</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="nx">curSpace</span> <span class="o">+</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">indentUnit</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">how</span> <span class="o">==</span> <span class="s2">&quot;subtract&quot;</span><span class="p">)</span> <span class="nx">indentation</span> <span class="o">=</span> <span class="nx">curSpace</span> <span class="o">-</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">indentUnit</span><span class="p">;</span>
    <span class="nx">indentation</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">indentation</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">indentString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">indentWithTabs</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">indentation</span> <span class="o">/</span> <span class="nx">tabSize</span><span class="p">);</span> <span class="nx">i</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span><span class="nx">pos</span> <span class="o">+=</span> <span class="nx">tabSize</span><span class="p">;</span> <span class="nx">indentString</span> <span class="o">+=</span> <span class="s2">&quot;\t&quot;</span><span class="p">;}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">indentation</span><span class="p">)</span> <span class="nx">indentString</span> <span class="o">+=</span> <span class="nx">spaceStr</span><span class="p">(</span><span class="nx">indentation</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">indentString</span> <span class="o">!=</span> <span class="nx">curSpaceString</span><span class="p">)</span>
      <span class="nx">replaceRange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">indentString</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">curSpaceString</span><span class="p">.</span><span class="nx">length</span><span class="p">},</span> <span class="s2">&quot;input&quot;</span><span class="p">);</span>
    <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">changeLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">no</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">handle</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">clipLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">handle</span><span class="p">));</span>
    <span class="k">else</span> <span class="nx">no</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">handle</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">no</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">no</span><span class="p">))</span> <span class="nx">regChange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">no</span><span class="p">,</span> <span class="nx">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">findPosH</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">,</span> <span class="nx">visually</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">,</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">end</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">end</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">findNextLine</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">line</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">l</span> <span class="o">==</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">line</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">l</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">moveOnce</span><span class="p">(</span><span class="nx">boundToLine</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="p">(</span><span class="nx">visually</span> <span class="o">?</span> <span class="nx">moveVisually</span> <span class="o">:</span> <span class="nx">moveLogically</span><span class="p">)(</span><span class="nx">lineObj</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">boundToLine</span> <span class="o">&amp;&amp;</span> <span class="nx">findNextLine</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">visually</span><span class="p">)</span> <span class="nx">ch</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">lineRight</span> <span class="o">:</span> <span class="nx">lineLeft</span><span class="p">)(</span><span class="nx">lineObj</span><span class="p">);</span>
          <span class="k">else</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">)</span> <span class="nx">moveOnce</span><span class="p">();</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;column&quot;</span><span class="p">)</span> <span class="nx">moveOnce</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;word&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sawWord</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">moveOnce</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isWordChar</span><span class="p">(</span><span class="nx">lineObj</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">ch</span><span class="p">)))</span> <span class="nx">sawWord</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sawWord</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="nx">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">moveOnce</span><span class="p">();}</span> <span class="k">break</span><span class="p">;}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">moveOnce</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">skipAtomic</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">},</span> <span class="nx">dir</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">findWordAt</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">after</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">end</span> <span class="o">==</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">--</span><span class="nx">start</span><span class="p">;</span> <span class="k">else</span> <span class="o">++</span><span class="nx">end</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">startChar</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="nx">isWordChar</span><span class="p">(</span><span class="nx">startChar</span><span class="p">)</span> <span class="o">?</span> <span class="nx">isWordChar</span> <span class="o">:</span>
        <span class="sr">/\s/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">startChar</span><span class="p">)</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="sr">/\s/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ch</span><span class="p">);}</span> <span class="o">:</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="o">!</span><span class="sr">/\s/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isWordChar</span><span class="p">(</span><span class="nx">ch</span><span class="p">);};</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">start</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">check</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">--</span><span class="nx">start</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">check</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">end</span><span class="p">)))</span> <span class="o">++</span><span class="nx">end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">start</span><span class="p">},</span> <span class="nx">to</span><span class="o">:</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">end</span><span class="p">}};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selectLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">extendSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">}));</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-129" id="section-129">&#182;</a>
</div>
<p>PROTOTYPE</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-130" id="section-130">&#182;</a>
</div>
<p>The publicly visible API. Note that operation(null, f) means
'wrap f in an operation, performed on its <code>this</code> parameter'</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lineSep</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">text</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">lineSep</span> <span class="o">||</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setValue</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">top</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="nx">lastLen</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">updateDocInner</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">lastLen</span><span class="p">},</span> <span class="nx">splitLines</span><span class="p">(</span><span class="nx">code</span><span class="p">),</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="s2">&quot;setValue&quot;</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">getSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lineSep</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">lineSep</span><span class="p">);</span> <span class="p">},</span>

    <span class="nx">replaceSelection</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">collapse</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>
      <span class="nx">updateDoc</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">splitLines</span><span class="p">(</span><span class="nx">code</span><span class="p">),</span> <span class="nx">collapse</span> <span class="o">||</span> <span class="s2">&quot;around&quot;</span><span class="p">,</span> <span class="nx">origin</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">focus</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="nb">window</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span> <span class="nx">focusInput</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="nx">onFocus</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="nx">fastPoll</span><span class="p">(</span><span class="k">this</span><span class="p">);},</span>

    <span class="nx">setOption</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">option</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">old</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">==</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">option</span> <span class="o">!=</span> <span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">optionHandlers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">option</span><span class="p">))</span>
        <span class="nx">operation</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">optionHandlers</span><span class="p">[</span><span class="nx">option</span><span class="p">])(</span><span class="k">this</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">old</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getOption</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">option</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">];},</span>

    <span class="nx">getMode</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">;},</span>

    <span class="nx">addKeyMap</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keyMaps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">removeKeyMap</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">maps</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">keyMaps</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">maps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">map</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">?</span> <span class="nx">maps</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="o">:</span> <span class="nx">maps</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">==</span> <span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">maps</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">undo</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">unredoHelper</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;undo&quot;</span><span class="p">);}),</span>
    <span class="nx">redo</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="nx">unredoHelper</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;redo&quot;</span><span class="p">);}),</span>

    <span class="nx">indentLine</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">aggressive</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">dir</span> <span class="o">!=</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">dir</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">smartIndent</span> <span class="o">?</span> <span class="s2">&quot;smart&quot;</span> <span class="o">:</span> <span class="s2">&quot;prev&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="nx">dir</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">?</span> <span class="s2">&quot;add&quot;</span> <span class="o">:</span> <span class="s2">&quot;subtract&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">n</span><span class="p">))</span> <span class="nx">indentLine</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">aggressive</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">indentSelection</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">how</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="k">return</span> <span class="nx">indentLine</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">how</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">-</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">ch</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">indentLine</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">how</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">historySize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">hist</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">undo</span><span class="o">:</span> <span class="nx">hist</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">redo</span><span class="o">:</span> <span class="nx">hist</span><span class="p">.</span><span class="nx">undone</span><span class="p">.</span><span class="nx">length</span><span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">clearHistory</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="nx">makeHistory</span><span class="p">();},</span>

    <span class="nx">markClean</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">dirtyCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">lastOp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">lastOrigin</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isClean</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">dirtyCounter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;},</span>
      
    <span class="nx">getHistory</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">hist</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">cp</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">nw</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">nwelt</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">set</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">nw</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">events</span><span class="o">:</span> <span class="nx">nwelt</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">fromBefore</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">fromBefore</span><span class="p">,</span> <span class="nx">toBefore</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">toBefore</span><span class="p">,</span>
                   <span class="nx">fromAfter</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">fromAfter</span><span class="p">,</span> <span class="nx">toAfter</span><span class="o">:</span> <span class="nx">set</span><span class="p">.</span><span class="nx">toAfter</span><span class="p">});</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">elt</span> <span class="o">=</span> <span class="nx">set</span><span class="p">.</span><span class="nx">events</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">elt</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">old</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
            <span class="nx">nwelt</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">start</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">added</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">added</span><span class="p">,</span> <span class="nx">old</span><span class="o">:</span> <span class="nx">old</span><span class="p">});</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">k</span><span class="p">)</span> <span class="nx">old</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">hlText</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">old</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">nw</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">done</span><span class="o">:</span> <span class="nx">cp</span><span class="p">(</span><span class="nx">hist</span><span class="p">.</span><span class="nx">done</span><span class="p">),</span> <span class="nx">undone</span><span class="o">:</span> <span class="nx">cp</span><span class="p">(</span><span class="nx">hist</span><span class="p">.</span><span class="nx">undone</span><span class="p">)};</span>
    <span class="p">},</span>

    <span class="nx">setHistory</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">histData</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">hist</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="nx">makeHistory</span><span class="p">();</span>
      <span class="nx">hist</span><span class="p">.</span><span class="nx">done</span> <span class="o">=</span> <span class="nx">histData</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
      <span class="nx">hist</span><span class="p">.</span><span class="nx">undone</span> <span class="o">=</span> <span class="nx">histData</span><span class="p">.</span><span class="nx">undone</span><span class="p">;</span>
    <span class="p">},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-131" id="section-131">&#182;</a>
</div>
<p>Fetch the parser token for a given character. Useful for hacks
that want to inspect the mode state (say, for completion).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">getTokenAt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="nx">mode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StringStream</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">eol</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">stream</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">token</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">start</span><span class="o">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
              <span class="nx">end</span><span class="o">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span>
              <span class="nx">string</span><span class="o">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">current</span><span class="p">(),</span>
              <span class="nx">className</span><span class="o">:</span> <span class="nx">style</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// Deprecated, use &#39;type&#39; instead</span>
              <span class="nx">type</span><span class="o">:</span> <span class="nx">style</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span>
              <span class="nx">state</span><span class="o">:</span> <span class="nx">state</span><span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">getStateAfter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">line</span> <span class="o">=</span> <span class="nx">clipLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">:</span> <span class="nx">line</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">cursorCoords</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">sel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">start</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">start</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">mode</span> <span class="o">||</span> <span class="s2">&quot;page&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">charCoords</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">charCoords</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">),</span> <span class="nx">mode</span> <span class="o">||</span> <span class="s2">&quot;page&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">coordsChar</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">off</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">lineSpace</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">coordsChar</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">off</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">off</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">defaultTextHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">textHeight</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">);</span> <span class="p">},</span>

    <span class="nx">markText</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">markText</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">),</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">to</span><span class="p">),</span>
                      <span class="nx">options</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">setBookmark</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">widget</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">markText</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">widget</span> <span class="o">?</span> <span class="p">{</span><span class="nx">replacedWith</span><span class="o">:</span> <span class="nx">widget</span><span class="p">}</span> <span class="o">:</span> <span class="p">{},</span> <span class="s2">&quot;bookmark&quot;</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">findMarksAt</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">markers</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">spans</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">markedSpans</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">spans</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">spans</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">ch</span><span class="p">))</span>
          <span class="nx">markers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">marker</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">markers</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">setGutterMarker</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">gutterID</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">changeLine</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">markers</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span> <span class="o">||</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span> <span class="o">=</span> <span class="p">{});</span>
        <span class="nx">markers</span><span class="p">[</span><span class="nx">gutterID</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">isEmpty</span><span class="p">(</span><span class="nx">markers</span><span class="p">))</span> <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}),</span>

    <span class="nx">clearGutter</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gutterID</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cm</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span> <span class="o">&amp;&amp;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span><span class="p">[</span><span class="nx">gutterID</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span><span class="p">[</span><span class="nx">gutterID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">regChange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span><span class="p">))</span> <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="o">++</span><span class="nx">i</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}),</span>

    <span class="nx">addLineClass</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">where</span><span class="p">,</span> <span class="nx">cls</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">changeLine</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">handle</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prop</span> <span class="o">=</span> <span class="nx">where</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span> <span class="o">?</span> <span class="s2">&quot;textClass&quot;</span> <span class="o">:</span> <span class="nx">where</span> <span class="o">==</span> <span class="s2">&quot;background&quot;</span> <span class="o">?</span> <span class="s2">&quot;bgClass&quot;</span> <span class="o">:</span> <span class="s2">&quot;wrapClass&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="nx">line</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cls</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;\\b&quot;</span> <span class="o">+</span> <span class="nx">cls</span> <span class="o">+</span> <span class="s2">&quot;\\b&quot;</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">line</span><span class="p">[</span><span class="nx">prop</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">else</span> <span class="nx">line</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">cls</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}),</span>

    <span class="nx">removeLineClass</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">where</span><span class="p">,</span> <span class="nx">cls</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">changeLine</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">handle</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prop</span> <span class="o">=</span> <span class="nx">where</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span> <span class="o">?</span> <span class="s2">&quot;textClass&quot;</span> <span class="o">:</span> <span class="nx">where</span> <span class="o">==</span> <span class="s2">&quot;background&quot;</span> <span class="o">?</span> <span class="s2">&quot;bgClass&quot;</span> <span class="o">:</span> <span class="s2">&quot;wrapClass&quot;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">line</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cur</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">cls</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">line</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">upd</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="nx">cls</span> <span class="o">+</span> <span class="s2">&quot;\\b\\s*|\\s*\\b&quot;</span> <span class="o">+</span> <span class="nx">cls</span> <span class="o">+</span> <span class="s2">&quot;\\b&quot;</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">upd</span> <span class="o">==</span> <span class="nx">cur</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">line</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">upd</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}),</span>

    <span class="nx">addLineWidget</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">widget</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">widget</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">noHScroll</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">alignWidgets</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">changeLine</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">handle</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">widgets</span> <span class="o">||</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">widgets</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">widget</span><span class="p">);</span>
        <span class="nx">widget</span><span class="p">.</span><span class="nx">line</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">widget</span><span class="p">;</span>
    <span class="p">}),</span>

    <span class="nx">removeLineWidget</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">widget</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">line</span><span class="p">.</span><span class="nx">widgets</span><span class="p">,</span> <span class="nx">no</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">no</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ws</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">widget</span><span class="p">)</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">regChange</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">no</span><span class="p">,</span> <span class="nx">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">lineInfo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">line</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isLine</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">))</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
        <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">handle</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">gutterMarkers</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">gutterMarkers</span><span class="p">,</span>
              <span class="nx">textClass</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">textClass</span><span class="p">,</span> <span class="nx">bgClass</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">bgClass</span><span class="p">,</span> <span class="nx">wrapClass</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">wrapClass</span><span class="p">,</span>
              <span class="nx">widgets</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">widgets</span><span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">getViewport</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingFrom</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">showingTo</span><span class="p">};},</span>

    <span class="nx">addWidget</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">scroll</span><span class="p">,</span> <span class="nx">vert</span><span class="p">,</span> <span class="nx">horiz</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">display</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">));</span>
      <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s2">&quot;absolute&quot;</span><span class="p">;</span>
      <span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">vert</span> <span class="o">==</span> <span class="s2">&quot;over&quot;</span><span class="p">)</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vert</span> <span class="o">==</span> <span class="s2">&quot;near&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">vspace</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">height</span><span class="p">),</span>
        <span class="nx">hspace</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">,</span> <span class="nx">display</span><span class="p">.</span><span class="nx">lineSpace</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">&gt;</span> <span class="nx">vspace</span> <span class="o">&amp;&amp;</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">&gt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">)</span>
          <span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">&gt;</span> <span class="nx">hspace</span><span class="p">)</span>
          <span class="nx">left</span> <span class="o">=</span> <span class="nx">hspace</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">paddingTop</span><span class="p">(</span><span class="nx">display</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">horiz</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">left</span> <span class="o">=</span> <span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="s2">&quot;0px&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">horiz</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span> <span class="nx">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">horiz</span> <span class="o">==</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span> <span class="nx">left</span> <span class="o">=</span> <span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">sizer</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">left</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">scroll</span><span class="p">)</span>
        <span class="nx">scrollIntoView</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">left</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span> <span class="nx">top</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">lineCount</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">;},</span>

    <span class="nx">clipPos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);},</span>

    <span class="nx">getCursor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">,</span> <span class="nx">pos</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">start</span> <span class="o">==</span> <span class="s2">&quot;head&quot;</span><span class="p">)</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">==</span> <span class="s2">&quot;anchor&quot;</span><span class="p">)</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">anchor</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span> <span class="o">||</span> <span class="nx">start</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">copyPos</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">somethingSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">);},</span>

    <span class="nx">setCursor</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">extend</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">line</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span> <span class="o">?</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span> <span class="o">||</span> <span class="mi">0</span><span class="p">}</span> <span class="o">:</span> <span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">extend</span><span class="p">)</span> <span class="nx">extendSelection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">setSelection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">setSelection</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">anchor</span><span class="p">,</span> <span class="nx">head</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">setSelection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">anchor</span><span class="p">),</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">head</span> <span class="o">||</span> <span class="nx">anchor</span><span class="p">));</span>
    <span class="p">}),</span>

    <span class="nx">extendSelection</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">extendSelection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">),</span> <span class="nx">to</span> <span class="o">&amp;&amp;</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">to</span><span class="p">));</span>
    <span class="p">}),</span>

    <span class="nx">setExtending</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;},</span>

    <span class="nx">getLine</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getLineHandle</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span> <span class="k">return</span> <span class="nx">l</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">text</span><span class="p">;},</span>

    <span class="nx">getLineHandle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">))</span> <span class="k">return</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getLineNumber</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">);},</span>

    <span class="nx">setLine</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">))</span>
        <span class="nx">replaceRange</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">getLine</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">});</span>
    <span class="p">}),</span>

    <span class="nx">removeLine</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isLine</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">))</span>
        <span class="nx">replaceRange</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">}));</span>
    <span class="p">}),</span>

    <span class="nx">replaceRange</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">);</span>
      <span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span> <span class="o">?</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="o">:</span> <span class="nx">from</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">getRange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">lineSep</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">from</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">);</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">l1</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">l2</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">l1</span> <span class="o">==</span> <span class="nx">l2</span><span class="p">)</span> <span class="k">return</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">l1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="p">[</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">l1</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)];</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">l1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">l2</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="nx">code</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span> <span class="p">});</span>
      <span class="nx">code</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">l2</span><span class="p">).</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">));</span>
      <span class="k">return</span> <span class="nx">code</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">lineSep</span> <span class="o">||</span> <span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">triggerOnKeyDown</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">onKeyDown</span><span class="p">),</span>

    <span class="nx">execCommand</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">commands</span><span class="p">[</span><span class="nx">cmd</span><span class="p">](</span><span class="k">this</span><span class="p">);},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-132" id="section-132">&#182;</a>
</div>
<p>Stuff used by commands, probably not much use to outside code.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">moveH</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">shift</span> <span class="o">||</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">extend</span> <span class="o">||</span> <span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">findPosH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">extendSelection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">dir</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">deleteH</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">replaceRange</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">sel</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">findPosH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">,</span> <span class="kc">false</span><span class="p">),</span> <span class="s2">&quot;delete&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">userSelChange</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}),</span>

    <span class="nx">moveV</span><span class="o">:</span> <span class="nx">operation</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">unit</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">display</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">cursorCoords</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">cur</span><span class="p">,</span> <span class="s2">&quot;div&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">goalColumn</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">goalColumn</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pageSize</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">);</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">dir</span> <span class="o">*</span> <span class="nx">pageSize</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">dir</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">coordsChar</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
        <span class="nx">y</span> <span class="o">+=</span> <span class="nx">dir</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">outside</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">height</span><span class="p">));</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">unit</span> <span class="o">==</span> <span class="s2">&quot;page&quot;</span><span class="p">)</span> <span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">+=</span> <span class="nx">charCoords</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="s2">&quot;div&quot;</span><span class="p">).</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
      <span class="nx">extendSelection</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">dir</span><span class="p">);</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">goalColumn</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="p">}),</span>

    <span class="nx">toggleOverwrite</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">overwrite</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">overwrite</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s2">&quot; CodeMirror-overwrite&quot;</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot; CodeMirror-overwrite&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">posFromIndex</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">off</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lineNo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">sz</span> <span class="o">&gt;</span> <span class="nx">off</span><span class="p">)</span> <span class="p">{</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">off</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">off</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
        <span class="o">++</span><span class="nx">lineNo</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">clipPos</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">indexFromPos</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">line</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">index</span> <span class="o">+=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">index</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">scrollTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarH</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">updateDisplay</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">},</span>
    <span class="nx">getScrollInfo</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">scroller</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">,</span> <span class="nx">co</span> <span class="o">=</span> <span class="nx">scrollerCutOff</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">left</span><span class="o">:</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">,</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">,</span>
              <span class="nx">height</span><span class="o">:</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollHeight</span> <span class="o">-</span> <span class="nx">co</span><span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollWidth</span> <span class="o">-</span> <span class="nx">co</span><span class="p">,</span>
              <span class="nx">clientHeight</span><span class="o">:</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">-</span> <span class="nx">co</span><span class="p">,</span> <span class="nx">clientWidth</span><span class="o">:</span> <span class="nx">scroller</span><span class="p">.</span><span class="nx">clientWidth</span> <span class="o">-</span> <span class="nx">co</span><span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">scrollIntoView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pos</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">pos</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
      <span class="nx">pos</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">?</span> <span class="nx">clipPos</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">sel</span><span class="p">.</span><span class="nx">head</span><span class="p">;</span>
      <span class="nx">scrollPosIntoView</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">interpret</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span> <span class="o">||</span> <span class="sr">/^\d+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="o">?</span> <span class="nx">val</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span> <span class="o">:</span> <span class="nx">val</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">width</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">interpret</span><span class="p">(</span><span class="nx">width</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">height</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">interpret</span><span class="p">(</span><span class="nx">height</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">on</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span><span class="nx">on</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">);},</span>
    <span class="nx">off</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span><span class="nx">off</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">);},</span>

    <span class="nx">operation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">){</span><span class="k">return</span> <span class="nx">operation</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">f</span><span class="p">)();},</span>

    <span class="nx">refresh</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">clearCaches</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollHeight</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scrollbarV</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
      <span class="nx">updateDisplay</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getInputField</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">;},</span>
    <span class="nx">getWrapperElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">;},</span>
    <span class="nx">getScrollerElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">scroller</span><span class="p">;},</span>
    <span class="nx">getGutterElement</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">gutters</span><span class="p">;}</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-133" id="section-133">&#182;</a>
</div>
<p>OPTION DEFAULTS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">var</span> <span class="nx">optionHandlers</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">optionHandlers</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-134" id="section-134">&#182;</a>
</div>
<p>The default configuration options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">defaults</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="kd">function</span> <span class="nx">option</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">deflt</span><span class="p">,</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">notOnInit</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defaults</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">deflt</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">handle</span><span class="p">)</span> <span class="nx">optionHandlers</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span>
      <span class="nx">notOnInit</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">old</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">old</span> <span class="o">!=</span> <span class="nx">Init</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">old</span><span class="p">);}</span> <span class="o">:</span> <span class="nx">handle</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">Init</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">Init</span> <span class="o">=</span> <span class="p">{</span><span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="s2">&quot;CodeMirror.Init&quot;</span><span class="p">;}};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-135" id="section-135">&#182;</a>
</div>
<p>These two are, on init, called from the constructor because they
have to be initialized before the editor can start at all.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">val</span><span class="p">);},</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">loadMode</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;indentUnit&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">loadMode</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;indentWithTabs&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;smartIndent&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;tabSize&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">loadMode</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">clearCaches</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">updateDisplay</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;electricChars&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;theme&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">themeChanged</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">guttersChanged</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
  <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;keyMap&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="nx">keyMapChanged</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;extraKeys&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;onKeyEvent&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;onDragEvent&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;lineWrapping&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">wrappingChanged</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;gutters&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setGuttersForLineNumbers</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">guttersChanged</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
  <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;lineNumbers&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setGuttersForLineNumbers</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">guttersChanged</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
  <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;firstLineNumber&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">guttersChanged</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;lineNumberFormatter&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">integer</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">integer</span><span class="p">;},</span> <span class="nx">guttersChanged</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;showCursorWhenSelecting&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">updateSelection</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;readOnly&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">==</span> <span class="s2">&quot;nocursor&quot;</span><span class="p">)</span> <span class="p">{</span><span class="nx">onBlur</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">blur</span><span class="p">();}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">val</span><span class="p">)</span> <span class="nx">resetInput</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;dragDrop&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;cursorBlinkRate&quot;</span><span class="p">,</span> <span class="mi">530</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;cursorHeight&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;workTime&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;workDelay&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;flattenSpans&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;pollInterval&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;undoDepth&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;viewportMargin&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">){</span><span class="nx">cm</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();},</span> <span class="kc">true</span><span class="p">);</span>

  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;tabindex&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">tabIndex</span> <span class="o">=</span> <span class="nx">val</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">option</span><span class="p">(</span><span class="s2">&quot;autofocus&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-136" id="section-136">&#182;</a>
</div>
<p>MODE DEFINITION AND QUERYING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-137" id="section-137">&#182;</a>
</div>
<p>Known modes, by name and by MIME</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">modes</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">modes</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">mimeModes</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">mimeModes</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span><span class="p">)</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">mode</span><span class="p">.</span><span class="nx">dependencies</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="nx">modes</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineMIME</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mime</span><span class="p">,</span> <span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mimeModes</span><span class="p">[</span><span class="nx">mime</span><span class="p">]</span> <span class="o">=</span> <span class="nx">spec</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">resolveMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">spec</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">mimeModes</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">spec</span><span class="p">))</span>
      <span class="nx">spec</span> <span class="o">=</span> <span class="nx">mimeModes</span><span class="p">[</span><span class="nx">spec</span><span class="p">];</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">spec</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="sr">/^[\w\-]+\/[\w\-]+\+xml$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">spec</span><span class="p">))</span>
      <span class="k">return</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">resolveMode</span><span class="p">(</span><span class="s2">&quot;application/xml&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">spec</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">spec</span><span class="p">};</span>
    <span class="k">else</span> <span class="k">return</span> <span class="nx">spec</span> <span class="o">||</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;null&quot;</span><span class="p">};</span>
  <span class="p">};</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">getMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">spec</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">resolveMode</span><span class="p">(</span><span class="nx">spec</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">mfactory</span> <span class="o">=</span> <span class="nx">modes</span><span class="p">[</span><span class="nx">spec</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mfactory</span><span class="p">)</span> <span class="k">return</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">getMode</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">modeObj</span> <span class="o">=</span> <span class="nx">mfactory</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">spec</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">modeExtensions</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">exts</span> <span class="o">=</span> <span class="nx">modeExtensions</span><span class="p">[</span><span class="nx">spec</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">exts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">modeObj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="nx">modeObj</span><span class="p">[</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">modeObj</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
        <span class="nx">modeObj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exts</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">modeObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">modeObj</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineMode</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">token</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span><span class="nx">stream</span><span class="p">.</span><span class="nx">skipToEnd</span><span class="p">();}};</span>
  <span class="p">});</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineMIME</span><span class="p">(</span><span class="s2">&quot;text/plain&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">modeExtensions</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">modeExtensions</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">extendMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">exts</span> <span class="o">=</span> <span class="nx">modeExtensions</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="o">?</span> <span class="nx">modeExtensions</span><span class="p">[</span><span class="nx">mode</span><span class="p">]</span> <span class="o">:</span> <span class="p">(</span><span class="nx">modeExtensions</span><span class="p">[</span><span class="nx">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{});</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">properties</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">properties</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span>
      <span class="nx">exts</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">properties</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-138" id="section-138">&#182;</a>
</div>
<p>EXTENSIONS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineExtension</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineOption</span> <span class="o">=</span> <span class="nx">option</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">initHooks</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">defineInitHook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span><span class="nx">initHooks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">f</span><span class="p">);};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-139" id="section-139">&#182;</a>
</div>
<p>MODE STATE HANDLING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-140" id="section-140">&#182;</a>
</div>
<p>Utility functions for working with state. Exported because modes
sometimes need to do this.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">copyState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span><span class="p">.</span><span class="nx">copyState</span><span class="p">)</span> <span class="k">return</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">copyState</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">nstate</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">state</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">concat</span><span class="p">([]);</span>
      <span class="nx">nstate</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nstate</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">copyState</span> <span class="o">=</span> <span class="nx">copyState</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">startState</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">startState</span> <span class="o">?</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">startState</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">)</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">startState</span> <span class="o">=</span> <span class="nx">startState</span><span class="p">;</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">innerMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">mode</span><span class="p">.</span><span class="nx">innerMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">innerMode</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
      <span class="nx">state</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
      <span class="nx">mode</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">mode</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">info</span> <span class="o">||</span> <span class="p">{</span><span class="nx">mode</span><span class="o">:</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">state</span><span class="o">:</span> <span class="nx">state</span><span class="p">};</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-141" id="section-141">&#182;</a>
</div>
<p>STANDARD COMMANDS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">var</span> <span class="nx">commands</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">commands</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">selectAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">setSelection</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">lineCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">});},</span>
    <span class="nx">killLine</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span> <span class="nx">sel</span> <span class="o">=</span> <span class="o">!</span><span class="nx">posEq</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sel</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s2">&quot;delete&quot;</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">sel</span> <span class="o">?</span> <span class="nx">to</span> <span class="o">:</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">},</span> <span class="s2">&quot;delete&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">deleteLine</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">().</span><span class="nx">line</span><span class="p">;</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceRange</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">l</span><span class="p">},</span> <span class="s2">&quot;delete&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">undo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">undo</span><span class="p">();},</span>
    <span class="nx">redo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">redo</span><span class="p">();},</span>
    <span class="nx">goDocStart</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">extendSelection</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="mi">0</span><span class="p">});},</span>
    <span class="nx">goDocEnd</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">extendSelection</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">lineCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">});},</span>
    <span class="nx">goLineStart</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">extendSelection</span><span class="p">(</span><span class="nx">lineStart</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">().</span><span class="nx">line</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">goLineStartSmart</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(),</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">lineStart</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getLineHandle</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">order</span> <span class="o">||</span> <span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">firstNonWS</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/\S/</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">inWS</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">start</span><span class="p">.</span><span class="nx">line</span> <span class="o">&amp;&amp;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;=</span> <span class="nx">firstNonWS</span> <span class="o">&amp;&amp;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">extendSelection</span><span class="p">({</span><span class="nx">line</span><span class="o">:</span> <span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">inWS</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">firstNonWS</span><span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">extendSelection</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">goLineEnd</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cm</span><span class="p">.</span><span class="nx">extendSelection</span><span class="p">(</span><span class="nx">lineEnd</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">().</span><span class="nx">line</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">goLineUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveV</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">);},</span>
    <span class="nx">goLineDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">);},</span>
    <span class="nx">goPageUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveV</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">);},</span>
    <span class="nx">goPageDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">);},</span>
    <span class="nx">goCharLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">);},</span>
    <span class="nx">goCharRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">);},</span>
    <span class="nx">goColumnLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;column&quot;</span><span class="p">);},</span>
    <span class="nx">goColumnRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;column&quot;</span><span class="p">);},</span>
    <span class="nx">goWordLeft</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">);},</span>
    <span class="nx">goWordRight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">moveH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">);},</span>
    <span class="nx">delCharBefore</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">deleteH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">);},</span>
    <span class="nx">delCharAfter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">deleteH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;char&quot;</span><span class="p">);},</span>
    <span class="nx">delWordBefore</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">deleteH</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">);},</span>
    <span class="nx">delWordAfter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">deleteH</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;word&quot;</span><span class="p">);},</span>
    <span class="nx">indentAuto</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">indentSelection</span><span class="p">(</span><span class="s2">&quot;smart&quot;</span><span class="p">);},</span>
    <span class="nx">indentMore</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">indentSelection</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">);},</span>
    <span class="nx">indentLess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">indentSelection</span><span class="p">(</span><span class="s2">&quot;subtract&quot;</span><span class="p">);},</span>
    <span class="nx">insertTab</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">replaceSelection</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">);},</span>
    <span class="nx">defaultTab</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">somethingSelected</span><span class="p">())</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">indentSelection</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">);</span>
      <span class="k">else</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceSelection</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">transposeChars</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">(),</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getLine</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceRange</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span> <span class="o">+</span> <span class="nx">line</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">newlineAndIndent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">operation</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">replaceSelection</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">);</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">indentLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">().</span><span class="nx">line</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="p">})();</span>
    <span class="p">},</span>
    <span class="nx">toggleOverwrite</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">{</span><span class="nx">cm</span><span class="p">.</span><span class="nx">toggleOverwrite</span><span class="p">();}</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-142" id="section-142">&#182;</a>
</div>
<p>STANDARD KEYMAPS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">var</span> <span class="nx">keyMap</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">keyMap</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">keyMap</span><span class="p">.</span><span class="nx">basic</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goCharLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goCharRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Up&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineUp&quot;</span><span class="p">,</span> <span class="s2">&quot;Down&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineDown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;End&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Home&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineStartSmart&quot;</span><span class="p">,</span> <span class="s2">&quot;PageUp&quot;</span><span class="o">:</span> <span class="s2">&quot;goPageUp&quot;</span><span class="p">,</span> <span class="s2">&quot;PageDown&quot;</span><span class="o">:</span> <span class="s2">&quot;goPageDown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Delete&quot;</span><span class="o">:</span> <span class="s2">&quot;delCharAfter&quot;</span><span class="p">,</span> <span class="s2">&quot;Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delCharBefore&quot;</span><span class="p">,</span> <span class="s2">&quot;Tab&quot;</span><span class="o">:</span> <span class="s2">&quot;defaultTab&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Tab&quot;</span><span class="o">:</span> <span class="s2">&quot;indentAuto&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Enter&quot;</span><span class="o">:</span> <span class="s2">&quot;newlineAndIndent&quot;</span><span class="p">,</span> <span class="s2">&quot;Insert&quot;</span><span class="o">:</span> <span class="s2">&quot;toggleOverwrite&quot;</span>
  <span class="p">};</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-143" id="section-143">&#182;</a>
</div>
<p>Note that the save and find-related commands aren't defined by
default. Unknown commands are simply ignored.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">keyMap</span><span class="p">.</span><span class="nx">pcDefault</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Ctrl-A&quot;</span><span class="o">:</span> <span class="s2">&quot;selectAll&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-D&quot;</span><span class="o">:</span> <span class="s2">&quot;deleteLine&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Z&quot;</span><span class="o">:</span> <span class="s2">&quot;undo&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-Z&quot;</span><span class="o">:</span> <span class="s2">&quot;redo&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Y&quot;</span><span class="o">:</span> <span class="s2">&quot;redo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-Home&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Up&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-End&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Down&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocEnd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineEnd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordBefore&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-Delete&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordAfter&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-S&quot;</span><span class="o">:</span> <span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-F&quot;</span><span class="o">:</span> <span class="s2">&quot;find&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-G&quot;</span><span class="o">:</span> <span class="s2">&quot;findNext&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-G&quot;</span><span class="o">:</span> <span class="s2">&quot;findPrev&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-F&quot;</span><span class="o">:</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-R&quot;</span><span class="o">:</span> <span class="s2">&quot;replaceAll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-[&quot;</span><span class="o">:</span> <span class="s2">&quot;indentLess&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-]&quot;</span><span class="o">:</span> <span class="s2">&quot;indentMore&quot;</span><span class="p">,</span>
    <span class="nx">fallthrough</span><span class="o">:</span> <span class="s2">&quot;basic&quot;</span>
  <span class="p">};</span>
  <span class="nx">keyMap</span><span class="p">.</span><span class="nx">macDefault</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Cmd-A&quot;</span><span class="o">:</span> <span class="s2">&quot;selectAll&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-D&quot;</span><span class="o">:</span> <span class="s2">&quot;deleteLine&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Z&quot;</span><span class="o">:</span> <span class="s2">&quot;undo&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Cmd-Z&quot;</span><span class="o">:</span> <span class="s2">&quot;redo&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Y&quot;</span><span class="o">:</span> <span class="s2">&quot;redo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cmd-Up&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-End&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Down&quot;</span><span class="o">:</span> <span class="s2">&quot;goDocEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordLeft&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Alt-Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Left&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Right&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordBefore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-Alt-Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordAfter&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Delete&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordAfter&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-S&quot;</span><span class="o">:</span> <span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-F&quot;</span><span class="o">:</span> <span class="s2">&quot;find&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cmd-G&quot;</span><span class="o">:</span> <span class="s2">&quot;findNext&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Cmd-G&quot;</span><span class="o">:</span> <span class="s2">&quot;findPrev&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-Alt-F&quot;</span><span class="o">:</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Cmd-Alt-F&quot;</span><span class="o">:</span> <span class="s2">&quot;replaceAll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cmd-[&quot;</span><span class="o">:</span> <span class="s2">&quot;indentLess&quot;</span><span class="p">,</span> <span class="s2">&quot;Cmd-]&quot;</span><span class="o">:</span> <span class="s2">&quot;indentMore&quot;</span><span class="p">,</span>
    <span class="nx">fallthrough</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="s2">&quot;emacsy&quot;</span><span class="p">]</span>
  <span class="p">};</span>
  <span class="nx">keyMap</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mac</span> <span class="o">?</span> <span class="nx">keyMap</span><span class="p">.</span><span class="nx">macDefault</span> <span class="o">:</span> <span class="nx">keyMap</span><span class="p">.</span><span class="nx">pcDefault</span><span class="p">;</span>
  <span class="nx">keyMap</span><span class="p">.</span><span class="nx">emacsy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Ctrl-F&quot;</span><span class="o">:</span> <span class="s2">&quot;goCharRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-B&quot;</span><span class="o">:</span> <span class="s2">&quot;goCharLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-P&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineUp&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-N&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineDown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Alt-F&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordRight&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-B&quot;</span><span class="o">:</span> <span class="s2">&quot;goWordLeft&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-A&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineStart&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-E&quot;</span><span class="o">:</span> <span class="s2">&quot;goLineEnd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ctrl-V&quot;</span><span class="o">:</span> <span class="s2">&quot;goPageDown&quot;</span><span class="p">,</span> <span class="s2">&quot;Shift-Ctrl-V&quot;</span><span class="o">:</span> <span class="s2">&quot;goPageUp&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-D&quot;</span><span class="o">:</span> <span class="s2">&quot;delCharAfter&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-H&quot;</span><span class="o">:</span> <span class="s2">&quot;delCharBefore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Alt-D&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordAfter&quot;</span><span class="p">,</span> <span class="s2">&quot;Alt-Backspace&quot;</span><span class="o">:</span> <span class="s2">&quot;delWordBefore&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-K&quot;</span><span class="o">:</span> <span class="s2">&quot;killLine&quot;</span><span class="p">,</span> <span class="s2">&quot;Ctrl-T&quot;</span><span class="o">:</span> <span class="s2">&quot;transposeChars&quot;</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-144" id="section-144">&#182;</a>
</div>
<p>KEYMAP DISPATCH</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">getKeyMap</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">val</span><span class="p">];</span>
    <span class="k">else</span> <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lookupKey</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">maps</span><span class="p">,</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">map</span> <span class="o">=</span> <span class="nx">getKeyMap</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stop</span><span class="p">)</span> <span class="nx">stop</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">found</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">nofallthrough</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stop</span><span class="p">)</span> <span class="nx">stop</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">fallthrough</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">fallthrough</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">fallthrough</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">fallthrough</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;[object Array]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">fallthrough</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">fallthrough</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">fallthrough</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">maps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">maps</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">isModifierKey</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">e_prop</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="s2">&quot;keyCode&quot;</span><span class="p">)];</span>
    <span class="k">return</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Ctrl&quot;</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Alt&quot;</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Shift&quot;</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Mod&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">isModifierKey</span> <span class="o">=</span> <span class="nx">isModifierKey</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-145" id="section-145">&#182;</a>
</div>
<p>FROMTEXTAREA</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">fromTextArea</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">textarea</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">)</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabindex</span> <span class="o">&amp;&amp;</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">tabindex</span><span class="p">)</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">tabindex</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">tabindex</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-146" id="section-146">&#182;</a>
</div>
<p>Set autofocus to true if this textarea is focused, or if it has
autofocus and no other element is focused.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">autofocus</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">hasFocus</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-147" id="section-147">&#182;</a>
</div>
<p>doc.activeElement occasionally throws on IE</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">try</span> <span class="p">{</span> <span class="nx">hasFocus</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span><span class="p">;</span> <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">autofocus</span> <span class="o">=</span> <span class="nx">hasFocus</span> <span class="o">==</span> <span class="nx">textarea</span> <span class="o">||</span>
        <span class="nx">textarea</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;autofocus&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">hasFocus</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">save</span><span class="p">()</span> <span class="p">{</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-148" id="section-148">&#182;</a>
</div>
<p>Deplorable hack to make the submit method do the right thing.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">on</span><span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">,</span> <span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nx">save</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">,</span> <span class="nx">realSubmit</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">submit</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">wrappedSubmit</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">save</span><span class="p">();</span>
          <span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">realSubmit</span><span class="p">;</span>
          <span class="nx">form</span><span class="p">.</span><span class="nx">submit</span><span class="p">();</span>
          <span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">wrappedSubmit</span><span class="p">;</span>
        <span class="p">};</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="nx">textarea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cm</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">textarea</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">options</span><span class="p">);</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="nx">save</span><span class="p">;</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">getTextArea</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">textarea</span><span class="p">;</span> <span class="p">};</span>
    <span class="nx">cm</span><span class="p">.</span><span class="nx">toTextArea</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">save</span><span class="p">();</span>
      <span class="nx">textarea</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">getWrapperElement</span><span class="p">());</span>
      <span class="nx">textarea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">off</span><span class="p">(</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">,</span> <span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nx">save</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
          <span class="nx">textarea</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">realSubmit</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">cm</span><span class="p">;</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-149" id="section-149">&#182;</a>
</div>
<p>STRING STREAM</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-150" id="section-150">&#182;</a>
</div>
<p>Fed to the mode parsers, provides helper functions to make
parsers more succinct.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-151" id="section-151">&#182;</a>
</div>
<p>The character stream used by a mode's parser.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">StringStream</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">string</span> <span class="o">=</span> <span class="nx">string</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tabSize</span> <span class="o">=</span> <span class="nx">tabSize</span> <span class="o">||</span> <span class="mi">8</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">StringStream</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">eol</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;},</span>
    <span class="nx">sol</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;},</span>
    <span class="nx">peek</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span> <span class="o">||</span> <span class="kc">undefined</span><span class="p">;},</span>
    <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="o">++</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">eat</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">match</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="kd">var</span> <span class="nx">ok</span> <span class="o">=</span> <span class="nx">ch</span> <span class="o">==</span> <span class="nx">match</span><span class="p">;</span>
      <span class="k">else</span> <span class="kd">var</span> <span class="nx">ok</span> <span class="o">=</span> <span class="nx">ch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">test</span> <span class="o">?</span> <span class="nx">match</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">:</span> <span class="nx">match</span><span class="p">(</span><span class="nx">ch</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span><span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span> <span class="k">return</span> <span class="nx">ch</span><span class="p">;}</span>
    <span class="p">},</span>
    <span class="nx">eatWhile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eat</span><span class="p">(</span><span class="nx">match</span><span class="p">)){}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">start</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">eatSpace</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="sr">/[\s\u00a0]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">)))</span> <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">start</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">skipToEnd</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;},</span>
    <span class="nx">skipTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">found</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="nx">found</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;}</span>
    <span class="p">},</span>
    <span class="nx">backUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;},</span>
    <span class="nx">column</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">countColumn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);},</span>
    <span class="nx">indentation</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">countColumn</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);},</span>
    <span class="nx">match</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">consume</span><span class="p">,</span> <span class="nx">caseInsensitive</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pattern</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cased</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">caseInsensitive</span> <span class="o">?</span> <span class="nx">str</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">:</span> <span class="nx">str</span><span class="p">;};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cased</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">cased</span><span class="p">(</span><span class="nx">pattern</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">consume</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">&amp;&amp;</span> <span class="nx">consume</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">current</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">);}</span>
  <span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">StringStream</span> <span class="o">=</span> <span class="nx">StringStream</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-152" id="section-152">&#182;</a>
</div>
<p>TEXTMARKERS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">TextMarker</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cm</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">TextMarker</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">explicitlyCleared</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">startOperation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cm</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">min</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">max</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">getMarkedSpanFor</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
      <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span> <span class="o">=</span> <span class="nx">removeMarkedSpan</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">,</span> <span class="nx">span</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
        <span class="nx">min</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collapsed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">lineIsHidden</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span>
        <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">textHeight</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">min</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">regChange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">min</span><span class="p">,</span> <span class="nx">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">explicitlyCleared</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collapsed</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">cantEdit</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">cantEdit</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">reCheckSelection</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cm</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">endOperation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cm</span><span class="p">);</span>
    <span class="nx">signalLater</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cm</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s2">&quot;clear&quot;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">TextMarker</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">getMarkedSpanFor</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">from</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span><span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">to</span> <span class="o">=</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span><span class="p">};</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;bookmark&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">from</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">};</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">markText</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextMarker</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;range&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">))</span> <span class="k">return</span> <span class="nx">marker</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">opt</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">opt</span><span class="p">))</span>
      <span class="nx">marker</span><span class="p">[</span><span class="nx">opt</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">opt</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">replacedWith</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">marker</span><span class="p">.</span><span class="nx">replacedWith</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">marker</span><span class="p">.</span><span class="nx">replacedWith</span><span class="p">],</span> <span class="s2">&quot;CodeMirror-widget&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span><span class="p">)</span> <span class="nx">sawCollapsedSpans</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">curLine</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">collapsedAtStart</span><span class="p">,</span> <span class="nx">collapsedAtEnd</span><span class="p">;</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">curLine</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">};</span>
      <span class="nx">size</span> <span class="o">+=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">curLine</span> <span class="o">==</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span><span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span> <span class="nx">size</span> <span class="o">-=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">;}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">curLine</span> <span class="o">==</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span><span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">;</span> <span class="nx">size</span> <span class="o">-=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">;}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">curLine</span> <span class="o">==</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="nx">collapsedAtEnd</span> <span class="o">=</span> <span class="nx">collapsedSpanAt</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">curLine</span> <span class="o">==</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span> <span class="nx">collapsedAtStart</span> <span class="o">=</span> <span class="nx">collapsedSpanAt</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">ch</span><span class="p">);</span>
        <span class="k">else</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">addMarkedSpan</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">span</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span> <span class="o">&amp;&amp;</span> <span class="nx">curLine</span> <span class="o">==</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span> <span class="o">&amp;&amp;</span> <span class="nx">lineIsHidden</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span>
        <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="o">++</span><span class="nx">curLine</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">readOnly</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sawReadOnlySpans</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">undone</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">cm</span><span class="p">.</span><span class="nx">clearHistory</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">collapsedAtStart</span> <span class="o">!=</span> <span class="nx">collapsedAtEnd</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Inserting collapsed marker overlapping an existing one&quot;</span><span class="p">);</span>
      <span class="nx">marker</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>
      <span class="nx">marker</span><span class="p">.</span><span class="nx">atomic</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">className</span> <span class="o">||</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">startStyle</span> <span class="o">||</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">endStyle</span> <span class="o">||</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span><span class="p">)</span>
      <span class="nx">regChange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">atomic</span><span class="p">)</span> <span class="nx">reCheckSelection</span><span class="p">(</span><span class="nx">cm</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">marker</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-153" id="section-153">&#182;</a>
</div>
<p>TEXTMARKER SPANS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">getMarkedSpanFor</span><span class="p">(</span><span class="nx">spans</span><span class="p">,</span> <span class="nx">marker</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">spans</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">spans</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">marker</span> <span class="o">==</span> <span class="nx">marker</span><span class="p">)</span> <span class="k">return</span> <span class="nx">span</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">removeMarkedSpan</span><span class="p">(</span><span class="nx">spans</span><span class="p">,</span> <span class="nx">span</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">spans</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">span</span><span class="p">)</span> <span class="p">(</span><span class="nx">r</span> <span class="o">||</span> <span class="p">(</span><span class="nx">r</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">spans</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">addMarkedSpan</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">span</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span> <span class="o">?</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">span</span><span class="p">])</span> <span class="o">:</span> <span class="p">[</span><span class="nx">span</span><span class="p">];</span>
    <span class="nx">span</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">markedSpansBefore</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">startCh</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">old</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">nw</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">old</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">startsBefore</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">inclusiveLeft</span> <span class="o">?</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">startCh</span> <span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">startCh</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">startsBefore</span> <span class="o">||</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;bookmark&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="nx">startCh</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">endsAfter</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">inclusiveRight</span> <span class="o">?</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;=</span> <span class="nx">startCh</span> <span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">startCh</span><span class="p">);</span>
        <span class="p">(</span><span class="nx">nw</span> <span class="o">||</span> <span class="p">(</span><span class="nx">nw</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span>
                                <span class="nx">to</span><span class="o">:</span> <span class="nx">endsAfter</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span>
                                <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nw</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">markedSpansAfter</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">startCh</span><span class="p">,</span> <span class="nx">endCh</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">old</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">nw</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">old</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">endsAfter</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">inclusiveRight</span> <span class="o">?</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;=</span> <span class="nx">endCh</span> <span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">endCh</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">endsAfter</span> <span class="o">||</span> <span class="nx">marker</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;bookmark&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="nx">endCh</span> <span class="o">&amp;&amp;</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="nx">startCh</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">startsBefore</span> <span class="o">=</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="p">(</span><span class="nx">marker</span><span class="p">.</span><span class="nx">inclusiveLeft</span> <span class="o">?</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">endCh</span> <span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">endCh</span><span class="p">);</span>
        <span class="p">(</span><span class="nx">nw</span> <span class="o">||</span> <span class="p">(</span><span class="nx">nw</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">startsBefore</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">-</span> <span class="nx">endCh</span><span class="p">,</span>
                                <span class="nx">to</span><span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="nx">endCh</span><span class="p">,</span>
                                <span class="nx">marker</span><span class="o">:</span> <span class="nx">marker</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nw</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateMarkedSpans</span><span class="p">(</span><span class="nx">oldFirst</span><span class="p">,</span> <span class="nx">oldLast</span><span class="p">,</span> <span class="nx">startCh</span><span class="p">,</span> <span class="nx">endCh</span><span class="p">,</span> <span class="nx">newText</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">oldFirst</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">oldLast</span><span class="p">)</span> <span class="k">return</span> <span class="nx">newText</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-154" id="section-154">&#182;</a>
</div>
<p>Get the spans that 'stick out' on both sides</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">markedSpansBefore</span><span class="p">(</span><span class="nx">oldFirst</span><span class="p">,</span> <span class="nx">startCh</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">markedSpansAfter</span><span class="p">(</span><span class="nx">oldLast</span><span class="p">,</span> <span class="nx">startCh</span><span class="p">,</span> <span class="nx">endCh</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-155" id="section-155">&#182;</a>
</div>
<p>Next, merge those two ends</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">sameLine</span> <span class="o">=</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">lst</span><span class="p">(</span><span class="nx">newText</span><span class="p">).</span><span class="nx">length</span> <span class="o">+</span> <span class="p">(</span><span class="nx">sameLine</span> <span class="o">?</span> <span class="nx">startCh</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">first</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-156" id="section-156">&#182;</a>
</div>
<p>Fix up .to properties of first</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">first</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">first</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">getMarkedSpanFor</span><span class="p">(</span><span class="nx">last</span><span class="p">,</span> <span class="nx">span</span><span class="p">.</span><span class="nx">marker</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">startCh</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sameLine</span><span class="p">)</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">=</span> <span class="nx">found</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">found</span><span class="p">.</span><span class="nx">to</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-157" id="section-157">&#182;</a>
</div>
<p>Fix up .from in last (or move them into first in case of sameLine)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">last</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">last</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">+=</span> <span class="nx">offset</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">getMarkedSpanFor</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">span</span><span class="p">.</span><span class="nx">marker</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sameLine</span><span class="p">)</span> <span class="p">(</span><span class="nx">first</span> <span class="o">||</span> <span class="p">(</span><span class="nx">first</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">span</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">span</span><span class="p">.</span><span class="nx">from</span> <span class="o">+=</span> <span class="nx">offset</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sameLine</span><span class="p">)</span> <span class="p">(</span><span class="nx">first</span> <span class="o">||</span> <span class="p">(</span><span class="nx">first</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">span</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">newMarkers</span> <span class="o">=</span> <span class="p">[</span><span class="nx">newHL</span><span class="p">(</span><span class="nx">newText</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">first</span><span class="p">)];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sameLine</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-158" id="section-158">&#182;</a>
</div>
<p>Fill gap with whole-line-spans</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">gap</span> <span class="o">=</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">gapMarkers</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">first</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">first</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">first</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
            <span class="p">(</span><span class="nx">gapMarkers</span> <span class="o">||</span> <span class="p">(</span><span class="nx">gapMarkers</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">marker</span><span class="o">:</span> <span class="nx">first</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">marker</span><span class="p">});</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">gap</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="nx">newMarkers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newHL</span><span class="p">(</span><span class="nx">newText</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nx">gapMarkers</span><span class="p">));</span>
      <span class="nx">newMarkers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newHL</span><span class="p">(</span><span class="nx">lst</span><span class="p">(</span><span class="nx">newText</span><span class="p">),</span> <span class="nx">last</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">newMarkers</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">removeReadOnlyRanges</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">markers</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span> <span class="nx">to</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mark</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">marker</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mark</span><span class="p">.</span><span class="nx">readOnly</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">markers</span> <span class="o">||</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">markers</span><span class="p">,</span> <span class="nx">mark</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
          <span class="p">(</span><span class="nx">markers</span> <span class="o">||</span> <span class="p">(</span><span class="nx">markers</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">mark</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">markers</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="p">[{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">to</span><span class="p">}];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">markers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">markers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">find</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="o">||</span> <span class="nx">posLess</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">from</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">newParts</span> <span class="o">=</span> <span class="p">[</span><span class="nx">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">from</span><span class="p">))</span> <span class="nx">newParts</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">from</span><span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">posLess</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span> <span class="nx">newParts</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">to</span><span class="p">});</span>
        <span class="nx">parts</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">parts</span><span class="p">,</span> <span class="nx">newParts</span><span class="p">);</span>
        <span class="nx">j</span> <span class="o">+=</span> <span class="nx">newParts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">parts</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">collapsedSpanAt</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sps</span> <span class="o">=</span> <span class="nx">sawCollapsedSpans</span> <span class="o">&amp;&amp;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">,</span> <span class="nx">found</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sps</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">sp</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sp</span> <span class="o">=</span> <span class="nx">sps</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">ch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">ch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="o">!</span><span class="nx">found</span> <span class="o">||</span> <span class="nx">found</span><span class="p">.</span><span class="nx">width</span> <span class="o">&lt;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">width</span><span class="p">))</span>
        <span class="nx">found</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">collapsedSpanAtStart</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">collapsedSpanAt</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">collapsedSpanAtEnd</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">collapsedSpanAt</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">visualLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">merged</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">merged</span> <span class="o">=</span> <span class="nx">collapsedSpanAtStart</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span>
      <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lineIsHidden</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sps</span> <span class="o">=</span> <span class="nx">sawCollapsedSpans</span> <span class="o">&amp;&amp;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sps</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">sp</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sps</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sp</span> <span class="o">=</span> <span class="nx">sps</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">inclusiveLeft</span> <span class="o">&amp;&amp;</span> <span class="nx">lineIsHiddenInner</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">sp</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">lineIsHidden</span> <span class="o">=</span> <span class="nx">lineIsHidden</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">lineIsHiddenInner</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">span</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">span</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">inclusiveRight</span> <span class="o">&amp;&amp;</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">sp</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sp</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">collapsed</span> <span class="o">&amp;&amp;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="nx">span</span><span class="p">.</span><span class="nx">to</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">inclusiveLeft</span> <span class="o">||</span> <span class="nx">span</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">inclusiveRight</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="nx">lineIsHiddenInner</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">sp</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-159" id="section-159">&#182;</a>
</div>
<p>hl stands for history-line, a data structure that can be either a
string (line without markers) or a {text, markedSpans} object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">hlText</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">?</span> <span class="nx">val</span> <span class="o">:</span> <span class="nx">val</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">hlSpans</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">spans</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">,</span> <span class="nx">out</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">spans</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">marker</span><span class="p">.</span><span class="nx">explicitlyCleared</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">out</span><span class="p">)</span> <span class="nx">out</span> <span class="o">=</span> <span class="nx">spans</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">out</span><span class="p">)</span> <span class="nx">out</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">spans</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">out</span> <span class="o">?</span> <span class="nx">spans</span> <span class="o">:</span> <span class="nx">out</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">out</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">newHL</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">spans</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">spans</span> <span class="o">?</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">markedSpans</span><span class="o">:</span> <span class="nx">spans</span><span class="p">}</span> <span class="o">:</span> <span class="nx">text</span><span class="p">;</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">detachMarkedSpans</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">spans</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">spans</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="nx">spans</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">marker</span><span class="p">.</span><span class="nx">lines</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">ix</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">lines</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
      <span class="nx">lines</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">ix</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attachMarkedSpans</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">spans</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">spans</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">spans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="nx">spans</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">marker</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
    <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span> <span class="o">=</span> <span class="nx">spans</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-160" id="section-160">&#182;</a>
</div>
<p>LINE DATA STRUCTURE</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-161" id="section-161">&#182;</a>
</div>
<p>Line objects. These hold state related to a line, including
highlighting info (the styles array).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">makeLine</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">markedSpans</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">height</span><span class="p">};</span>
    <span class="nx">attachMarkedSpans</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">markedSpans</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lineIsHidden</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">markedSpans</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">line</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
    <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">styles</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">order</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">line</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">detachMarkedSpans</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
    <span class="nx">attachMarkedSpans</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">markedSpans</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lineIsHidden</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">textHeight</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">);</span>
    <span class="nx">signalLater</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="s2">&quot;change&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">cleanUpLine</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">line</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">detachMarkedSpans</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-162" id="section-162">&#182;</a>
</div>
<p>Run the given mode's parser over a line, update the styles
array, which contains alternating fragments of text and CSS
classes.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">highlightLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">flattenSpans</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">flattenSpans</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">curText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">curStyle</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StringStream</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">),</span> <span class="nx">st</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">styles</span> <span class="o">||</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">styles</span> <span class="o">=</span> <span class="p">[]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">blankLine</span><span class="p">)</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">blankLine</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">eol</span><span class="p">())</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">token</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">state</span><span class="p">),</span> <span class="nx">substr</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">flattenSpans</span> <span class="o">||</span> <span class="nx">curStyle</span> <span class="o">!=</span> <span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">curText</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">changed</span> <span class="o">=</span> <span class="nx">changed</span> <span class="o">||</span> <span class="nx">pos</span> <span class="o">&gt;=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">curText</span> <span class="o">!=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span> <span class="o">||</span> <span class="nx">curStyle</span> <span class="o">!=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
          <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">curText</span><span class="p">;</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">curStyle</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">curText</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">;</span> <span class="nx">curStyle</span> <span class="o">=</span> <span class="nx">style</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nx">curText</span> <span class="o">=</span> <span class="nx">curText</span> <span class="o">+</span> <span class="nx">substr</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-163" id="section-163">&#182;</a>
</div>
<p>Give up when line is ridiculously long</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">curText</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">changed</span> <span class="o">=</span> <span class="nx">changed</span> <span class="o">||</span> <span class="nx">pos</span> <span class="o">&gt;=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">curText</span> <span class="o">!=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="p">]</span> <span class="o">||</span> <span class="nx">curStyle</span> <span class="o">!=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">curText</span><span class="p">;</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">curStyle</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span> <span class="nx">st</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">!=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> <span class="nx">st</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">changed</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-164" id="section-164">&#182;</a>
</div>
<p>Lightweight form of highlight -- proceed over this line and
update state, but don't save a style array.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">processLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">mode</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StringStream</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">blankLine</span><span class="p">)</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">blankLine</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">stream</span><span class="p">.</span><span class="nx">eol</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span> <span class="o">&lt;=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">mode</span><span class="p">.</span><span class="nx">token</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">pos</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">styleToClassCache</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">function</span> <span class="nx">styleToClass</span><span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">style</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">styleToClassCache</span><span class="p">[</span><span class="nx">style</span><span class="p">]</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">styleToClassCache</span><span class="p">[</span><span class="nx">style</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cm-&quot;</span> <span class="o">+</span> <span class="nx">style</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ +/g</span><span class="p">,</span> <span class="s2">&quot; cm-&quot;</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lineContent</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">realLine</span><span class="p">,</span> <span class="nx">measure</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">merged</span><span class="p">,</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">realLine</span><span class="p">,</span> <span class="nx">lineBefore</span><span class="p">,</span> <span class="nx">sawBefore</span><span class="p">,</span> <span class="nx">simple</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">merged</span> <span class="o">=</span> <span class="nx">collapsedSpanAtStart</span><span class="p">(</span><span class="nx">line</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">simple</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">from</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lineBefore</span><span class="p">)</span> <span class="nx">lineBefore</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="p">{</span><span class="nx">pre</span><span class="o">:</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">),</span> <span class="nx">col</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">display</span><span class="o">:</span> <span class="o">!</span><span class="nx">measure</span><span class="p">,</span>
                   <span class="nx">measure</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">addedOne</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">cm</span><span class="o">:</span> <span class="nx">cm</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">textClass</span><span class="p">)</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">textClass</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">styles</span><span class="p">)</span>
        <span class="nx">highlightLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">line</span><span class="p">.</span><span class="nx">stateAfter</span> <span class="o">=</span> <span class="nx">getStateBefore</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">)));</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">measure</span> <span class="o">=</span> <span class="nx">line</span> <span class="o">==</span> <span class="nx">realLine</span> <span class="o">&amp;&amp;</span> <span class="nx">measure</span><span class="p">;</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">addToken</span> <span class="o">=</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">measure</span> <span class="o">?</span> <span class="nx">buildTokenMeasure</span> <span class="o">:</span> <span class="nx">buildToken</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">measure</span> <span class="o">&amp;&amp;</span> <span class="nx">sawBefore</span> <span class="o">&amp;&amp;</span> <span class="nx">line</span> <span class="o">!=</span> <span class="nx">realLine</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">builder</span><span class="p">.</span><span class="nx">addedOne</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">measure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">zeroWidthElement</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">measure</span><span class="p">));</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nx">addedOne</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">insertLineContent</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">builder</span><span class="p">);</span>
      <span class="nx">sawBefore</span> <span class="o">=</span> <span class="nx">line</span> <span class="o">==</span> <span class="nx">lineBefore</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">next</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">);</span>
        <span class="nx">simple</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">next</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">measure</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">builder</span><span class="p">.</span><span class="nx">addedOne</span><span class="p">)</span>
      <span class="nx">measure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">simple</span> <span class="o">?</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="s2">&quot;\u00a0&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">zeroWidthElement</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">measure</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">lineIsHidden</span><span class="p">(</span><span class="nx">realLine</span><span class="p">))</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s2">&quot;\u00a0&quot;</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">tokenSpecialChars</span> <span class="o">=</span> <span class="sr">/[\t\u0000-\u0019\u200b\u2028\u2029\uFEFF]/g</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">buildToken</span><span class="p">(</span><span class="nx">builder</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">style</span><span class="p">,</span> <span class="nx">startStyle</span><span class="p">,</span> <span class="nx">endStyle</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">text</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tokenSpecialChars</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">col</span> <span class="o">+=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createDocumentFragment</span><span class="p">(),</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tokenSpecialChars</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">tokenSpecialChars</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">skipped</span> <span class="o">=</span> <span class="nx">m</span> <span class="o">?</span> <span class="nx">m</span><span class="p">.</span><span class="nx">index</span> <span class="o">-</span> <span class="nx">pos</span> <span class="o">:</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">skipped</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">content</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">skipped</span><span class="p">)));</span>
          <span class="nx">builder</span><span class="p">.</span><span class="nx">col</span> <span class="o">+=</span> <span class="nx">skipped</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">m</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">skipped</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;\t&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">tabSize</span> <span class="o">=</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">tabSize</span><span class="p">,</span> <span class="nx">tabWidth</span> <span class="o">=</span> <span class="nx">tabSize</span> <span class="o">-</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">col</span> <span class="o">%</span> <span class="nx">tabSize</span><span class="p">;</span>
          <span class="nx">content</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="nx">spaceStr</span><span class="p">(</span><span class="nx">tabWidth</span><span class="p">),</span> <span class="s2">&quot;cm-tab&quot;</span><span class="p">));</span>
          <span class="nx">builder</span><span class="p">.</span><span class="nx">col</span> <span class="o">+=</span> <span class="nx">tabWidth</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="s2">&quot;\u2022&quot;</span><span class="p">,</span> <span class="s2">&quot;cm-invalidchar&quot;</span><span class="p">);</span>
          <span class="nx">token</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;\\u&quot;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
          <span class="nx">content</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
          <span class="nx">builder</span><span class="p">.</span><span class="nx">col</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">style</span> <span class="o">||</span> <span class="nx">startStyle</span> <span class="o">||</span> <span class="nx">endStyle</span> <span class="o">||</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">measure</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">fullStyle</span> <span class="o">=</span> <span class="nx">style</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">startStyle</span><span class="p">)</span> <span class="nx">fullStyle</span> <span class="o">+=</span> <span class="nx">startStyle</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">endStyle</span><span class="p">)</span> <span class="nx">fullStyle</span> <span class="o">+=</span> <span class="nx">endStyle</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">content</span><span class="p">],</span> <span class="nx">fullStyle</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">buildTokenMeasure</span><span class="p">(</span><span class="nx">builder</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">style</span><span class="p">,</span> <span class="nx">startStyle</span><span class="p">,</span> <span class="nx">endStyle</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
          <span class="nx">builder</span><span class="p">.</span><span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lineWrapping</span> <span class="o">&amp;&amp;</span>
          <span class="nx">spanAffectsWrapping</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;wbr&quot;</span><span class="p">));</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">measure</span><span class="p">[</span><span class="nx">builder</span><span class="p">.</span><span class="nx">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
        <span class="nx">buildToken</span><span class="p">(</span><span class="nx">builder</span><span class="p">,</span> <span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">style</span><span class="p">,</span>
                   <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">startStyle</span><span class="p">,</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">endStyle</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">addedOne</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">buildCollapsedSpan</span><span class="p">(</span><span class="nx">builder</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">widget</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">widget</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">builder</span><span class="p">.</span><span class="nx">display</span><span class="p">)</span> <span class="nx">widget</span> <span class="o">=</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">widget</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">builder</span><span class="p">.</span><span class="nx">measure</span> <span class="o">&amp;&amp;</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nx">measure</span><span class="p">[</span><span class="nx">builder</span><span class="p">.</span><span class="nx">pos</span><span class="p">]</span> <span class="o">=</span> <span class="nx">widget</span><span class="p">;</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nx">addedOne</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+=</span> <span class="nx">size</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-165" id="section-165">&#182;</a>
</div>
<p>Outputs a number of spans to make up a line, taking highlighting
and marked text into account.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">insertLineContent</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">builder</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">st</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">styles</span><span class="p">,</span> <span class="nx">spans</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">markedSpans</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">spans</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">st</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nx">addToken</span><span class="p">(</span><span class="nx">builder</span><span class="p">,</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">styleToClass</span><span class="p">(</span><span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]));</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">allText</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">allText</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">style</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">nextChange</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">spanStyle</span><span class="p">,</span> <span class="nx">spanEndStyle</span><span class="p">,</span> <span class="nx">spanStartStyle</span><span class="p">,</span> <span class="nx">collapsed</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">nextChange</span> <span class="o">==</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Update current marker set</span>
        <span class="nx">spanStyle</span> <span class="o">=</span> <span class="nx">spanEndStyle</span> <span class="o">=</span> <span class="nx">spanStartStyle</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="nx">collapsed</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">nextChange</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">foundBookmark</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">spans</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">sp</span> <span class="o">=</span> <span class="nx">spans</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">marker</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">pos</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">pos</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">nextChange</span> <span class="o">&gt;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="p">{</span> <span class="nx">nextChange</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span> <span class="nx">spanEndStyle</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">className</span><span class="p">)</span> <span class="nx">spanStyle</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">className</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">startStyle</span> <span class="o">&amp;&amp;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="nx">pos</span><span class="p">)</span> <span class="nx">spanStartStyle</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">startStyle</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">endStyle</span> <span class="o">&amp;&amp;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="nx">nextChange</span><span class="p">)</span> <span class="nx">spanEndStyle</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">endStyle</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">collapsed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">collapsed</span> <span class="o">||</span> <span class="nx">collapsed</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">width</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">width</span><span class="p">))</span>
              <span class="nx">collapsed</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">&gt;</span> <span class="nx">pos</span> <span class="o">&amp;&amp;</span> <span class="nx">nextChange</span> <span class="o">&gt;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nextChange</span> <span class="o">=</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;bookmark&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">sp</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="nx">pos</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">replacedWith</span><span class="p">)</span>
            <span class="nx">foundBookmark</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">replacedWith</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">collapsed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">collapsed</span><span class="p">.</span><span class="nx">from</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">buildCollapsedSpan</span><span class="p">(</span><span class="nx">builder</span><span class="p">,</span> <span class="p">(</span><span class="nx">collapsed</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">len</span> <span class="o">:</span> <span class="nx">collapsed</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">,</span>
                             <span class="nx">collapsed</span><span class="p">.</span><span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">collapsed</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">replacedWith</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">collapsed</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">collapsed</span><span class="p">.</span><span class="nx">marker</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">foundBookmark</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">collapsed</span><span class="p">)</span> <span class="nx">buildCollapsedSpan</span><span class="p">(</span><span class="nx">builder</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">foundBookmark</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&gt;=</span> <span class="nx">len</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">upto</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">len</span><span class="p">,</span> <span class="nx">nextChange</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">collapsed</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">tokenText</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">upto</span> <span class="o">?</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">upto</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">)</span> <span class="o">:</span> <span class="nx">text</span><span class="p">;</span>
            <span class="nx">builder</span><span class="p">.</span><span class="nx">addToken</span><span class="p">(</span><span class="nx">builder</span><span class="p">,</span> <span class="nx">tokenText</span><span class="p">,</span> <span class="nx">style</span> <span class="o">+</span> <span class="nx">spanStyle</span><span class="p">,</span>
                             <span class="nx">spanStartStyle</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">tokenText</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">nextChange</span> <span class="o">?</span> <span class="nx">spanEndStyle</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&gt;=</span> <span class="nx">upto</span><span class="p">)</span> <span class="p">{</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">upto</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">);</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">upto</span><span class="p">;</span> <span class="k">break</span><span class="p">;}</span>
          <span class="nx">pos</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
          <span class="nx">spanStartStyle</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">text</span> <span class="o">=</span> <span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">styleToClass</span><span class="p">(</span><span class="nx">st</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-166" id="section-166">&#182;</a>
</div>
<p>DOCUMENT DATA STRUCTURE</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">LeafChunk</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">height</span> <span class="o">+=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">height</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">LeafChunk</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">chunkSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">cm</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">at</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">at</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
        <span class="nx">cleanUpLine</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
        <span class="nx">signalLater</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">collapse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">lines</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">lines</span><span class="p">,</span> <span class="p">[</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">insertHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">height</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">at</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">lines</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">at</span><span class="p">));</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">iterN</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">at</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">at</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">at</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">op</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">at</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">BranchChunk</span><span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">children</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">size</span> <span class="o">+=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span> <span class="nx">height</span> <span class="o">+=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="nx">ch</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">BranchChunk</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">chunkSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">-=</span> <span class="nx">n</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">at</span> <span class="o">&lt;</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">rm</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">sz</span> <span class="o">-</span> <span class="nx">at</span><span class="p">),</span> <span class="nx">oldHeight</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
          <span class="nx">child</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">rm</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">oldHeight</span> <span class="o">-</span> <span class="nx">child</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">sz</span> <span class="o">==</span> <span class="nx">rm</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="nx">child</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">n</span> <span class="o">-=</span> <span class="nx">rm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="nx">at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nx">at</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">collapse</span><span class="p">(</span><span class="nx">lines</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="k">new</span> <span class="nx">LeafChunk</span><span class="p">(</span><span class="nx">lines</span><span class="p">)];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">collapse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">collapse</span><span class="p">(</span><span class="nx">lines</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">insert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">height</span> <span class="o">+=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">height</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">insertHeight</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">insertHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">+=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">height</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">at</span> <span class="o">&lt;=</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">child</span><span class="p">.</span><span class="nx">insertHeight</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">lines</span> <span class="o">&amp;&amp;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">spilled</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
              <span class="kd">var</span> <span class="nx">newleaf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LeafChunk</span><span class="p">(</span><span class="nx">spilled</span><span class="p">);</span>
              <span class="nx">child</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">newleaf</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">newleaf</span><span class="p">);</span>
              <span class="nx">newleaf</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">maybeSpill</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">at</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">maybeSpill</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">spilled</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">sibling</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BranchChunk</span><span class="p">(</span><span class="nx">spilled</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Become the parent node</span>
          <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BranchChunk</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
          <span class="nx">copy</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">me</span><span class="p">;</span>
          <span class="nx">me</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">copy</span><span class="p">,</span> <span class="nx">sibling</span><span class="p">];</span>
          <span class="nx">me</span> <span class="o">=</span> <span class="nx">copy</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">me</span><span class="p">.</span><span class="nx">size</span> <span class="o">-=</span> <span class="nx">sibling</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
          <span class="nx">me</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">sibling</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">myIndex</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="nx">me</span><span class="p">);</span>
          <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">myIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sibling</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">sibling</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">maybeSpill</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">iter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">op</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">iterN</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span> <span class="o">-</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">op</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">iterN</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">op</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">at</span> <span class="o">&lt;</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">used</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">sz</span> <span class="o">-</span> <span class="nx">at</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">iterN</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="nx">used</span><span class="p">,</span> <span class="nx">op</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">n</span> <span class="o">-=</span> <span class="nx">used</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="nx">at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nx">at</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-167" id="section-167">&#182;</a>
</div>
<p>LINE UTILITIES</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sz</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">sz</span><span class="p">)</span> <span class="p">{</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">n</span> <span class="o">-=</span> <span class="nx">sz</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateLineHeight</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">-</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">line</span><span class="p">;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="nx">n</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">diff</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">no</span> <span class="o">=</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">lines</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span> <span class="nx">chunk</span><span class="p">;</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">,</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">cur</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="nx">no</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">chunkSize</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">no</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lineAtHeight</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">outer</span><span class="o">:</span> <span class="k">do</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">ch</span> <span class="o">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="k">continue</span> <span class="nx">outer</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">h</span> <span class="o">-=</span> <span class="nx">ch</span><span class="p">;</span>
        <span class="nx">n</span> <span class="o">+=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">lh</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="nx">lh</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="nx">h</span> <span class="o">-=</span> <span class="nx">lh</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">n</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">heightAtLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">lineObj</span> <span class="o">=</span> <span class="nx">visualLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">lineObj</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">lineObj</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">line</span> <span class="o">==</span> <span class="nx">lineObj</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">h</span> <span class="o">+=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span> <span class="nx">p</span><span class="p">;</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">==</span> <span class="nx">chunk</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">else</span> <span class="nx">h</span> <span class="o">+=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">h</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">order</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">order</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="nx">bidiOrdering</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">order</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-168" id="section-168">&#182;</a>
</div>
<p>HISTORY</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">makeHistory</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-169" id="section-169">&#182;</a>
</div>
<p>Arrays of history events. Doing something adds an event to
done and clears undo. Undoing moves events from done to
undone, redoing moves them in the other direction.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">done</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">undone</span><span class="o">:</span> <span class="p">[],</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-170" id="section-170">&#182;</a>
</div>
<p>Used to track when changes can be merged into a single undo
event</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">lastTime</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">lastOp</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">lastOrigin</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-171" id="section-171">&#182;</a>
</div>
<p>Used by the isClean() method</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">dirtyCounter</span><span class="o">:</span> <span class="mi">0</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">addChange</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">fromBefore</span><span class="p">,</span> <span class="nx">toBefore</span><span class="p">,</span> <span class="nx">fromAfter</span><span class="p">,</span> <span class="nx">toAfter</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">history</span><span class="p">;</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">undone</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">,</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">lst</span><span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">lastOp</span> <span class="o">==</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span>
         <span class="nx">history</span><span class="p">.</span><span class="nx">lastOrigin</span> <span class="o">==</span> <span class="nx">origin</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">origin</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span> <span class="o">||</span> <span class="nx">origin</span> <span class="o">==</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="nx">history</span><span class="p">.</span><span class="nx">lastTime</span> <span class="o">&gt;</span> <span class="nx">time</span> <span class="o">-</span> <span class="mi">600</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-172" id="section-172">&#182;</a>
</div>
<p>Merge this change into the last event</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">lst</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">events</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">&gt;</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">old</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">last</span><span class="p">.</span><span class="nx">added</span> <span class="o">&lt;</span> <span class="nx">start</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-173" id="section-173">&#182;</a>
</div>
<p>Doesn't intersect with last sub-event, add new sub-event</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">cur</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">start</span><span class="o">:</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">added</span><span class="o">:</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">old</span><span class="o">:</span> <span class="nx">old</span><span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-174" id="section-174">&#182;</a>
</div>
<p>Patch up the last sub-event</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">startBefore</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">-</span> <span class="nx">start</span><span class="p">),</span>
        <span class="nx">endAfter</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">old</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">last</span><span class="p">.</span><span class="nx">added</span><span class="p">));</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">startBefore</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="nx">last</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">old</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">endAfter</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="nx">last</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">old</span><span class="p">[</span><span class="nx">old</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">startBefore</span><span class="p">)</span> <span class="nx">last</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
        <span class="nx">last</span><span class="p">.</span><span class="nx">added</span> <span class="o">+=</span> <span class="nx">added</span> <span class="o">-</span> <span class="p">(</span><span class="nx">old</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">startBefore</span> <span class="o">-</span> <span class="nx">endAfter</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">cur</span><span class="p">.</span><span class="nx">fromAfter</span> <span class="o">=</span> <span class="nx">fromAfter</span><span class="p">;</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">toAfter</span> <span class="o">=</span> <span class="nx">toAfter</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-175" id="section-175">&#182;</a>
</div>
<p>Can not be merged, start a new event.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">cur</span> <span class="o">=</span> <span class="p">{</span><span class="nx">events</span><span class="o">:</span> <span class="p">[{</span><span class="nx">start</span><span class="o">:</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">added</span><span class="o">:</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">old</span><span class="o">:</span> <span class="nx">old</span><span class="p">}],</span>
             <span class="nx">fromBefore</span><span class="o">:</span> <span class="nx">fromBefore</span><span class="p">,</span> <span class="nx">toBefore</span><span class="o">:</span> <span class="nx">toBefore</span><span class="p">,</span> <span class="nx">fromAfter</span><span class="o">:</span> <span class="nx">fromAfter</span><span class="p">,</span> <span class="nx">toAfter</span><span class="o">:</span> <span class="nx">toAfter</span><span class="p">};</span>
      <span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">undoDepth</span><span class="p">)</span>
        <span class="nx">history</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">dirtyCounter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-176" id="section-176">&#182;</a>
</div>
<p>The user has made a change after undoing past the last clean state. 
We can never get back to a clean state now until markClean() is called.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">history</span><span class="p">.</span><span class="nx">dirtyCounter</span> <span class="o">=</span> <span class="kc">NaN</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="nx">history</span><span class="p">.</span><span class="nx">dirtyCounter</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">lastTime</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">lastOp</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">lastOrigin</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-177" id="section-177">&#182;</a>
</div>
<p>EVENT OPERATORS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">stopMethod</span><span class="p">()</span> <span class="p">{</span><span class="nx">e_stop</span><span class="p">(</span><span class="k">this</span><span class="p">);}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-178" id="section-178">&#182;</a>
</div>
<p>Ensure an event has a stop method.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">addStop</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">stop</span><span class="p">)</span> <span class="nx">event</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="nx">stopMethod</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">event</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="k">else</span> <span class="nx">e</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">e_stopPropagation</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
    <span class="k">else</span> <span class="nx">e</span><span class="p">.</span><span class="nx">cancelBubble</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">e_stop</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="nx">e_preventDefault</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">e_stopPropagation</span><span class="p">(</span><span class="nx">e</span><span class="p">);}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">e_stop</span> <span class="o">=</span> <span class="nx">e_stop</span><span class="p">;</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">e_preventDefault</span> <span class="o">=</span> <span class="nx">e_preventDefault</span><span class="p">;</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">e_stopPropagation</span> <span class="o">=</span> <span class="nx">e_stopPropagation</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">e_target</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">;}</span>
  <span class="kd">function</span> <span class="nx">e_button</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mac</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-179" id="section-179">&#182;</a>
</div>
<p>Allow 3rd-party code to override event properties by adding an override
object to an event object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">e_prop</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">overridden</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">override</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">override</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">overridden</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">override</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">:</span> <span class="nx">e</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-180" id="section-180">&#182;</a>
</div>
<p>EVENT HANDLING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">on</span><span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">)</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">)</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span> <span class="o">||</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span> <span class="o">=</span> <span class="p">{});</span>
      <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">map</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]);</span>
      <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">off</span><span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">)</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">)</span>
      <span class="nx">emitter</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">f</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span> <span class="o">&amp;&amp;</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">signal</span><span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">type</span> <span class="cm">/*, values...*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span> <span class="o">&amp;&amp;</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">signalLater</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">,</span> <span class="nx">type</span> <span class="cm">/*, values...*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span> <span class="o">&amp;&amp;</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="nx">flist</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span> <span class="o">&amp;&amp;</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">curOp</span><span class="p">.</span><span class="nx">delayedCallbacks</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">bnd</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">);};};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">flist</span><span class="p">)</span> <span class="nx">flist</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">bnd</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
      <span class="k">else</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">hasHandler</span><span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span> <span class="o">&amp;&amp;</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">_handlers</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">arr</span> <span class="o">&amp;&amp;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="nx">on</span><span class="p">;</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">off</span> <span class="o">=</span> <span class="nx">off</span><span class="p">;</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">signal</span> <span class="o">=</span> <span class="nx">signal</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-181" id="section-181">&#182;</a>
</div>
<p>MISC UTILITIES</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-182" id="section-182">&#182;</a>
</div>
<p>Number of pixels added to scroller and sizer to hide scrollbar</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">scrollerCutOff</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-183" id="section-183">&#182;</a>
</div>
<p>Returned or thrown by various protocols to signal 'I'm not
handling this'.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">Pass</span> <span class="o">=</span> <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">Pass</span> <span class="o">=</span> <span class="p">{</span><span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="s2">&quot;CodeMirror.Pass&quot;</span><span class="p">;}};</span>

  <span class="kd">function</span> <span class="nx">Delayed</span><span class="p">()</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;}</span>
  <span class="nx">Delayed</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span><span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);}};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-184" id="section-184">&#182;</a>
</div>
<p>Counts the column offset in a string, taking tabs into account.
Used mostly to find indentation.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">countColumn</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">tabSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">end</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/[^\s\u00a0]/</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">end</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;\t&quot;</span><span class="p">)</span> <span class="nx">n</span> <span class="o">+=</span> <span class="nx">tabSize</span> <span class="o">-</span> <span class="p">(</span><span class="nx">n</span> <span class="o">%</span> <span class="nx">tabSize</span><span class="p">);</span>
      <span class="k">else</span> <span class="o">++</span><span class="nx">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">countColumn</span> <span class="o">=</span> <span class="nx">countColumn</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">spaceStrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">];</span>
  <span class="kd">function</span> <span class="nx">spaceStr</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">spaceStrs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">)</span>
      <span class="nx">spaceStrs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">lst</span><span class="p">(</span><span class="nx">spaceStrs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">spaceStrs</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lst</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">selectInput</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ios</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Mobile Safari apparently has a bug where select() is broken.</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">selectionStart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">selectionEnd</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nx">node</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">elt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">)</span> <span class="k">return</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">elt</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">collection</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">elt</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">emptyArray</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">size</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">);};</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">nonASCIISingleCaseWordChar</span> <span class="o">=</span> <span class="sr">/[\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc]/</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">isWordChar</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="sr">/\w/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="o">||</span> <span class="nx">ch</span> <span class="o">&gt;</span> <span class="s2">&quot;\x80&quot;</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="nx">ch</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">||</span> <span class="nx">nonASCIISingleCaseWordChar</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">ch</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isEmpty</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">n</span><span class="p">])</span> <span class="o">++</span><span class="nx">c</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">c</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">isExtendingChar</span> <span class="o">=</span> <span class="sr">/[\u0300-\u036F\u0483-\u0487\u0488-\u0489\u0591-\u05BD\u05BF\u05C1-\u05C2\u05C4-\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7-\u06E8\u06EA-\u06ED\uA66F\uA670-\uA672\uA674-\uA67D\uA69F]/</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-185" id="section-185">&#182;</a>
</div>
<p>DOM UTILITIES</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">elt</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">className</span><span class="p">,</span> <span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">tag</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">className</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="nx">style</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">content</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="nx">setTextContent</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">content</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">content</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">content</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">removeChildren</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">removeChildrenAndAdd</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">removeChildren</span><span class="p">(</span><span class="nx">parent</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">setTextContent</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ie_lt9</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">str</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nx">e</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-186" id="section-186">&#182;</a>
</div>
<p>FEATURE DETECTION</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-187" id="section-187">&#182;</a>
</div>
<p>Detect drag-and-drop</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">dragAndDrop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-188" id="section-188">&#182;</a>
</div>
<p>There is <em>some</em> kind of drag-and-drop support in IE6-8, but I
couldn't get it to work yet.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ie_lt9</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;draggable&quot;</span> <span class="k">in</span> <span class="nx">div</span> <span class="o">||</span> <span class="s2">&quot;dragDrop&quot;</span> <span class="k">in</span> <span class="nx">div</span><span class="p">;</span>
  <span class="p">}();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-189" id="section-189">&#182;</a>
</div>
<p>For a reason I have yet to figure out, some browsers disallow
word wrapping between certain characters <em>only</em> if a new inline
element is started between them. This makes it hard to reliably
measure the position of things, since that requires inserting an
extra span. This terribly fragile set of regexps matches the
character combinations that suffer from this phenomenon on the
various browsers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">spanAffectsWrapping</span> <span class="o">=</span> <span class="sr">/^$/</span><span class="p">;</span> <span class="c1">// Won&#39;t match any two-character string</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">gecko</span><span class="p">)</span> <span class="nx">spanAffectsWrapping</span> <span class="o">=</span> <span class="sr">/$&#39;/</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">safari</span><span class="p">)</span> <span class="nx">spanAffectsWrapping</span> <span class="o">=</span> <span class="sr">/\-[^ \-?]|\?[^ !&#39;\&quot;\),.\-\/:;\?\]\}]/</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">chrome</span><span class="p">)</span> <span class="nx">spanAffectsWrapping</span> <span class="o">=</span> <span class="sr">/\-[^ \-\.?]|\?[^ \-\.?\]\}:;!&#39;\&quot;\),\/]|[\.!\&quot;#&amp;%\)*+,:;=&gt;\]|\}~][\(\{\[&lt;]|\$&#39;/</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">knownScrollbarWidth</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">scrollbarWidth</span><span class="p">(</span><span class="nx">measure</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">knownScrollbarWidth</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">knownScrollbarWidth</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;width: 50px; height: 50px; overflow-x: scroll&quot;</span><span class="p">);</span>
    <span class="nx">removeChildrenAndAdd</span><span class="p">(</span><span class="nx">measure</span><span class="p">,</span> <span class="nx">test</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span>
      <span class="nx">knownScrollbarWidth</span> <span class="o">=</span> <span class="nx">test</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">-</span> <span class="nx">test</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">knownScrollbarWidth</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">zwspSupported</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">zeroWidthElement</span><span class="p">(</span><span class="nx">measure</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">zwspSupported</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="s2">&quot;\u200b&quot;</span><span class="p">);</span>
      <span class="nx">removeChildrenAndAdd</span><span class="p">(</span><span class="nx">measure</span><span class="p">,</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">test</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)]));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">measure</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">zwspSupported</span> <span class="o">=</span> <span class="nx">test</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">test</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">ie_lt8</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">zwspSupported</span><span class="p">)</span> <span class="k">return</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="s2">&quot;\u200b&quot;</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">return</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="s2">&quot;\u00a0&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;display: inline-block; width: 1px; margin-right: -1px&quot;</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-190" id="section-190">&#182;</a>
</div>
<p>See if "".split is the broken IE version, if so, provide an
alternative way to split lines.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">splitLines</span> <span class="o">=</span> <span class="s2">&quot;\n\nb&quot;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">).</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;=</span> <span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nl</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">nl</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">nl</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">nl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;\r&quot;</span> <span class="o">?</span> <span class="nx">nl</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">nl</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">rt</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;\r&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rt</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">rt</span><span class="p">));</span>
        <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">rt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
        <span class="nx">pos</span> <span class="o">=</span> <span class="nx">nl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">){</span><span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\r\n?|\n/</span><span class="p">);};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">splitLines</span> <span class="o">=</span> <span class="nx">splitLines</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">hasSelection</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">te</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">te</span><span class="p">.</span><span class="nx">selectionStart</span> <span class="o">!=</span> <span class="nx">te</span><span class="p">.</span><span class="nx">selectionEnd</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">te</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">te</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">createRange</span><span class="p">();}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">range</span> <span class="o">||</span> <span class="nx">range</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">te</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">range</span><span class="p">.</span><span class="nx">compareEndPoints</span><span class="p">(</span><span class="s2">&quot;StartToEnd&quot;</span><span class="p">,</span> <span class="nx">range</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">hasCopyEvent</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">elt</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;oncopy&quot;</span> <span class="k">in</span> <span class="nx">e</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;oncopy&quot;</span><span class="p">,</span> <span class="s2">&quot;return;&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">e</span><span class="p">.</span><span class="nx">oncopy</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">;</span>
  <span class="p">})();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-191" id="section-191">&#182;</a>
</div>
<p>KEY NAMING</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">var</span> <span class="nx">keyNames</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="o">:</span> <span class="s2">&quot;Enter&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="o">:</span> <span class="s2">&quot;Backspace&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="o">:</span> <span class="s2">&quot;Tab&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="o">:</span> <span class="s2">&quot;Enter&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="o">:</span> <span class="s2">&quot;Shift&quot;</span><span class="p">,</span> <span class="mi">17</span><span class="o">:</span> <span class="s2">&quot;Ctrl&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="o">:</span> <span class="s2">&quot;Alt&quot;</span><span class="p">,</span>
                  <span class="mi">19</span><span class="o">:</span> <span class="s2">&quot;Pause&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="o">:</span> <span class="s2">&quot;CapsLock&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="o">:</span> <span class="s2">&quot;Esc&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="o">:</span> <span class="s2">&quot;Space&quot;</span><span class="p">,</span> <span class="mi">33</span><span class="o">:</span> <span class="s2">&quot;PageUp&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="o">:</span> <span class="s2">&quot;PageDown&quot;</span><span class="p">,</span> <span class="mi">35</span><span class="o">:</span> <span class="s2">&quot;End&quot;</span><span class="p">,</span>
                  <span class="mi">36</span><span class="o">:</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="mi">37</span><span class="o">:</span> <span class="s2">&quot;Left&quot;</span><span class="p">,</span> <span class="mi">38</span><span class="o">:</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="mi">39</span><span class="o">:</span> <span class="s2">&quot;Right&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="o">:</span> <span class="s2">&quot;Down&quot;</span><span class="p">,</span> <span class="mi">44</span><span class="o">:</span> <span class="s2">&quot;PrintScrn&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="o">:</span> <span class="s2">&quot;Insert&quot;</span><span class="p">,</span>
                  <span class="mi">46</span><span class="o">:</span> <span class="s2">&quot;Delete&quot;</span><span class="p">,</span> <span class="mi">59</span><span class="o">:</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">91</span><span class="o">:</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="mi">92</span><span class="o">:</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="mi">93</span><span class="o">:</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="mi">109</span><span class="o">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">107</span><span class="o">:</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">127</span><span class="o">:</span> <span class="s2">&quot;Delete&quot;</span><span class="p">,</span>
                  <span class="mi">186</span><span class="o">:</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">187</span><span class="o">:</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">188</span><span class="o">:</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="mi">189</span><span class="o">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">190</span><span class="o">:</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">191</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">192</span><span class="o">:</span> <span class="s2">&quot;`&quot;</span><span class="p">,</span> <span class="mi">219</span><span class="o">:</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="mi">220</span><span class="o">:</span> <span class="s2">&quot;\\&quot;</span><span class="p">,</span>
                  <span class="mi">221</span><span class="o">:</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="mi">222</span><span class="o">:</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="mi">63276</span><span class="o">:</span> <span class="s2">&quot;PageUp&quot;</span><span class="p">,</span> <span class="mi">63277</span><span class="o">:</span> <span class="s2">&quot;PageDown&quot;</span><span class="p">,</span> <span class="mi">63275</span><span class="o">:</span> <span class="s2">&quot;End&quot;</span><span class="p">,</span> <span class="mi">63273</span><span class="o">:</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>
                  <span class="mi">63234</span><span class="o">:</span> <span class="s2">&quot;Left&quot;</span><span class="p">,</span> <span class="mi">63232</span><span class="o">:</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="mi">63235</span><span class="o">:</span> <span class="s2">&quot;Right&quot;</span><span class="p">,</span> <span class="mi">63233</span><span class="o">:</span> <span class="s2">&quot;Down&quot;</span><span class="p">,</span> <span class="mi">63302</span><span class="o">:</span> <span class="s2">&quot;Insert&quot;</span><span class="p">,</span> <span class="mi">63272</span><span class="o">:</span> <span class="s2">&quot;Delete&quot;</span><span class="p">};</span>
  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">keyNames</span> <span class="o">=</span> <span class="nx">keyNames</span><span class="p">;</span>
  <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-192" id="section-192">&#182;</a>
</div>
<p>Number keys</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-193" id="section-193">&#182;</a>
</div>
<p>Alphabetic keys</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-194" id="section-194">&#182;</a>
</div>
<p>Function keys</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">111</span><span class="p">]</span> <span class="o">=</span> <span class="nx">keyNames</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">63235</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
  <span class="p">})();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-195" id="section-195">&#182;</a>
</div>
<p>BIDI HELPERS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">iterateBidiSections</span><span class="p">(</span><span class="nx">order</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">order</span><span class="p">)</span> <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="s2">&quot;ltr&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">part</span> <span class="o">=</span> <span class="nx">order</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">to</span> <span class="o">&amp;&amp;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">from</span><span class="p">)</span>
        <span class="nx">f</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">from</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">to</span><span class="p">),</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s2">&quot;rtl&quot;</span> <span class="o">:</span> <span class="s2">&quot;ltr&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">bidiLeft</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span> <span class="o">:</span> <span class="nx">part</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">bidiRight</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">part</span><span class="p">.</span><span class="nx">from</span> <span class="o">:</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lineLeft</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span> <span class="k">return</span> <span class="nx">order</span> <span class="o">?</span> <span class="nx">bidiLeft</span><span class="p">(</span><span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">lineRight</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">order</span><span class="p">)</span> <span class="k">return</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">bidiRight</span><span class="p">(</span><span class="nx">lst</span><span class="p">(</span><span class="nx">order</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">lineStart</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineN</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">lineN</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">visual</span> <span class="o">=</span> <span class="nx">visualLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">visual</span> <span class="o">!=</span> <span class="nx">line</span><span class="p">)</span> <span class="nx">lineN</span> <span class="o">=</span> <span class="nx">lineNo</span><span class="p">(</span><span class="nx">visual</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">visual</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="o">!</span><span class="nx">order</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">lineRight</span><span class="p">(</span><span class="nx">visual</span><span class="p">)</span> <span class="o">:</span> <span class="nx">lineLeft</span><span class="p">(</span><span class="nx">visual</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineN</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">};</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">lineEnd</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">merged</span><span class="p">,</span> <span class="nx">line</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">merged</span> <span class="o">=</span> <span class="nx">collapsedSpanAtEnd</span><span class="p">(</span><span class="nx">line</span> <span class="o">=</span> <span class="nx">getLine</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">lineNo</span><span class="p">)))</span>
      <span class="nx">lineNo</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">to</span><span class="p">.</span><span class="nx">line</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ch</span> <span class="o">=</span> <span class="o">!</span><span class="nx">order</span> <span class="o">?</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">lineLeft</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="o">:</span> <span class="nx">lineRight</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">line</span><span class="o">:</span> <span class="nx">lineNo</span><span class="p">,</span> <span class="nx">ch</span><span class="o">:</span> <span class="nx">ch</span><span class="p">};</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-196" id="section-196">&#182;</a>
</div>
<p>This is somewhat involved. It is needed in order to move
'visually' through bi-directional text -- i.e., pressing left
should make the cursor go left, even when in RTL text. The
tricky part is the 'jumps', where RTL and LTR text touch each
other. This often requires the cursor offset to move more than
one unit, in order to visually move one unit.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">moveVisually</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">byUnit</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bidi</span> <span class="o">=</span> <span class="nx">getOrder</span><span class="p">(</span><span class="nx">line</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bidi</span><span class="p">)</span> <span class="k">return</span> <span class="nx">moveLogically</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">byUnit</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">moveOneUnit</span> <span class="o">=</span> <span class="nx">byUnit</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">do</span> <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">dir</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">isExtendingChar</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">pos</span><span class="p">)));</span>
      <span class="k">return</span> <span class="nx">pos</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">pos</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">;</span> <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">linedir</span> <span class="o">=</span> <span class="nx">bidi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">level</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bidi</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">part</span> <span class="o">=</span> <span class="nx">bidi</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sticky</span> <span class="o">=</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="nx">linedir</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">part</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;</span> <span class="nx">start</span> <span class="o">&amp;&amp;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span> <span class="o">&gt;</span> <span class="nx">start</span><span class="p">)</span> <span class="o">||</span>
          <span class="p">(</span><span class="nx">sticky</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">from</span> <span class="o">==</span> <span class="nx">start</span> <span class="o">||</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span> <span class="o">==</span> <span class="nx">start</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">moveOneUnit</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="o">-</span><span class="nx">dir</span> <span class="o">:</span> <span class="nx">dir</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="nx">linedir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">&lt;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">from</span> <span class="o">||</span> <span class="nx">target</span> <span class="o">&gt;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">part</span> <span class="o">=</span> <span class="nx">bidi</span><span class="p">[</span><span class="nx">i</span> <span class="o">+=</span> <span class="nx">dir</span><span class="p">];</span>
          <span class="nx">target</span> <span class="o">=</span> <span class="nx">part</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">dir</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">==</span> <span class="nx">part</span><span class="p">.</span><span class="nx">level</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">moveOneUnit</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="nx">moveOneUnit</span><span class="p">(</span><span class="nx">part</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">==</span> <span class="nx">bidiLeft</span><span class="p">(</span><span class="nx">part</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">part</span> <span class="o">=</span> <span class="nx">bidi</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">target</span> <span class="o">=</span> <span class="nx">part</span> <span class="o">&amp;&amp;</span> <span class="nx">bidiRight</span><span class="p">(</span><span class="nx">part</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">target</span> <span class="o">==</span> <span class="nx">bidiRight</span><span class="p">(</span><span class="nx">part</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">part</span> <span class="o">=</span> <span class="nx">bidi</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">target</span> <span class="o">=</span> <span class="nx">part</span> <span class="o">&amp;&amp;</span> <span class="nx">bidiLeft</span><span class="p">(</span><span class="nx">part</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">target</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">target</span> <span class="o">&gt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">target</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">moveLogically</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">byUnit</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">byUnit</span><span class="p">)</span> <span class="k">while</span> <span class="p">(</span><span class="nx">target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">isExtendingChar</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">target</span><span class="p">)))</span> <span class="nx">target</span> <span class="o">+=</span> <span class="nx">dir</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">target</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">target</span> <span class="o">&gt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">target</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-197" id="section-197">&#182;</a>
</div>
<p>Bidirectional ordering algorithm
See <a href='http://unicode.org/reports/tr9/tr9-13.html'>http://unicode.org/reports/tr9/tr9-13.html</a> for the algorithm
that this (partially) implements.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-198" id="section-198">&#182;</a>
</div>
<p>One-char codes used for character types:
L (L):   Left-to-Right
R (R):   Right-to-Left
r (AL):  Right-to-Left Arabic
1 (EN):  European Number
+ (ES):  European Number Separator
% (ET):  European Number Terminator
n (AN):  Arabic Number
, (CS):  Common Number Separator
m (NSM): Non-Spacing Mark
b (BN):  Boundary Neutral
s (B):   Paragraph Separator
t (S):   Segment Separator
w (WS):  Whitespace
N (ON):  Other Neutrals</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-199" id="section-199">&#182;</a>
</div>
<p>Returns null if characters are ordered as they appear
(left-to-right), or an array of sections ({from, to, level}
objects) in the order in which they occur visually.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">bidiOrdering</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-200" id="section-200">&#182;</a>
</div>
<p>Character types for codepoints 0 to 0xff</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">lowTypes</span> <span class="o">=</span> <span class="s2">&quot;bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLL&quot;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-201" id="section-201">&#182;</a>
</div>
<p>Character types for codepoints 0x600 to 0x6ff</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">arabicTypes</span> <span class="o">=</span> <span class="s2">&quot;rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmmrrrrrrrrrrrrrrrrrr&quot;</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">charType</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="k">return</span> <span class="nx">lowTypes</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x590</span> <span class="o">&lt;=</span> <span class="nx">code</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span> <span class="o">&lt;=</span> <span class="mh">0x5f4</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;R&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x600</span> <span class="o">&lt;=</span> <span class="nx">code</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span> <span class="o">&lt;=</span> <span class="mh">0x6ff</span><span class="p">)</span> <span class="k">return</span> <span class="nx">arabicTypes</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">code</span> <span class="o">-</span> <span class="mh">0x600</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x700</span> <span class="o">&lt;=</span> <span class="nx">code</span> <span class="o">&amp;&amp;</span> <span class="nx">code</span> <span class="o">&lt;=</span> <span class="mh">0x8ac</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;r&quot;</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">return</span> <span class="s2">&quot;L&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">bidiRE</span> <span class="o">=</span> <span class="sr">/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">isNeutral</span> <span class="o">=</span> <span class="sr">/[stwN]/</span><span class="p">,</span> <span class="nx">isStrong</span> <span class="o">=</span> <span class="sr">/[LRr]/</span><span class="p">,</span> <span class="nx">countsAsLeft</span> <span class="o">=</span> <span class="sr">/[Lb1n]/</span><span class="p">,</span> <span class="nx">countsAsNum</span> <span class="o">=</span> <span class="sr">/[1n]/</span><span class="p">;</span>

    <span class="k">return</span> <span class="kd">function</span> <span class="nx">charOrdering</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bidiRE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">str</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">types</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">startType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">type</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">types</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">charType</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">startType</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span> <span class="nx">startType</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="nx">startType</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">startType</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">startType</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-202" id="section-202">&#182;</a>
</div>
<p>W1. Examine each non-spacing mark (NSM) in the level run, and
change the type of the NSM to the type of the previous
character. If the NSM is at the start of the level run, it will
get the type of sor.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">startType</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prev</span><span class="p">;</span>
        <span class="k">else</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-203" id="section-203">&#182;</a>
</div>
<p>W2. Search backwards from each instance of a European number
until the first strong type (R, L, AL, or sor) is found. If an
AL is found, change the type of the European number to Arabic
number.
W3. Change all ALs to R.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">startType</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">cur</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;n&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isStrong</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-204" id="section-204">&#182;</a>
</div>
<p>W4. A single European separator between two European numbers
changes to a European number. A single common separator between
two numbers of the same type changes to that type.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">types</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">prev</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">prev</span> <span class="o">==</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
                 <span class="p">(</span><span class="nx">prev</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">||</span> <span class="nx">prev</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">))</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prev</span><span class="p">;</span>
        <span class="nx">prev</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-205" id="section-205">&#182;</a>
</div>
<p>W5. A sequence of European terminators adjacent to European
numbers changes to all European numbers.
W6. Otherwise, separators and terminators change to Other
Neutral.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;%&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="o">&amp;&amp;</span> <span class="nx">types</span><span class="p">[</span><span class="nx">end</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;%&quot;</span><span class="p">;</span> <span class="o">++</span><span class="nx">end</span><span class="p">)</span> <span class="p">{}</span>
          <span class="kd">var</span> <span class="nx">replace</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">types</span><span class="p">[</span><span class="nx">end</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;1&quot;</span> <span class="o">:</span> <span class="s2">&quot;N&quot;</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">end</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">types</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">;</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-206" id="section-206">&#182;</a>
</div>
<p>W7. Search backwards from each instance of a European number
until the first strong type (R, L, or sor) is found. If an L is
found, then change the type of the European number to L.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">startType</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isStrong</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-207" id="section-207">&#182;</a>
</div>
<p>N1. A sequence of neutrals takes the direction of the
surrounding strong text if the text on both sides has the same
direction. European and Arabic numbers act as if they were R in
terms of their influence on neutrals. Start-of-level-run (sor)
and end-of-level-run (eor) are used at level run boundaries.
N2. Any remaining neutrals take the embedding direction.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isNeutral</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="o">&amp;&amp;</span> <span class="nx">isNeutral</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">types</span><span class="p">[</span><span class="nx">end</span><span class="p">]);</span> <span class="o">++</span><span class="nx">end</span><span class="p">)</span> <span class="p">{}</span>
          <span class="kd">var</span> <span class="nx">before</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">?</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">startType</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">after</span> <span class="o">=</span> <span class="p">(</span><span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">types</span><span class="p">[</span><span class="nx">end</span><span class="p">]</span> <span class="o">:</span> <span class="nx">startType</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">replace</span> <span class="o">=</span> <span class="nx">before</span> <span class="o">||</span> <span class="nx">after</span> <span class="o">?</span> <span class="s2">&quot;L&quot;</span> <span class="o">:</span> <span class="s2">&quot;R&quot;</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">end</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">types</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">replace</span><span class="p">;</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-208" id="section-208">&#182;</a>
</div>
<p>Here we depart from the documented algorithm, in order to avoid
building up an actual levels array. Since there are only three
levels (0, 1, 2) in an implementation that doesn't take
explicit embedding into account, we can build up the order on
the fly, without following the level-based algorithm.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">m</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">countsAsLeft</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="o">&amp;&amp;</span> <span class="nx">countsAsLeft</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{}</span>
          <span class="nx">order</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="mi">0</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">at</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="o">&amp;&amp;</span> <span class="nx">types</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;L&quot;</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{}</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">i</span><span class="p">;)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">countsAsNum</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">types</span><span class="p">[</span><span class="nx">j</span><span class="p">]))</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">)</span> <span class="nx">order</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="mi">1</span><span class="p">});</span>
              <span class="kd">var</span> <span class="nx">nstart</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
              <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="nx">countsAsNum</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">types</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{}</span>
              <span class="nx">order</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">nstart</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="mi">2</span><span class="p">});</span>
              <span class="nx">pos</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="o">++</span><span class="nx">j</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">i</span><span class="p">)</span> <span class="nx">order</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">at</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="mi">1</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">level</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">)))</span> <span class="p">{</span>
        <span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">unshift</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="mi">0</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lst</span><span class="p">(</span><span class="nx">order</span><span class="p">).</span><span class="nx">level</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\s+$/</span><span class="p">)))</span> <span class="p">{</span>
        <span class="nx">lst</span><span class="p">(</span><span class="nx">order</span><span class="p">).</span><span class="nx">to</span> <span class="o">-=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">len</span> <span class="o">-</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="mi">0</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">level</span> <span class="o">!=</span> <span class="nx">lst</span><span class="p">(</span><span class="nx">order</span><span class="p">).</span><span class="nx">level</span><span class="p">)</span>
        <span class="nx">order</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">level</span><span class="o">:</span> <span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">level</span><span class="p">});</span>

      <span class="k">return</span> <span class="nx">order</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">})();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-209" id="section-209">&#182;</a>
</div>
<p>THE END</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nx">CodeMirror</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="s2">&quot;3.0&quot;</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">CodeMirror</span><span class="p">;</span>
<span class="p">})();</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
